<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>BCTI - Advanced Exam Maker (Smart Counter & Option Control)</title>
    
    <!-- MathJax for LaTeX equations -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Cropper.js for image cropping -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    
    <!-- Google Fonts for Bengali -->
    <link href="https://fonts.googleapis.com/css2?family=Kalpurush&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=SolaimanLipi&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=SiyamRupali&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #1a237e; --bg: #f4f7f6; }
        body { font-family: 'Kalpurush', 'Siyam Rupali', Arial, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* ‡¶´‡¶®‡ßç‡¶ü ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡¶∏‡¶Æ‡ßÇ‡¶π */
        .font-kalpurush {
            font-family: 'Kalpurush', 'Siyam Rupali', Arial, sans-serif !important;
        }
        
        .font-solaimanlipi {
            font-family: 'SolaimanLipi', 'Siyam Rupali', Arial, sans-serif !important;
        }
        
        .font-siyamrupali {
            font-family: 'Siyam Rupali', Arial, sans-serif !important;
        }
        
        .font-notosans {
            font-family: 'Noto Sans Bengali', 'Kalpurush', Arial, sans-serif !important;
        }
        
        .font-roboto {
            font-family: 'Roboto', 'SolaimanLipi', Arial, sans-serif !important;
        }
        
        .font-times {
            font-family: 'Times New Roman', Times, serif !important;
        }
        
        .font-arial {
            font-family: Arial, sans-serif !important;
        }
        
        .font-custom {
            /* Will be set dynamically */
        }
        
        .sidebar { width: 450px; background: #fff; border-right: 2px solid #ddd; display: flex; flex-direction: column; }
        .tab-btn-group { display: flex; background: #eee; }
        .tab-btn { flex: 1; padding: 12px; border: none; cursor: pointer; font-weight: bold; background: #eee; font-size: 13px; }
        .tab-btn.active { background: #fff; border-bottom: 2px solid var(--primary); color: var(--primary); }
        .panel { padding: 15px; flex: 1; overflow-y: auto; display: none; box-sizing: border-box; }
        .panel.active { display: block; }
        .admin-only { display: none; }
        .admin-active .admin-only { display: block; }
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 4px; font-size: 13px; }
        .input-group input, textarea, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .preview-area { 
            flex: 1; 
            background: #ffffff !important;
            display: flex; 
            justify-content: center; 
            padding: 20px; 
            overflow-y: auto; 
        }
        .exam-paper { 
            width: 210mm; 
            min-height: 297mm; 
            background: white; 
            box-sizing: border-box; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative; 
        }
        
        .header { text-align: center; margin-bottom: 5px; padding-bottom: 5px; }
        .header h1 { margin: 0; font-weight: bold; line-height: 1.3; font-size: 20px; }
        .header h2 { margin: 0; font-weight: bold; line-height: 1.3; font-size: 16px; }
        
        .header-info { margin: 0; font-weight: bold; text-align: center; display: block; line-height: 1.3; font-size: 12px; }
        #outSubjectLine { padding-bottom: 4px; margin-bottom: 8px; text-align: center; }

        .smart-counter-dashboard { background: var(--primary); color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .counter-stats { display: flex; justify-content: space-around; align-items: center; text-align: center; }
        .stat-item h4 { margin: 0; font-size: 10px; text-transform: uppercase; opacity: 0.8; }
        .stat-item .val { font-size: 24px; font-weight: bold; display: block; }
        .stat-item input { width: 50px; background: rgba(255,255,255,0.2); border: 1px solid white; color: white; text-align: center; border-radius: 4px; font-size: 18px; font-weight: bold; }
        .progress-line { width: 100%; background: rgba(255,255,255,0.1); height: 6px; border-radius: 10px; margin-top: 10px; overflow: hidden; }
        #fillBar { width: 0%; height: 100%; background: #4caf50; transition: 0.4s; }

        .restriction-box { background: #e8f5e9; border: 1px solid #c8e6c9; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        .restriction-box h4 { margin: 0 0 5px 0; color: #2e7d32; font-size: 14px; }
        .restriction-box input { border: 1px solid #a5d6a7 !important; background: #fff !important; }

        #outSetLine { position: absolute; top: 15px; right: 15px; border: 2px solid #000; padding: 3px 10px; font-weight: bold; font-size: 16px; display: none; }
        .marks-info { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 4px; border-bottom: 1px solid #ddd; padding-bottom: 2px; font-size: 12px; }
        .instruction { text-align: center; font-style: italic; font-weight: bold; margin-bottom: 10px; text-decoration: underline; font-size: 11px; }
        .question-container { column-gap: 35px; margin-top: 15px; column-rule: 1px solid #000; }
        .cq-box, .normal-q { break-inside: avoid; margin-bottom: 12px; display: block; }
        .sub-q { display: flex; justify-content: space-between; margin-bottom: 3px; }
        .mcq-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 4px; padding-left: 18px; }
        #ansSheetArea { margin-top: 25px; border-top: 2px dashed #333; padding-top: 15px; break-before: page; }
        .ans-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .ans-box { border: 1px solid #ccc; padding: 5px; border-radius: 3px; }
        .btn-action { border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; }
        .btn-mini { padding: 4px 10px; border: none; border-radius: 3px; color: white; cursor: pointer; font-size: 11px; margin-right: 5px; }
        .lock-status { padding: 10px; background: #1a237e; color: white; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        
        .q-card { 
            transition: 0.2s; 
            border: 1px solid #eee; 
            margin-bottom: 8px; 
            border-radius: 8px; 
            cursor: pointer; 
            background: #fff; 
            padding: 10px; 
            width: 100%; 
            box-sizing: border-box; 
            overflow-wrap: break-word;
            text-align: left !important;
            position: relative;
        }
        .q-card:hover { background: #f9f9f9 !important; }
        .q-card-body { 
            white-space: pre-wrap; 
            color: #333; 
            margin: 8px 0; 
            line-height: 1.4; 
            word-break: break-word;
            text-align: left !important;
        }
        
        .q-card-options { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 4px; 
            color: #555; 
            background: #f1f8e9; 
            padding: 6px; 
            border-radius: 4px; 
            margin-top: 5px; 
            border: 1px solid #dcedc8; 
            box-sizing: border-box;
            text-align: left !important;
        }
        .q-card-options div { 
            word-break: break-all;
            text-align: left !important;
        }

        .board-tag { color: #d32f2f; font-weight: bold; font-size: 11px; margin-left: 5px; }
        .magic-tools { background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 10px; border: 1px solid #bbdefb; }
        #cropperModal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: #fff; width: 90%; max-width: 600px; margin: 50px auto; padding: 20px; border-radius: 8px; text-align: center; }
        #cropImageWrap { max-height: 400px; margin-bottom: 20px; overflow: hidden; }
        #cropImageWrap img { max-width: 100%; }
        
        /* ================== PAGINATION STYLES ================== */
        .selection-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .selection-pagination button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            min-width: 80px;
        }
        .selection-pagination button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .selection-page-info {
            font-weight: bold;
            color: var(--primary);
            font-size: 14px;
        }
        
        .output-pagination {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            border: 2px solid var(--primary);
        }
        .page-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            min-width: 80px;
        }
        .page-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .page-info {
            font-weight: bold;
            color: var(--primary);
            font-size: 16px;
            min-width: 120px;
            text-align: center;
        }
        .page-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f0f0f0;
            padding: 5px 15px;
            border-radius: 20px;
        }
        .page-input-group input {
            width: 50px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px;
        }
        
        .output-page {
            display: none;
            width: 100%;
            min-height: 297mm;
            box-sizing: border-box;
            position: relative;
            page-break-after: always;
            background: white !important;
        }
        .output-page.active {
            display: block;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 2px solid #000;
            padding-bottom: 8px;
        }
        
        .page-number {
            position: absolute;
            bottom: 10px;
            right: 20px;
            font-size: 11px;
            color: #666;
        }
        
        .pagination-settings {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .auto-page-indicator {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 10px;
        }
        
        /* Smart auto-pagination indicator */
        .page-status-indicator {
            background: #1976d2;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
            font-weight: bold;
        }
        /* ================== END PAGINATION STYLES ================== */
        
        /* Slider Styles */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        
        .slider-container input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .slider-container input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            color: var(--primary);
            font-size: 13px;
        }
        
        /* Active slider highlight */
        input[type="range"]:active {
            background: #d0d0d0;
        }
        
        input[type="range"]:active::-webkit-slider-thumb {
            background: #0d1b6b;
            transform: scale(1.1);
        }
        
        /* Slider labels */
        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
            margin-top: 3px;
        }
        
        /* Second page header styles */
        .second-page-header {
            display: none;
        }
        
        /* ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .chapter-header {
            background: #e8eaf6;
            color: var(--primary);
            padding: 8px 12px;
            border-radius: 6px;
            margin: 15px 0 10px 0;
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left !important;
        }

        .chapter-header strong {
            font-size: 14px;
            display: block;
        }

        .chapter-header small {
            font-size: 11px;
            color: #666;
        }

        /* ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶¨‡ßÉ‡¶§‡ßç‡¶§ */
        .chapter-serial-circle {
            background: var(--primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 13px;
            flex-shrink: 0;
        }
        
        /* MathJax Equation Styling */
        .MathJax_Display {
            text-align: left !important;
            margin: 10px 0 !important;
            padding: 5px 0 !important;
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            display: block !important;
        }
        
        .mjx-chtml {
            white-space: normal !important;
            word-wrap: break-word !important;
            display: inline-block !important;
        }
        
        .math-equation {
            display: block;
            margin: 8px 0;
            padding: 5px;
            text-align: center;
        }
        
        .equation-container {
            display: block !important;
            margin: 10px 0 !important;
            text-align: center !important;
        }
        
        /* MCQ option styling for equations */
        .mcq-option-equation {
            display: block;
            margin: 5px 0;
            padding: 3px 0;
            text-align: left;
        }
        
        /* Second page margin indicator */
        .second-page-margin-indicator {
            display: inline-block;
            background: #7b1fa2;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 5px;
            font-weight: bold;
        }
        
        /* Temporary Editor Styles */
        .temp-edit-q-item:hover {
            background: #e8f5e9 !important;
            border-color: #4caf50 !important;
        }

        .temp-edit-q-item.active {
            background: #e3f2fd !important;
            border-color: var(--primary) !important;
        }

        #tempEditBtn {
            background: #ff9800 !important;
            color: white !important;
            border: none !important;
            padding: 12px !important;
            border-radius: 5px !important;
            cursor: pointer !important;
            font-weight: bold !important;
            width: 100% !important;
            margin-top: 10px !important;
        }
        
        /* Search Navigation Styles - FIXED */
        .search-navigation-active {
            border: 3px solid #4caf50 !important;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5) !important;
            position: relative;
            z-index: 5;
            animation: pulse-highlight 2s infinite;
        }
        
        /* Search result highlighting */
        .search-highlight {
            background-color: #fff9c4 !important;
            border: 2px solid #ffd54f !important;
        }

        .search-match {
            background-color: #ffeb3b;
            color: #000;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: bold;
        }

        @keyframes pulse-highlight {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }
        
        .search-result-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #4caf50;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            z-index: 10;
            font-weight: bold;
        }
        
        /* ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .search-nav-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .search-nav-buttons button {
            flex: 1;
            background: #2196f3;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .search-nav-buttons button:hover {
            background: #1976d2;
        }
        
        /* ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶á‡¶®‡¶´‡ßã ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá */
        .search-info-display {
            background: #e8f5e9;
            border: 1px solid #4caf50;
            border-radius: 4px;
            padding: 8px;
            margin-top: 8px;
            font-size: 12px;
            color: #2e7d32;
            text-align: center;
            display: none;
        }
        
        .search-info-display.active {
            display: block;
        }
        
        /* ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .monthly-exam-section {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .monthly-exam-section h3 {
            color: #e65100;
            margin-top: 0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .subject-group {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #ffcc80;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .subject-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ffcc80;
        }
        
        .subject-group-header h4 {
            margin: 0;
            color: #e65100;
        }
        
        .questions-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #fff9c4;
            border-radius: 5px;
        }
        
        .question-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ffe082;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .question-item:hover {
            background: #fff8e1;
            border-color: #ffb74d;
        }
        
        .question-item.selected {
            background: #e8f5e9;
            border-color: #4caf50;
        }
        
        .question-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .question-preview {
            flex: 1;
            font-size: 12px;
            color: #555;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .monthly-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .monthly-controls button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
        }
        
        .monthly-stats {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
            font-size: 13px;
            font-weight: bold;
            color: #2e7d32;
        }
        
        /* Subject separator in output */
        .subject-separator {
            background: #f5f5f5;
            padding: 6px 10px;
            margin: 15px 0 8px 0;
            border-left: 4px solid var(--primary);
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
            color: var(--primary);
            text-align: left;
            break-inside: avoid;
        }
        
        /* Font selection styles */
        .font-option-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .font-option {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            transition: all 0.3s;
            background: white;
        }
        
        .font-option:hover {
            border-color: var(--primary);
            background: #f0f4ff;
        }
        
        .font-option.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
            font-weight: bold;
        }
        
        .font-preview {
            font-size: 14px;
            margin-top: 5px;
            min-height: 40px;
            padding: 8px;
            border: 1px solid #eee;
            border-radius: 4px;
            background: #f9f9f9;
            text-align: center;
        }
        
        .custom-font-input {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .custom-font-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        @media print { 
            body {
                background: white !important;
            }
            .sidebar { display: none; } 
            .preview-area { 
                padding: 0; 
                background: white !important;
                overflow: visible; 
            } 
            .exam-paper { 
                box-shadow: none !important; 
                width: 100%; 
                border: none; 
                margin: 0;
                overflow: visible;
                background: white !important;
            } 
            @page { 
                size: A4; 
                margin: 6mm 6mm 6mm 6mm;
            } 
            .question-container { column-rule: 1px solid #000; column-gap: 30px; } 
            #ansSheetArea.hidden-print { display: none !important; } 
            #outSetLine { display: block !important; border: 2px solid #000 !important; } 
            .output-pagination { display: none !important; }
            .output-page { 
                display: block !important; 
                min-height: 0;
                height: auto;
                page-break-after: always;
                margin: 0;
                padding: 0;
                background: white !important;
            }
            .output-page:last-child { page-break-after: auto; }
            .page-number { display: block !important; }
            
            /* ‚úÖ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® */
            .output-page:first-child {
                padding: 12mm 15mm 12mm 15mm !important;
            }
            .output-page:not(:first-child) {
                padding: 10mm 15mm 12mm 15mm !important;
            }
            
            /* Prevent questions from breaking across pages */
            .cq-box, .normal-q {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            /* Prevent subject separator from breaking across pages */
            .subject-separator {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            /* Print optimization with PROPER header sizes */
            .header h1 { 
                font-size: 20px !important; 
                margin: 3px 0 !important;
                padding: 0 !important;
                font-weight: bold !important;
            }
            .header h2 { 
                font-size: 16px !important; 
                margin: 2px 0 !important;
                padding: 0 !important;
                font-weight: bold !important;
            }
            .header-info { 
                font-size: 12px !important; 
                margin: 1px 0 !important;
                line-height: 1.3 !important;
                font-weight: bold !important;
            }
            .marks-info { 
                font-size: 11px !important; 
                margin: 3px 0 !important;
                padding-bottom: 1px !important;
                font-weight: bold !important;
            }
            .instruction { 
                font-size: 11px !important; 
                margin: 3px 0 !important;
                font-weight: bold !important;
            }
            .cq-box, .normal-q { 
                margin-bottom: 8px !important; 
            }
            .sub-q { 
                font-size: 9px !important; 
                margin-bottom: 2px !important;
            }
            .mcq-grid { 
                font-size: 9px !important; 
                gap: 2px !important;
                margin-top: 2px !important;
            }
            
            /* ‚úÖ ‡ß®‡ßü ‡¶™‡¶æ‡¶§‡¶æ‡¶∞ ‡¶π‡ßá‡¶°‡¶æ‡¶∞‡¶ì ‡¶¶‡ßá‡¶ñ‡¶æ‡¶® (‡¶Ø‡¶¶‡¶ø ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶® ‡¶π‡ßü) */
            .output-page:not(:first-child) .header,
            .output-page:not(:first-child) .header-info,
            .output-page:not(:first-child) #outSubjectLine,
            .output-page:not(:first-child) .marks-info,
            .output-page:not(:first-child) .instruction {
                display: block !important;
                font-size: 10px !important;
            }
            
            /* ‡ß®‡ßü ‡¶™‡¶æ‡¶§‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶æ‡¶á‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
            .output-page:not(:first-child) #outSetLine {
                display: none !important;
            }
            
            /* Remove border from subject line in print mode */
            #outSubjectLine { 
                padding-bottom: 2px !important; 
                margin-bottom: 4px !important; 
                text-align: center; 
            }
            /* ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞‡ßá‡¶∞ ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶∏‡ßç‡¶™‡ßá‡¶∏ ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü‡ßá‡¶ì ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶® */
            .question-container {
                margin-top: 8px !important;
            }
            /* MathJax equations in print */
            .MathJax_Display {
                margin: 3px 0 !important;
                page-break-inside: avoid !important;
            }
        }
        
        /* Auto page break hint for print preview */
        .print-page-break {
            display: none;
            text-align: center;
            color: #f44336;
            font-weight: bold;
            padding: 3px;
            margin: 5px 0;
            border-top: 2px dashed #f44336;
            font-size: 11px;
        }
        
        .print-preview-mode .print-page-break {
            display: block;
        }
        
        /* Duplicate warning style */
        .duplicate-warning {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: left;
        }
        
        .duplicate-warning h4 {
            color: #e65100;
            margin-top: 0;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .duplicate-warning-content {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ffcc80;
            margin: 10px 0;
            font-size: 13px;
        }
        
        .duplicate-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .duplicate-buttons button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>

    <!-- MathJax Configuration for proper equation display -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                processRefs: true,
                packages: {'[+]': ['ams', 'mathtools']}
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {load: ['[tex]/ams', '[tex]/mathtools']},
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    MathJax.typesetPromise();
                }
            },
            svg: {
                fontCache: 'global',
                scale: 1,
                linebreaks: { automatic: true }
            },
            CommonHTML: {
                linebreaks: { automatic: true }
            }
        };
    </script>

</head>
<body onload="checkLicense()">

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<!-- Image Cropper Modal -->
<div id="cropperModal">
    <div class="modal-content">
        <h3>‡¶õ‡¶¨‡¶ø ‡¶ï‡ßç‡¶∞‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
        <div id="cropImageWrap"><img id="cropImage" src=""></div>
        <button class="btn-action" style="background:var(--primary); color:white; width:auto; padding:10px 30px;" onclick="finishCrop()">‡¶ï‡ßç‡¶∞‡¶™ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button class="btn-action" style="background:#777; color:white; width:auto; padding:10px 30px;" onclick="closeCropper()">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
    </div>
</div>

<!-- Duplicate Warning Modal -->
<div id="duplicateWarningModal" style="display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.7);">
    <div style="background:white; width:90%; max-width:500px; margin:50px auto; padding:20px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
        <div id="duplicateWarningContent"></div>
    </div>
</div>

<!-- Sidebar -->
<div class="sidebar" id="sidebarMain">
    <div class="lock-status">
        <span id="lockText">üîí ‡¶Æ‡ßã‡¶°: <b id="currentModeDisplay">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£</b></span>
        <label style="cursor: pointer;"><input type="checkbox" id="adminToggle" onchange="toggleAdmin()"> ‡¶è‡¶°‡¶Æ‡¶ø‡¶®</label>
    </div>

    <div class="tab-btn-group">
        <button class="tab-btn active" onclick="openTab('select')">‡¶¨‡¶æ‡¶õ‡¶æ‡¶á</button>
        <button class="tab-btn" onclick="openTab('bank')">‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï</button>
        <button class="tab-btn" onclick="openTab('monthly')">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</button>
        <button class="tab-btn" onclick="openTab('sets')">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
    </div>

    <!-- Selection Panel -->
    <div id="select" class="panel active">
        <div class="smart-counter-dashboard">
            <div class="counter-stats">
                <div class="stat-item"><h4>‡¶≤‡¶æ‡¶ó‡¶¨‡ßá</h4><input type="number" id="targetCount" value="10" oninput="updateCounter()"></div>
                <div style="width: 1px; height: 35px; background: rgba(255,255,255,0.2);"></div>
                <div class="stat-item"><h4>‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°</h4><span id="liveCount" class="val" style="color: #ffeb3b;">0</span></div>
            </div>
            <div class="progress-line"><div id="fillBar"></div></div>
            <div id="counterStatus" style="font-size: 11px; text-align: center; margin-top: 6px;">‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§</div>
        </div>

        <!-- ‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü/‡¶°‡¶ø‡¶∏‡ßá‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® -->
        <div style="margin-bottom: 15px; display: flex; gap: 5px;">
            <button onclick="selectAllQuestions()" style="flex:1; background:#1a237e; color:white; border:none; border-radius:4px; padding:10px; cursor:pointer; font-weight:bold;">‡¶∏‡¶¨ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button onclick="deselectAllQuestions()" style="flex:1; background:#d32f2f; color:white; border:none; border-radius:4px; padding:10px; cursor:pointer; font-weight:bold;">‡¶∏‡¶¨ ‡¶°‡¶ø‡¶∏‡ßá‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>

        <div class="magic-tools">
            <label style="font-size: 12px; font-weight: bold;">üé≤ ‡¶Ö‡¶ü‡ßã ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü‡¶∞</label>
            <div style="display: flex; gap: 5px; margin-top: 5px;">
                <input type="number" id="randomCount" placeholder="‡¶ï‡¶Ø‡¶º‡¶ü‡¶ø?" style="width: 70px; padding: 5px;">
                <button onclick="autoSelectRandom()" style="flex:1; background:#673ab7; color:white; border:none; border-radius:4px; cursor:pointer;">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¨‡¶æ‡¶õ‡¶æ‡¶á ‡¶ï‡¶∞‡ßã</button>
            </div>
            <button onclick="shuffleSelectedQuestions()" style="width:100%; margin-top:5px; background:#ff9800; color:white; border:none; border-radius:4px; padding:8px; cursor:pointer; font-weight:bold;">üîÄ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶â‡¶≤‡¶ü-‡¶™‡¶æ‡¶≤‡¶ü ‡¶ï‡¶∞‡ßã</button>
            
            <!-- ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶Ö‡¶ü‡ßã ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü‡¶∞ -->
            <div style="margin-top: 15px; padding: 10px; background: #f3e5f5; border-radius: 5px; border: 1px solid #ce93d8;">
                <label style="font-size: 12px; font-weight: bold; color: #7b1fa2;">üéØ ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶Ö‡¶ü‡ßã ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü‡¶∞</label>
                
                <div style="display: flex; gap: 5px; margin-top: 8px; align-items: center;">
                    <input type="number" id="advancedRandomCount" placeholder="‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ" 
                           style="width: 80px; padding: 6px; border: 1px solid #ba68c8; border-radius: 4px; text-align: center;"
                           min="1" max="100" value="5">
                    
                    <select id="autoTypeFilter" style="flex: 1; padding: 6px; border: 1px solid #ba68c8; border-radius: 4px;">
                        <option value="current">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞</option>
                        <option value="all">‡¶∏‡¶¨ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®</option>
                        <option value="mcq">‡¶∂‡ßÅ‡¶ß‡ßÅ MCQ</option>
                        <option value="cq">‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡ßÉ‡¶ú‡¶®‡¶∂‡ßÄ‡¶≤</option>
                        <option value="normal">‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 5px; margin-top: 8px;">
                    <button onclick="advancedAutoSelect()" 
                            style="flex: 1; background: #7b1fa2; color: white; border: none; border-radius: 4px; padding: 8px; cursor: pointer; font-weight: bold;">
                        üé≤ ‡¶Ö‡¶ü‡ßã ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü
                    </button>
                    
                    <button onclick="autoDeselectRandom()" 
                            style="flex: 1; background: #f44336; color: white; border: none; border-radius: 4px; padding: 8px; cursor: pointer; font-weight: bold;">
                        üóëÔ∏è ‡¶Ö‡¶ü‡ßã ‡¶°‡¶ø‡¶∏‡ßá‡¶≤‡ßá‡¶ï‡ßç‡¶ü
                    </button>
                </div>
                
                <div id="autoGenStatus" style="font-size: 11px; color: #666; margin-top: 5px; display: none;"></div>
            </div>
        </div>

        <div id="filterGroup" style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 10px; border:1px solid #ddd;">
            <!-- üîç ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶¨‡¶ï‡ßç‡¶∏ -->
            <div style="margin-bottom: 10px; position: relative;">
                <input type="text" id="searchBox" placeholder="üîç ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®/‡¶Ö‡¶™‡¶∂‡¶®/‡¶¨‡¶ø‡¶∑‡ßü/‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®..." 
                       style="width: 100%; padding: 10px 40px 10px 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 13px;"
                       oninput="performSearch()"
                       onkeypress="handleSearchKeyPress(event)">
                <button id="clearSearchBtn" onclick="clearSearch()" 
                        style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #f44336; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: none; font-size: 12px; line-height: 1;">‚úï</button>
            </div>
            
            <!-- ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶¨‡¶æ‡¶ü‡¶® -->
            <div id="searchNavButtons" class="search-nav-buttons" style="display: none;">
                <button onclick="navigateToSearchResult(currentSearchIndex - 1)">
                    ‚Üê ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞‡¶ü‡¶ø
                </button>
                <button onclick="navigateToSearchResult(currentSearchIndex + 1)">
                    ‡¶™‡¶∞‡ßá‡¶∞‡¶ü‡¶ø ‚Üí
                </button>
            </div>
            
            <!-- ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶á‡¶®‡¶´‡ßã -->
            <div id="searchInfoDisplay" class="search-info-display">
                <span id="searchResultCount">0</span>‡¶ü‡¶ø ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶õ‡ßá
            </div>
            
            <div class="admin-only restriction-box">
                <h4>üîí ‡¶∏‡¶æ‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶∞‡ßá‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ï‡¶∂‡¶®</h4>
                <input type="text" id="lockBox" placeholder="‡¶â‡¶¶‡¶æ: ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ, ‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø" oninput="saveData(); updateSubFilter()" class="input-group" style="margin-bottom:0;">
                <small style="font-size:10px; color:#666;">‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶ó‡ßÅ‡¶≤‡ßã ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</small>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 5px;">
                <select id="fClass" onchange="renderSelectionList()" style="padding:8px; border-radius:4px;">
                    <option value="">‡¶∏‡¶¨ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø</option>
                    <option value="HSC">HSC</option>
                    <option value="‡¶¶‡¶∂‡¶Æ">‡¶¶‡¶∂‡¶Æ</option>
                    <option value="‡¶®‡¶¨‡¶Æ">‡¶®‡¶¨‡¶Æ</option>
                    <option value="‡¶Ö‡¶∑‡ßç‡¶ü‡¶Æ">‡¶Ö‡¶∑‡ßç‡¶ü‡¶Æ</option>
                    <option value="‡¶∏‡¶™‡ßç‡¶§‡¶Æ">‡¶∏‡¶™‡ßç‡¶§‡¶Æ</option>
                    <option value="‡¶∑‡¶∑‡ßç‡¶†">‡¶∑‡¶∑‡ßç‡¶†</option>
                    <option value="‡¶™‡¶û‡ßç‡¶ö‡¶Æ">‡¶™‡¶û‡ßç‡¶ö‡¶Æ</option>
                    <option value="‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶•">‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶•</option>
                    <option value="‡¶§‡ßÉ‡¶§‡ßÄ‡ßü">‡¶§‡ßÉ‡¶§‡ßÄ‡ßü</option>
                    <option value="‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü">‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü</option>
                    <option value="‡¶™‡ßç‡¶∞‡¶•‡¶Æ">‡¶™‡ßç‡¶∞‡¶•‡¶Æ</option>
                </select>
                <select id="fDiv" onchange="renderSelectionList()" style="padding:8px; border-radius:4px;">
                    <option value="">‡¶∏‡¶¨ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó</option>
                    <option value="‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£</option>
                    <option value="‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®">‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®</option>
                    <option value="‡¶Æ‡¶æ‡¶®‡¶¨‡¶ø‡¶ï">‡¶Æ‡¶æ‡¶®‡¶¨‡¶ø‡¶ï</option>
                    <option value="‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ">‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ</option>
                </select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 5px;">
                <select id="fSub" onchange="updateChapterFilter(); renderSelectionList()" style="padding:8px; border-radius:4px;"></select>
                <select id="fChap" onchange="renderSelectionList()" style="padding:8px; border-radius:4px;">
                    <option value="">‡¶∏‡¶¨ ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º</option>
                </select>
            </div>
            
            <select id="fType" onchange="renderSelectionList()" style="width:100%; padding:8px; border-radius:4px;">
                <option value="">‡¶∏‡¶¨ ‡¶ß‡¶∞‡¶®</option>
                <option value="normal">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£</option>
                <option value="cq">‡¶∏‡ßÉ‡¶ú‡¶®‡¶∂‡ßÄ‡¶≤</option>
                <option value="mcq">MCQ</option>
            </select>
        </div>
        
        <!-- Selection Questions List with Pagination -->
        <div id="selectionList"></div>
        
        <!-- Selection Pagination Controls -->
        <div id="selectionPagination" class="selection-pagination" style="display: none;">
            <button onclick="changeSelectionPage(-1)" id="selectionPrevBtn">‚Üê ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞</button>
            <div class="selection-page-info" id="selectionPageInfo">‡¶™‡ßá‡¶ú 1/1</div>
            <button onclick="changeSelectionPage(1)" id="selectionNextBtn">‡¶™‡¶∞‡ßá‡¶∞ ‚Üí</button>
        </div>
        
        <!-- Temporary Edit Button -->
        <button id="tempEditBtn" class="btn-action" style="background:#ff9800; color:white; margin-top:10px;" onclick="openTemporaryEditor()">üñäÔ∏è ‡¶ü‡ßá‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡¶æ‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü</button>
        
        <button class="btn-action" style="background:#2e7d32; color:white; margin-top:15px;" onclick="window.print()">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü / PDF</button>
    </div>

    <!-- Bank Panel -->
    <div id="bank" class="panel">
        <div class="admin-only">
            <h3>‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ø‡ßã‡¶ó/‡¶è‡¶°‡¶ø‡¶ü</h3>
            <input type="hidden" id="editIndex" value="-1">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <select id="qClassInput" class="input-group" style="margin-bottom:0;">
                    <option value="">‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                    <option value="HSC">HSC</option>
                    <option value="‡¶¶‡¶∂‡¶Æ">‡¶¶‡¶∂‡¶Æ</option>
                    <option value="‡¶®‡¶¨‡¶Æ">‡¶®‡¶¨‡¶Æ</option>
                    <option value="‡¶Ö‡¶∑‡ßç‡¶ü‡¶Æ">‡¶Ö‡¶∑‡ßç‡¶ü‡¶Æ</option>
                    <option value="‡¶∏‡¶™‡ßç‡¶§‡¶Æ">‡¶∏‡¶™‡ßç‡¶§‡¶Æ</option>
                    <option value="‡¶∑‡¶∑‡ßç‡¶†">‡¶∑‡¶∑‡ßç‡¶†</option>
                    <option value="‡¶™‡¶û‡ßç‡¶ö‡¶Æ">‡¶™‡¶û‡ßç‡¶ö‡¶Æ</option>
                    <option value="‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶•">‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶•</option>
                    <option value="‡¶§‡ßÉ‡¶§‡ßÄ‡ßü">‡¶§‡ßÉ‡¶§‡ßÄ‡ßü</option>
                    <option value="‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü">‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü</option>
                    <option value="‡¶™‡ßç‡¶∞‡¶•‡¶Æ">‡¶™‡ßç‡¶∞‡¶•‡¶Æ</option>
                </select>
                <select id="qDivInput" class="input-group" style="margin-bottom:0;">
                    <option value="">‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                    <option value="‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£</option>
                    <option value="‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®">‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®</option>
                    <option value="‡¶Æ‡¶æ‡¶®‡¶¨‡¶ø‡¶ï">‡¶Æ‡¶æ‡¶®‡¶¨‡¶ø‡¶ï</option>
                    <option value="‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ">‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ</option>
                </select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="text" id="qSub" placeholder="‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º" class="input-group" oninput="checkDuplicateWhileTyping()">
                <input type="text" id="qChap" placeholder="‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º" class="input-group" oninput="checkDuplicateWhileTyping()">
            </div>
            <select id="qType" onchange="toggleFields(); checkDuplicateWhileTyping()" class="input-group">
                <option value="normal">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£</option>
                <option value="cq">‡¶∏‡ßÉ‡¶ú‡¶®‡¶∂‡ßÄ‡¶≤</option>
                <option value="mcq">MCQ</option>
            </select>
            <label id="showOptionsLabel" style="display:none; align-items:center; cursor:pointer; font-weight:bold; margin-bottom:10px; font-size: 13px; color: var(--primary);">
                <input type="checkbox" id="showOptionsToggle" checked style="width:auto; margin-right:8px;"> ‡¶Ö‡¶™‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
            </label>
            <textarea id="qBody" rows="3" placeholder="‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®..." class="input-group" oninput="checkDuplicateWhileTyping()"></textarea>
            <input type="text" id="qAns" placeholder="‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞" class="input-group" oninput="checkDuplicateWhileTyping()"></textarea>
            <input type="text" id="qBoard" placeholder="‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶ì ‡¶∏‡¶æ‡¶≤" class="input-group">
            <div id="extraFields" style="display:none; background:#f5f5f5; padding:10px; border-radius:5px; margin-bottom:10px;">
                <input type="text" id="qA" placeholder="‡¶ï" class="input-group" oninput="checkDuplicateWhileTyping()"></textarea>
                <input type="text" id="qB" placeholder="‡¶ñ" class="input-group" oninput="checkDuplicateWhileTyping()"></textarea>
                <input type="text" id="qC" placeholder="‡¶ó" class="input-group" oninput="checkDuplicateWhileTyping()"></textarea>
                <input type="text" id="qD" placeholder="‡¶ò" class="input-group" oninput="checkDuplicateWhileTyping()"></textarea>
            </div>
            <input type="file" id="qImg" accept="image/*" class="input-group" onchange="handleImage(event)">
            <div id="imgPreview" style="margin: 5px 0;"></div>
            
            <!-- Duplicate Check Status -->
            <div id="duplicateStatus" style="display:none; margin:10px 0; padding:10px; border-radius:5px; text-align:center; font-size:13px;"></div>
            
            <button class="btn-action" id="saveBtn" style="background:var(--primary); color:white;" onclick="addQuestionWithDuplicateCheck()">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn-action" style="background:#777; color:white; display:none;" id="cancelBtn" onclick="cancelEdit()">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
            
            <!-- Duplicate Management Section -->
            <div style="margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; border: 1px solid #ffb74d;">
                <h4 style="color: #e65100; margin-top: 0; margin-bottom: 10px;">üîÑ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h4>
                
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn-action" style="background: #ff9800; color: white;" onclick="findAndShowAllDuplicates()">
                        üîç ‡¶∏‡¶¨ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®
                    </button>
                    
                    <button class="btn-action" style="background: #f44336; color: white;" onclick="removeAllDuplicates()">
                        üóëÔ∏è ‡¶∏‡¶¨ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
                    </button>
                    
                    <div style="font-size: 12px; color: #666; text-align: center;">
                        ‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®: <span id="totalQuestionCount">0</span>‡¶ü‡¶ø
                    </div>
                </div>
            </div>
            
            <!-- Equation Help Text -->
            <div style="background:#e3f2fd; padding:10px; border-radius:5px; margin-top:15px; font-size:12px;">
                <strong>‡¶á‡¶ï‡ßÅ‡ßü‡ßá‡¶∂‡¶® ‡¶≤‡¶ø‡¶ñ‡¶æ‡¶∞ ‡¶®‡¶ø‡ßü‡¶Æ:</strong><br>
                1. ‡¶è‡¶ï ‡¶≤‡¶æ‡¶á‡¶®‡ßá‡¶∞ ‡¶á‡¶ï‡ßÅ‡ßü‡ßá‡¶∂‡¶®: $E = mc^2$<br>
                2. ‡¶¨‡ßú ‡¶á‡¶ï‡ßÅ‡ßü‡ßá‡¶∂‡¶® (‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡¶æ‡¶á‡¶®‡ßá): $$x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}$$<br>
                3. MCQ ‡¶Ö‡¶™‡¶∂‡¶®‡ßá: ‡¶ï: $$v = \sqrt{\frac{eV_0}{m}}$$<br>
                4. ‡¶≤‡¶æ‡¶á‡¶® ‡¶¨‡ßç‡¶∞‡ßá‡¶ï‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø: Enter ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®<br>
                5. ‡¶¨‡ßú ‡¶¨‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ü: $$\left(\frac{a}{b}\right)$$
            </div>
        </div>
        <div class="admin-hide-msg" style="text-align:center; color:#999; margin-top:30px;"><p>‚ö†Ô∏è ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®‡•§</p></div>
    </div>

    <!-- Monthly Exam Panel -->
    <div id="monthly" class="panel">
        <div class="monthly-exam-section">
            <h3>üìÖ ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï/‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶§‡ßà‡¶∞‡¶ø</h3>
            
            <div class="input-group">
                <label>‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                <input type="text" id="monthlyExamName" placeholder="‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ-‡ßß / ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ-‡ßß" value="‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ">
            </div>
            
            <div class="input-group">
                <label>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                <select id="monthlyClass" onchange="loadSubjectsForMonthly()">
                    <option value="">‡¶∏‡¶¨ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø</option>
                    <option value="HSC">HSC</option>
                    <option value="‡¶¶‡¶∂‡¶Æ">‡¶¶‡¶∂‡¶Æ</option>
                    <option value="‡¶®‡¶¨‡¶Æ">‡¶®‡¶¨‡¶Æ</option>
                    <option value="‡¶Ö‡¶∑‡ßç‡¶ü‡¶Æ">‡¶Ö‡¶∑‡ßç‡¶ü‡¶Æ</option>
                    <option value="‡¶∏‡¶™‡ßç‡¶§‡¶Æ">‡¶∏‡¶™‡ßç‡¶§‡¶Æ</option>
                    <option value="‡¶∑‡¶∑‡ßç‡¶†">‡¶∑‡¶∑‡ßç‡¶†</option>
                    <option value="‡¶™‡¶û‡ßç‡¶ö‡¶Æ">‡¶™‡¶û‡ßç‡¶ö‡¶Æ</option>
                    <option value="‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶•">‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶•</option>
                    <option value="‡¶§‡ßÉ‡¶§‡ßÄ‡ßü">‡¶§‡ßÉ‡¶§‡ßÄ‡ßü</option>
                    <option value="‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü">‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü</option>
                    <option value="‡¶™‡ßç‡¶∞‡¶•‡¶Æ">‡¶™‡ßç‡¶∞‡¶•‡¶Æ</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                <select id="monthlyDivision" onchange="loadSubjectsForMonthly()">
                    <option value="">‡¶∏‡¶¨ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó</option>
                    <option value="‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£</option>
                    <option value="‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®">‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®</option>
                    <option value="‡¶Æ‡¶æ‡¶®‡¶¨‡¶ø‡¶ï">‡¶Æ‡¶æ‡¶®‡¶¨‡¶ø‡¶ï</option>
                    <option value="‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ">‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ</label>
                <input type="number" id="questionsPerSubject" min="1" max="10" value="2" onchange="updateMonthlyStats()">
            </div>
            
            <button class="btn-action" style="background:#2196f3; color:white; margin-top:10px;" onclick="loadSubjectsForMonthly()">üìö ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
            
            <div id="monthlySubjectsContainer" style="margin-top:15px;">
                <!-- ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶ó‡ßÅ‡¶≤‡ßã ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá -->
            </div>
            
            <div id="monthlyStats" class="monthly-stats" style="display:none;">
                ‡¶Æ‡ßã‡¶ü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§: <span id="monthlyTotalSelected">0</span>‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®
            </div>
            
            <div class="monthly-controls">
                <button onclick="generateMonthlyExam()" style="background:#4caf50; color:white;">‚úÖ ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button onclick="clearMonthlySelection()" style="background:#f44336; color:white;">üóëÔ∏è ‡¶∏‡¶¨ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞</button>
            </div>
            
            <div style="margin-top:15px; background:#e8f5e9; padding:10px; border-radius:5px; font-size:12px;">
                <strong>‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶ø‡¶ï‡¶æ:</strong><br>
                1. ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø ‡¶ì ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®<br>
                2. "‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®<br>
                3. ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®<br>
                4. "‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
            </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div id="sets" class="panel">
        <div style="background: #fff8e1; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #ffe082;">
            <label style="display:flex; align-items:center; cursor:pointer; font-weight:bold;">
                <input type="checkbox" id="showAnsKey" checked onchange="sync()" style="width:auto; margin-right:10px;"> 
                ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü‡ßá ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶™‡¶§‡ßç‡¶∞ ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®
            </label>
        </div>
        
        <h4 style="color:var(--primary); margin-top:0; border-bottom:1px solid #ddd;">‚öôÔ∏è ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶≤ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h4>
        
        <div class="input-group">
            <label>‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü</label>
            <input type="text" id="hSet" placeholder="‡¶ï" oninput="sync()">
        </div>
        
        <div class="input-group">
            <label>‡¶≠‡¶æ‡¶∑‡¶æ</label>
            <select id="qLang" onchange="sync()">
                <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
                <option value="en">‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø</option>
            </select>
        </div>
        
        <div class="input-group">
            <label>‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
            <input type="text" id="h1" value="‡¶∂‡ßá‡¶∞‡¶ñ‡¶æ‡¶≤‡ßÄ ‡¶∏‡¶∞‡¶ï‡¶æ‡¶∞‡¶ø ‡¶Æ‡¶π‡¶ø‡¶≤‡¶æ ‡¶ï‡¶≤‡ßá‡¶ú" oninput="sync()">
            <div class="slider-container">
                <input type="range" id="fsH1" min="14" max="40" value="20" oninput="updateSliderValue('fsH1', this.value + 'px'); updateHeaders(); sync()">
                <span class="slider-value" id="fsH1Value">20px</span>
            </div>
            <div class="slider-label">
                <span>‡¶õ‡ßã‡¶ü</span>
                <span>‡¶¨‡¶°‡¶º</span>
            </div>
        </div>
        
        <div class="input-group">
            <label>‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
            <input type="text" id="h2" value="‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ-‡ß®‡ß¶‡ß®‡ß¨" oninput="sync()">
            <div class="slider-container">
                <input type="range" id="fsH2" min="12" max="30" value="16" oninput="updateSliderValue('fsH2', this.value + 'px'); updateHeaders(); sync()">
                <span class="slider-value" id="fsH2Value">16px</span>
            </div>
            <div class="slider-label">
                <span>‡¶õ‡ßã‡¶ü</span>
                <span>‡¶¨‡¶°‡¶º</span>
            </div>
        </div>
  
        <div class="input-group">
            <label>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø (‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶≤‡¶æ‡¶á‡¶®)</label>
            <input type="text" id="hClass" placeholder="‡¶è‡¶ï‡¶æ‡¶¶‡¶∂ (‡¶Æ‡¶æ‡¶®‡¶¨‡¶ø‡¶ï)" oninput="sync()">
        </div>
        
        <div class="input-group">
            <label>‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º (‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶≤‡¶æ‡¶á‡¶®)</label>
            <input type="text" id="h3" oninput="sync()">
        </div>
        
        <div class="input-group">
            <label>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø ‡¶ì ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶∏‡¶æ‡¶á‡¶ú</label>
            <div class="slider-container">
                <input type="range" id="fsH3" min="10" max="22" value="13" oninput="updateSliderValue('fsH3', this.value + 'px'); updateHeaders(); sync()">
                <span class="slider-value" id="fsH3Value">13px</span>
            </div>
            <div class="slider-label">
                <span>‡¶õ‡ßã‡¶ü</span>
                <span>‡¶¨‡¶°‡¶º</span>
            </div>
        </div>

        <div style="display: flex; gap: 5px;">
            <div class="input-group">
                <label>‡¶∏‡¶Æ‡¶Ø‡¶º</label>
                <input type="text" id="hTime" oninput="sync()">
            </div>
            <div class="input-group">
                <label>‡¶Æ‡¶æ‡¶®</label>
                <input type="text" id="hMarks" oninput="sync()">
            </div>
        </div>
        
        <div class="input-group">
            <label>‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶ø‡¶ï‡¶æ</label>
            <input type="text" id="hInst" oninput="sync()">
            <div class="slider-container">
                <input type="range" id="fsH4" min="10" max="20" value="13" oninput="updateSliderValue('fsH4', this.value + 'px'); updateHeaders(); sync()">
                <span class="slider-value" id="fsH4Value">13px</span>
            </div>
            <div class="slider-label">
                <span>‡¶õ‡ßã‡¶ü</span>
                <span>‡¶¨‡¶°‡¶º</span>
            </div>
        </div>
        
        <!-- Font Selection Section -->
        <div class="pagination-settings" style="margin-top: 20px;">
            <h4 style="color:var(--primary); margin-top:0; margin-bottom:10px;">üî§ ‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡¶∂‡¶®</h4>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                <!-- Font Preview -->
                <div class="font-preview" id="fontPreview">
                    ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶´‡¶®‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â: ‡¶Ö‡¶≠‡ßç‡¶∞ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® ‡¶∏‡¶π‡¶ú‡ßá‡¶á‡•§ ‡ßß‡ß®‡ß©‡ß™ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶è‡¶¨‡¶Ç English text.
                </div>
                
                <!-- Font Options Grid -->
                <div class="font-option-grid">
                    <div class="font-option font-kalpurush selected" onclick="selectFont('kalpurush', '‡¶ï‡¶≤‡¶™‡ßÅ‡¶∞‡ßÅ‡¶∑')">
                        ‡¶ï‡¶≤‡¶™‡ßÅ‡¶∞‡ßÅ‡¶∑
                    </div>
                    <div class="font-option font-solaimanlipi" onclick="selectFont('solaimanlipi', '‡¶∏‡ßã‡¶≤‡¶æ‡¶á‡¶Æ‡¶æ‡¶®‡¶≤‡¶ø‡¶™‡¶ø')">
                        ‡¶∏‡ßã‡¶≤‡¶æ‡¶á‡¶Æ‡¶æ‡¶®‡¶≤‡¶ø‡¶™‡¶ø
                    </div>
                    <div class="font-option font-siyamrupali" onclick="selectFont('siyamrupali', '‡¶∏‡¶ø‡ßü‡¶æ‡¶Æ‡¶∞‡ßÅ‡¶™‡¶æ‡¶≤‡¶ø')">
                        ‡¶∏‡¶ø‡ßü‡¶æ‡¶Æ‡¶∞‡ßÅ‡¶™‡¶æ‡¶≤‡¶ø
                    </div>
                    <div class="font-option font-notosans" onclick="selectFont('notosans', '‡¶®‡ßã‡¶ü‡ßã ‡¶∏‡¶æ‡¶®‡ßç‡¶∏')">
                        ‡¶®‡ßã‡¶ü‡ßã ‡¶∏‡¶æ‡¶®‡ßç‡¶∏
                    </div>
                    <div class="font-option font-roboto" onclick="selectFont('roboto', '‡¶∞‡ßã‡¶¨‡ßã‡¶ü‡ßã')">
                        ‡¶∞‡ßã‡¶¨‡ßã‡¶ü‡ßã
                    </div>
                    <div class="font-option font-times" onclick="selectFont('times', '‡¶ü‡¶æ‡¶á‡¶Æ‡¶∏ ‡¶®‡¶ø‡¶â ‡¶∞‡ßã‡¶Æ‡¶æ‡¶®')">
                        ‡¶ü‡¶æ‡¶á‡¶Æ‡¶∏
                    </div>
                    <div class="font-option font-arial" onclick="selectFont('arial', '‡¶è‡¶∞‡¶ø‡ßü‡¶æ‡¶≤')">
                        ‡¶è‡¶∞‡¶ø‡ßü‡¶æ‡¶≤
                    </div>
                </div>
                
                <!-- Custom Font Input -->
                <div style="margin-top: 15px;">
                    <label style="display:block; margin-bottom:5px; font-weight:bold;">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶´‡¶®‡ßç‡¶ü (Google Fonts ‡¶®‡¶æ‡¶Æ)</label>
                    <div class="custom-font-input">
                        <input type="text" id="customFontName" placeholder="‡¶â‡¶¶‡¶æ: 'Hind Siliguri', sans-serif" value="">
                        <button onclick="applyCustomFont()" style="background:var(--primary); color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶á</button>
                    </div>
                    <small style="color:#666; display:block; margin-top:5px;">Google Fonts ‡¶•‡ßá‡¶ï‡ßá ‡¶´‡¶®‡ßç‡¶ü ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</small>
                </div>
                
                <!-- Font Size Control -->
                <div style="margin-top: 15px;">
                    <label style="display:block; margin-bottom:5px; font-weight:bold;">‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú (‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü)</label>
                    <div class="slider-container">
                        <input type="range" id="questionFontSize" min="10" max="20" value="13" oninput="updateSliderValue('questionFontSize', this.value + 'px'); updateFontPreview(); sync()">
                        <span class="slider-value" id="questionFontSizeValue">13px</span>
                    </div>
                    <div class="slider-label">
                        <span>‡¶õ‡ßã‡¶ü</span>
                        <span>‡¶¨‡¶°‡¶º</span>
                    </div>
                </div>
                
                <!-- Apply to sections -->
                <div style="margin-top: 15px;">
                    <label style="display:block; margin-bottom:5px; font-weight:bold;">‡¶Ø‡ßá‡¶∏‡¶¨ ‡¶Ö‡¶Ç‡¶∂‡ßá ‡¶´‡¶®‡ßç‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶π‡¶¨‡ßá:</label>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="applyToQuestions" checked onchange="saveData(); sync()" style="width:auto; margin-right:8px;">
                            ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü
                        </label>
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="applyToOptions" checked onchange="saveData(); sync()" style="width:auto; margin-right:8px;">
                            MCQ/CQ ‡¶Ö‡¶™‡¶∂‡¶®
                        </label>
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="applyToHeaders" checked onchange="saveData(); sync()" style="width:auto; margin-right:8px;">
                            ‡¶π‡ßá‡¶°‡¶æ‡¶∞/‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ
                        </label>
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="applyToAnswerSheet" checked onchange="saveData(); sync()" style="width:auto; margin-right:8px;">
                            ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶™‡¶§‡ßç‡¶∞
                        </label>
                    </div>
                </div>
                
                <!-- Reset Button -->
                <div style="margin-top: 15px;">
                    <button onclick="resetFontSettings()" style="width:100%; background:#f44336; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer; font-weight:bold;">
                        üîÑ ‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                </div>
            </div>
            
            <div style="background: #e8f5e9; padding: 10px; border-radius: 5px; margin-top: 10px;">
                <small style="color:#666; display:block;">
                    <strong>‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶ø‡¶ï‡¶æ:</strong><br>
                    1. ‡¶´‡¶®‡ßç‡¶ü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶ì ‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø ‡¶â‡¶≠‡¶Ø‡¶º‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶â‡¶™‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§)<br>
                    2. ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶´‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá Google Fonts ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®<br>
                    3. ‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú ‡¶∏‡¶æ‡¶Æ‡¶û‡ßç‡¶ú‡¶∏‡ßç‡¶Ø ‡¶ï‡¶∞‡ßÅ‡¶®<br>
                    4. ‡¶´‡¶®‡ßç‡¶ü ‡¶Ø‡ßá‡¶∏‡¶¨ ‡¶Ö‡¶Ç‡¶∂‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶π‡¶¨‡ßá ‡¶§‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®<br>
                    5. ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶¶‡ßá‡¶ñ‡¶§‡ßá "‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü" ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨‡ßá ‡¶Ø‡¶æ‡¶®
                </small>
            </div>
        </div>
        
        <!-- Pagination Settings -->
        <div class="pagination-settings">
            <h4 style="color:var(--primary); margin-top:0; margin-bottom:10px;">üìÑ ‡¶™‡ßá‡¶ú‡¶ø‡¶®‡ßá‡¶∂‡¶® ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h4>
            <div class="input-group">
                <label>‡¶¨‡¶æ‡¶õ‡¶æ‡¶á‡¶§‡ßá ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶™‡ßá‡¶ú‡ßá ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®</label>
                <input type="number" id="selectionPerPage" value="10" min="1" max="50" oninput="saveData(); renderSelectionList()">
            </div>
            <div class="input-group">
                <label>‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü‡ßá ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶™‡ßá‡¶ú‡ßá ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®</label>
                <input type="number" id="outputPerPage" value="30" min="15" max="60" oninput="saveData(); renderOutputPages()">
            </div>
            <div style="background: #e8f5e9; padding: 10px; border-radius: 5px; margin-top: 10px;">
                <label style="font-weight: bold; color: #2e7d32; display: block; margin-bottom: 5px;">
                    üìÑ ‡¶Ö‡¶™‡¶ü‡¶ø‡¶Æ‡¶æ‡¶á‡¶ú‡¶° ‡¶≤‡ßá‡¶Ü‡¶â‡¶ü: <span class="page-status-indicator">‡ß©‡ß¶ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®/‡¶™‡ßá‡¶ú</span>
                </label>
                <small style="color:#666; display:block;">‡¶è‡¶ï ‡¶™‡ßá‡¶ú‡ßá ‡ß©‡ß¶‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶´‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡¶ü‡¶ø‡¶Æ‡¶æ‡¶á‡¶ú‡¶°‡•§</small>
                <small style="color:#666; display:block;">‡ß®‡ßü ‡¶™‡¶æ‡¶§‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá ‡¶®‡¶æ</small>
            </div>
            <label style="display:flex; align-items:center; cursor:pointer; font-weight:bold; margin-top:10px; font-size:13px;">
                <input type="checkbox" id="showPageNumbers" checked onchange="saveData(); renderOutputPages()" style="width:auto; margin-right:8px;"> 
                ‡¶™‡ßá‡¶ú ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
            </label>
            <label style="display:flex; align-items:center; cursor:pointer; font-weight:bold; margin-top:10px; font-size:13px;">
                <input type="checkbox" id="showOutputPagination" checked onchange="toggleOutputPagination()" style="width:auto; margin-right:8px;"> 
                ‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü ‡¶™‡ßá‡¶ú‡¶ø‡¶®‡ßá‡¶∂‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
            </label>
        </div>
        
        <!-- ‚úÖ ‡ß®‡ßü ‡¶™‡¶æ‡¶§‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡ßß‡ß¶mm (‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶°) -->
        <div style="background: #f3e5f5; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ce93d8;">
            <h4 style="color: #7b1fa2; margin-top: 0; margin-bottom: 8px;">üìÑ ‡ß®‡ßü ‡¶™‡¶æ‡¶§‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h4>
            <div style="display: flex; align-items: center; gap: 10px; background: white; padding: 10px; border-radius: 6px; border: 1px solid #d1c4e9;">
                <div style="width: 40px; height: 40px; background: #7b1fa2; color: white; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; font-size: 18px;">
                    ‡ßß‡ß¶
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: bold; color: #7b1fa2; font-size: 16px;">‡ß®‡ßü ‡¶™‡¶æ‡¶§‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶®: ‡ßß‡ß¶mm</div>
                    <small style="color:#666; display:block;">‡ß®‡ßü, ‡ß©‡ßü, ... ‡¶™‡¶æ‡¶§‡¶æ‡¶∞ ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡ßß‡ß¶mm</small>
                    <small style="color:#666; display:block;">‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶™‡¶æ‡¶§‡¶æ: ‡ßß‡ß®mm | ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶™‡¶æ‡¶§‡¶æ: ‡ßß‡ß¶mm</small>
                </div>
            </div>
        </div>
        
        <!-- Subject-wise Question Count Control -->
        <div class="pagination-settings" style="margin-top: 20px;">
            <h4 style="color:var(--primary); margin-top:0; margin-bottom:10px;">üìö ‡¶¨‡¶ø‡¶∑‡ßü‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ</h4>
            <div id="subjectLimitContainer" style="max-height: 200px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                <!-- Subject limits will be dynamically added here -->
                <p style="text-align:center; color:#666; font-size:13px;">‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá</p>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="updateSubjectLimitsFromSelected()" style="flex:1; background:#2196f3; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer; font-weight:bold;">
                    üîÑ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶•‡ßá‡¶ï‡ßá ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
                <button onclick="clearAllSubjectLimits()" style="flex:1; background:#f44336; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer; font-weight:bold;">
                    ‚ùå ‡¶∏‡¶¨ ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞
                </button>
            </div>
            
            <div style="background: #e8f5e9; padding: 10px; border-radius: 5px; margin-top: 10px;">
                <small style="color:#666; display:block;">
                    <strong>‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶ø‡¶ï‡¶æ:</strong><br>
                    1. ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶¨‡¶æ‡¶Æ ‡¶™‡¶æ‡¶∂ ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®<br>
                    2. "‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶•‡ßá‡¶ï‡ßá ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®<br>
                    3. ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶§‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ö‡¶æ‡¶® ‡¶§‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®<br>
                    4. ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶®‡¶æ ‡¶¶‡¶ø‡¶≤‡ßá ‡¶∏‡ßá‡¶á ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶∏‡¶¨ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ø‡¶æ‡¶¨‡ßá<br>
                    5. ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü/PDF ‡¶ï‡¶∞‡¶§‡ßá "‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
                </small>
            </div>
            
            <label style="display:flex; align-items:center; cursor:pointer; font-weight:bold; margin-top:10px; font-size:13px;">
                <input type="checkbox" id="enableSubjectLimits" checked onchange="toggleSubjectLimits(); saveData();" style="width:auto; margin-right:8px;"> 
                ‡¶¨‡¶ø‡¶∑‡ßü‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶ï‡¶∞‡ßÅ‡¶®
            </label>
        </div>
        
        <!-- Monthly Exam Settings -->
        <div class="pagination-settings" style="margin-top: 20px;">
            <h4 style="color:var(--primary); margin-top:0; margin-bottom:10px;">üìÖ ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h4>
            
            <label style="display:flex; align-items:center; cursor:pointer; font-weight:bold; margin-bottom:10px; font-size:13px;">
                <input type="checkbox" id="showSubjectNames" checked onchange="saveData(); sync();" style="width:auto; margin-right:8px;"> 
                ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡ßü ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
            </label>
            
            <label style="display:flex; align-items:center; cursor:pointer; font-weight:bold; margin-bottom:10px; font-size:13px;">
                <input type="checkbox" id="combineAllSubjects" onchange="saveData(); sync();" style="width:auto; margin-right:8px;"> 
                ‡¶∏‡¶¨ ‡¶¨‡¶ø‡¶∑‡ßü ‡¶è‡¶ï‡¶§‡ßç‡¶∞‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶è‡¶ï‡¶ü‡¶æ ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶Æ‡¶§ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá)
            </label>
            
            <div style="background: #e8f5e9; padding: 10px; border-radius: 5px; margin-top: 10px;">
                <small style="color:#666; display:block;">
                    <strong>‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶ø‡¶ï‡¶æ:</strong><br>
                    ‚úÖ <strong>‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®</strong>: ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡ßü ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∑‡ßü ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ‡¶≠‡¶æ‡¶¨‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá<br>
                    ‚ùå <strong>‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶® ‡¶®‡¶æ</strong>: ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá, ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ/‡¶∏‡ßá‡¶™‡¶æ‡¶∞‡ßá‡¶ü‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá ‡¶®‡¶æ<br>
                    üîÑ <strong>‡¶∏‡¶¨ ‡¶¨‡¶ø‡¶∑‡ßü ‡¶è‡¶ï‡¶§‡ßç‡¶∞‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</strong>: ‡¶∏‡¶¨ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶è‡¶ï‡¶ü‡¶æ‡¶á ‡¶∏‡¶æ‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶Æ‡¶§ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá, ‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶ö‡¶≤‡¶¨‡ßá
                </small>
            </div>
        </div>
        
        <div class="input-group">
            <label style="color: blue;">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ó‡ßç‡¶Ø‡¶æ‡¶™ (Spacing)</label>
            <div class="slider-container">
                <input type="range" id="qGapSlider" min="0" max="50" value="12" oninput="updateSliderValue('qGapSlider', this.value + 'px'); sync()">
                <span class="slider-value" id="qGapSliderValue">12px</span>
            </div>
            <div class="slider-label">
                <span>‡¶∏‡¶Ç‡¶ï‡ßÄ‡¶∞‡ßç‡¶£</span>
                <span>‡¶´‡¶æ‡¶Å‡¶ï‡¶æ</span>
            </div>
        </div>        
        
        <div class="input-group">
            <label>‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú</label>
            <div class="slider-container">
                <input type="range" id="fSize" min="10" max="20" value="13" oninput="updateSliderValue('fSize', this.value + 'px'); sync()">
                <span class="slider-value" id="fSizeValue">13px</span>
            </div>
            <div class="slider-label">
                <span>‡¶õ‡ßã‡¶ü</span>
                <span>‡¶¨‡¶°‡¶º</span>
            </div>
        </div>
        
        <div class="input-group">
            <label>‡¶≤‡¶æ‡¶á‡¶® ‡¶∏‡ßç‡¶™‡ßá‡¶∏‡¶ø‡¶Ç</label>
            <div class="slider-container">
                <input type="range" id="lHeight" min="1.0" max="2.5" step="0.1" value="1.3" oninput="updateSliderValue('lHeight', this.value); sync()">
                <span class="slider-value" id="lHeightValue">1.3</span>
            </div>
            <div class="slider-label">
                <span>‡¶∏‡¶Ç‡¶ï‡ßÄ‡¶∞‡ßç‡¶£</span>
                <span>‡¶´‡¶æ‡¶Å‡¶ï‡¶æ</span>
            </div>
        </div>
        
        <div class="input-group">
            <label>‡¶ï‡¶≤‡¶æ‡¶Æ</label>
            <select id="colCount" onchange="sync()">
                <option value="2">‡ß® ‡¶ï‡¶≤‡¶æ‡¶Æ</option>
                <option value="1">‡ßß ‡¶ï‡¶≤‡¶æ‡¶Æ</option>
            </select>
        </div>
        
        <h4 style="color:var(--primary); margin-top:20px; border-bottom:1px solid #ddd;">üìê ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ (‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶™‡¶æ‡¶§‡¶æ)</h4>
        
        <div class="input-group">
            <label>‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® (‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶™‡¶æ‡¶§‡¶æ)</label>
            <div class="slider-container">
                <input type="range" id="mTop" min="5" max="30" value="12" oninput="updateSliderValue('mTop', this.value + 'mm'); sync()">
                <span class="slider-value" id="mTopValue">12mm</span>
            </div>
            <div class="slider-label">
                <span>‡¶õ‡ßã‡¶ü</span>
                <span>‡¶¨‡¶°‡¶º</span>
            </div>
        </div>
        
        <div class="input-group">
            <label>‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶®</label>
            <div class="slider-container">
                <input type="range" id="mBottom" min="5" max="30" value="12" oninput="updateSliderValue('mBottom', this.value + 'mm'); sync()">
                <span class="slider-value" id="mBottomValue">12mm</span>
            </div>
            <div class="slider-label">
                <span>‡¶õ‡ßã‡¶ü</span>
                <span>‡¶¨‡¶°‡¶º</span>
            </div>
        </div>
        
        <div class="input-group">
            <label>‡¶¨‡¶æ‡¶Æ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶®</label>
            <div class="slider-container">
                <input type="range" id="mLeft" min="5" max="30" value="15" oninput="updateSliderValue('mLeft', this.value + 'mm'); sync()">
                <span class="slider-value" id="mLeftValue">15mm</span>
            </div>
            <div class="slider-label">
                <span>‡¶õ‡ßã‡¶ü</span>
                <span>‡¶¨‡¶°‡¶º</span>
            </div>
        </div>
        
        <div class="input-group">
            <label>‡¶°‡¶æ‡¶® ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶®</label>
            <div class="slider-container">
                <input type="range" id="mRight" min="5" max="30" value="15" oninput="updateSliderValue('mRight', this.value + 'mm'); sync()">
                <span class="slider-value" id="mRightValue">15mm</span>
            </div>
            <div class="slider-label">
                <span>‡¶õ‡ßã‡¶ü</span>
                <span>‡¶¨‡¶°‡¶º</span>
            </div>
        </div>
        
        <button class="btn-action" style="background:#555; color:white; margin-top:20px;" onclick="exportJSON()">üì• ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™</button>
        <button class="btn-action" style="background:#00796b; color:white;" onclick="document.getElementById('importFile').click()">üì§ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞</button>
        <input type="file" id="importFile" style="display:none;" onchange="importJSON(event)">
    </div>
</div>

<!-- Preview Area -->
<div class="preview-area" id="previewArea">
    <div id="examPaper" class="exam-paper">
        <!-- Output Pages Container -->
        <div id="outputPagesContainer"></div>
        
        <!-- Answer Sheet -->
        <div id="ansSheetArea"><h3 style="text-align:center; border-bottom: 1px solid #000; margin-bottom:10px; font-size: 16px;">‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶Æ‡¶æ‡¶≤‡¶æ</h3><div id="ansGrid" class="ans-grid"></div></div>
    </div>
</div>

<!-- Output Pagination Controls -->
<div id="outputPagination" class="output-pagination">
    <div style="display: flex; align-items: center; gap: 15px;">
        <button class="page-btn" onclick="changeOutputPage(-1)" id="outputPrevBtn">‚Üê ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶™‡ßá‡¶ú</button>
        <div class="page-info" id="outputPageInfo">‡¶™‡ßá‡¶ú 1/1</div>
        <button class="page-btn" onclick="changeOutputPage(1)" id="outputNextBtn">‡¶™‡¶∞‡ßá‡¶∞ ‡¶™‡ßá‡¶ú ‚Üí</button>
    </div>
    <div class="page-input-group">
        <span>‡¶Ø‡¶æ‡¶®:</span>
        <input type="number" id="jumpToOutputPage" min="1" value="1" onchange="jumpToOutputPage()">
        <span>/<span id="totalOutputPagesDisplay">1</span></span>
    </div>
</div>

<script>
    let questionBank = [];
    const DB_KEY = 'bcti_v25_final';
    let currentImgData = "", cropper;
    const MASTER_KEY = "BCTI-2026-PRO";
    
    // Pagination Variables
    let selectionCurrentPage = 1;
    let outputCurrentPage = 1;
    let selectionPerPage = 10;
    let outputPerPage = 30;
    let totalSelectionPages = 1;
    let totalOutputPages = 1;
    
    // Temporary Edits Storage
    let temporaryEdits = new Map();
    let currentEditingIndex = 0;

    // Search variables - FIXED
    let searchResults = [];
    let currentSearchIndex = 0;
    let searchTerm = '';
    let isSearchActive = false;

    // Monthly Exam Variables
    let monthlySelectedQuestions = new Map(); // subject -> array of question indices

    // Subject-wise question limits
    let subjectLimits = {}; // Store subject limits: {subject: maxQuestions}
    let showSubjectNames = true;
    let combineAllSubjects = false;
    
    // Font selection variables
    let selectedFont = 'kalpurush';
    let selectedFontName = '‡¶ï‡¶≤‡¶™‡ßÅ‡¶∞‡ßÅ‡¶∑';
    let customFontFamily = '';
    let questionFontSize = '13';
    let applyToQuestions = true;
    let applyToOptions = true;
    let applyToHeaders = true;
    let applyToAnswerSheet = true;

    function checkLicense() { 
        const savedKey = localStorage.getItem('bcti_app_license'); 
        if (savedKey !== MASTER_KEY) { 
            const userInput = prompt("License Key:"); 
            if (userInput === MASTER_KEY) { localStorage.setItem('bcti_app_license', userInput); loadData(); } 
            else { document.body.innerHTML = `<h1>Invalid Access</h1>`; } 
        } else { loadData(); } 
    }
    
    // ==================== RENDER OUTPUT PAGES WITH SUBJECT-WISE SERIAL ====================
    
    function renderOutputPages() {
        const selected = questionBank.filter(q => q.selected);
        const showPageNumbers = document.getElementById('showPageNumbers').checked;
        
        // Get settings for monthly exam
        showSubjectNames = document.getElementById('showSubjectNames').checked;
        combineAllSubjects = document.getElementById('combineAllSubjects').checked;
        const enableSubjectLimits = document.getElementById('enableSubjectLimits').checked;
        
        // Clear previous pages
        document.getElementById('outputPagesContainer').innerHTML = '';
        
        // If no questions, show empty page
        if (selected.length === 0) {
            totalOutputPages = 1;
            outputCurrentPage = 1;
            
            const topMargin = document.getElementById('mTop').value || '12';
            const rightMargin = document.getElementById('mRight').value || '15';
            const bottomMargin = document.getElementById('mBottom').value || '12';
            const leftMargin = document.getElementById('mLeft').value || '15';
            
            let pageHeader = `
            <div id="outSetLine"></div>
            <div class="header"><h1 id="outH1"></h1><h2 id="outH2"></h2></div>
            <div id="outClassLine" class="header-info"></div>
            <div id="outSubjectLine" class="header-info" style="margin-bottom:10px;"></div>
            <div class="marks-info"><span id="outTime"></span><span id="outMarks"></span></div>
            <div id="outInst" class="instruction"></div>`;
            
            let pageFooter = '';
            if (showPageNumbers) {
                pageFooter = `<div class="page-number">‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ 1/1</div>`;
            }
            
            document.getElementById('outputPagesContainer').innerHTML = `
            <div id="output-page-1" class="output-page active" style="padding: ${topMargin}mm ${rightMargin}mm ${bottomMargin}mm ${leftMargin}mm !important;">
                ${pageHeader}
                <div class="question-container" style="column-count: ${document.getElementById('colCount').value}; text-align: center; padding: 50px;">
                    <p style="font-size: 18px; color: #666;">‡¶ï‡ßã‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶¨‡¶æ‡¶Æ ‡¶™‡¶æ‡¶∂ ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                </div>
                ${pageFooter}
            </div>`;
            
            // Update header elements
            updateHeaders();
            updateOutputPagination();
            
            return;
        }
        
        // Group selected questions by subject with their serial numbers
        const groupedBySubject = {};
        selected.forEach((question, index) => {
            const subject = question.sub || '‡¶¨‡¶ø‡¶∑‡ßü‡¶π‡ßÄ‡¶®';
            if (!groupedBySubject[subject]) {
                groupedBySubject[subject] = {
                    questions: [],
                    serialStart: 1
                };
            }
            groupedBySubject[subject].questions.push({
                question: question,
                globalIndex: index,
                subjectSerial: groupedBySubject[subject].questions.length + 1
            });
        });
        
        // Apply subject limits if enabled
        let finalGrouping = {};
        if (enableSubjectLimits && Object.keys(subjectLimits).length > 0) {
            Object.keys(groupedBySubject).forEach(subject => {
                const limit = subjectLimits[subject];
                const allQuestions = groupedBySubject[subject].questions;
                
                if (limit !== undefined && limit < allQuestions.length) {
                    // Take only limited number of questions
                    finalGrouping[subject] = {
                        questions: allQuestions.slice(0, limit),
                        serialStart: 1
                    };
                } else {
                    // Take all questions (no limit or limit is >= total)
                    finalGrouping[subject] = groupedBySubject[subject];
                }
            });
        } else {
            // No limits applied, take all questions
            finalGrouping = groupedBySubject;
        }
        
        // Remove subjects with 0 questions after limiting
        Object.keys(finalGrouping).forEach(subject => {
            if (finalGrouping[subject].questions.length === 0) {
                delete finalGrouping[subject];
            }
        });
        
        // Apply combineAllSubjects setting
        let displayGrouping;
        if (combineAllSubjects) {
            // Combine all subjects into one
            displayGrouping = {
                '‡¶∏‡¶ï‡¶≤ ‡¶¨‡¶ø‡¶∑‡ßü': {
                    questions: selected.map((q, index) => ({
                        question: q,
                        globalIndex: index,
                        subjectSerial: index + 1
                    })),
                    serialStart: 1
                }
            };
        } else {
            // Keep subjects separate
            displayGrouping = finalGrouping;
        }
        
        // Get output per page setting
        outputPerPage = parseInt(document.getElementById('outputPerPage').value) || 30;
        if (outputPerPage < 15) outputPerPage = 15;
        if (outputPerPage > 60) outputPerPage = 60;
        
        // ‚úÖ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶™‡¶æ‡¶§‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶°‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶ø‡¶®
        const topMargin = document.getElementById('mTop').value || '12';
        const rightMargin = document.getElementById('mRight').value || '15';
        const bottomMargin = document.getElementById('mBottom').value || '12';
        const leftMargin = document.getElementById('mLeft').value || '15';
        
        // ‚úÖ ‡ß®‡ßü ‡¶™‡¶æ‡¶§‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡ßß‡ß¶mm
        const secondPageTopMargin = '10';
        
        // Get font size and line height from slider
        const currentFontSize = document.getElementById('fSize').value;
        const currentLineHeight = document.getElementById('lHeight').value;
        
        // Create pages
        let pagesHTML = '';
        let currentPage = 1;
        let questionsOnCurrentPage = 0;
        let currentPageContent = '';
        let isFirstSubjectOnPage = true;
        
        // Process each subject
        Object.keys(displayGrouping).forEach((subject, subjectIndex) => {
            const subjectData = displayGrouping[subject];
            const subjectQuestions = subjectData.questions;
            
            // Add subject separator if showSubjectNames is true AND not combining subjects
            let subjectSeparator = '';
            if (showSubjectNames && !combineAllSubjects) {
                if (!isFirstSubjectOnPage) {
                    subjectSeparator = `<div class="subject-separator" style="font-size: ${currentFontSize}px !important; margin-top: 15px; margin-bottom: 8px;">üìò ${subject}</div>`;
                } else {
                    subjectSeparator = `<div class="subject-separator" style="font-size: ${currentFontSize}px !important; margin-bottom: 8px;">üìò ${subject}</div>`;
                    isFirstSubjectOnPage = false;
                }
                
                // Check if subject separator will fit on current page
                if (questionsOnCurrentPage + 1 > outputPerPage && questionsOnCurrentPage > 0) {
                    // Need to start a new page
                    pagesHTML += createPageHTML(currentPage, currentPageContent, questionsOnCurrentPage, 
                                               topMargin, rightMargin, bottomMargin, leftMargin, 
                                               currentFontSize, currentLineHeight, showPageNumbers);
                    currentPage++;
                    questionsOnCurrentPage = 0;
                    currentPageContent = '';
                    isFirstSubjectOnPage = true;
                    
                    // Re-add subject separator for new page
                    subjectSeparator = `<div class="subject-separator" style="font-size: ${currentFontSize}px !important; margin-bottom: 8px;">üìò ${subject}</div>`;
                }
                
                // Add subject separator to current page
                currentPageContent += subjectSeparator;
                questionsOnCurrentPage++;
            } else if (combineAllSubjects && subject === '‡¶∏‡¶ï‡¶≤ ‡¶¨‡¶ø‡¶∑‡ßü') {
                // Don't add subject separator when combining all subjects
                // Just add a small spacing
                if (!isFirstSubjectOnPage) {
                    currentPageContent += `<div style="margin-top: 15px;"></div>`;
                }
                isFirstSubjectOnPage = false;
            }
            
            // Add each question from this subject
            subjectQuestions.forEach((sq, questionIndex) => {
                const q = sq.question;
                // Use combined serial for combined mode, otherwise subject-wise serial
                const num = combineAllSubjects ? formatNum(sq.subjectSerial) : formatNum(sq.subjectSerial);
                const img = q.img ? `<img src="${q.img}" style="max-width:100%; display:block; margin:5px auto; max-height: 100px;">` : '';
                const isEnglish = q.sub.toLowerCase().includes("english") || q.sub.includes("‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø");
                const labels = isEnglish ? ["a", "b", "c", "d"] : ["‡¶ï", "‡¶ñ", "‡¶ó", "‡¶ò"];
                
                // Clean body text - check if there's a temporary edit
                let cleanBody = q.body || '';
                cleanBody = cleanBody.replace(/<b>/gi, '').replace(/<\/b>/gi, '');
                cleanBody = cleanBody.replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                
                const formattedBody = processMathInText(cleanBody);

                let opt = "";
                if (q.type !== 'normal' && q.showOptions !== false) {
                    if (q.type === 'cq') {
                        // Clean options
                        const cleanA = (q.a || '').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                        const cleanB = (q.b || '').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                        const cleanC = (q.c || '').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                        const cleanD = (q.d || '').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                        
                        const options = [
                            { label: labels[0], value: cleanA || '', mark: '‡ßß' },
                            { label: labels[1], value: cleanB || '', mark: '‡ß®' },
                            { label: labels[2], value: cleanC || '', mark: '‡ß©' },
                            { label: labels[3], value: cleanD || '', mark: '‡ß™' }
                        ];
                        
                        opt = `
                        <div style="margin-top:4px; margin-left: 18px; font-size: ${currentFontSize}px !important; line-height: ${currentLineHeight} !important;">
                            ${options.map(opt => `
                                <div class="sub-q" style="font-size: ${currentFontSize}px !important; line-height: ${currentLineHeight} !important; margin-bottom: 8px; display: flex; align-items: flex-start; justify-content: space-between;">
                                    <div style="display: flex; align-items: flex-start; flex: 1;">
                                        <span style="margin-right: 5px; flex-shrink: 0;">${opt.label}.</span>
                                        <div style="flex: 1; text-align: left;">${processMathInText(opt.value)}</div>
                                    </div>
                                    <span style="margin-left: 10px; flex-shrink: 0;">${opt.mark}</span>
                                </div>
                            `).join('')}
                        </div>`;
                    } else {
                        // MCQ options
                        const cleanA = (q.a || '').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                        const cleanB = (q.b || '').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                        const cleanC = (q.c || '').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                        const cleanD = (q.d || '').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                        
                        const options = [
                            { label: labels[0], value: cleanA || '' },
                            { label: labels[1], value: cleanB || '' },
                            { label: labels[2], value: cleanC || '' },
                            { label: labels[3], value: cleanD || '' }
                        ];
                        
                        opt = `
                        <div class="mcq-grid" style="font-size: ${currentFontSize}px !important; line-height: ${currentLineHeight} !important; margin-top: 8px;">
                            ${options.map(opt => `
                                <div style="display: flex; align-items: flex-start; text-align: left; margin-bottom: 4px;">
                                    <span style="margin-right: 5px; flex-shrink: 0;">${opt.label}.</span>
                                    <div style="flex: 1;">${processMathInText(opt.value)}</div>
                                </div>
                            `).join('')}
                        </div>`;
                    }
                }
                
                const questionHTML = `
                <div class="${q.type==='cq'?'cq-box':'normal-q'} ${getFontClassForElement(q.type)}" style="font-size: ${currentFontSize}px !important; line-height: ${currentLineHeight} !important; margin-bottom: ${document.getElementById('qGapSlider').value}px !important;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div style="display:flex; gap:4px; width: 100%;"><span style="font-size: ${currentFontSize}px !important; flex-shrink: 0;">${num}.</span> <div style="font-size: ${currentFontSize}px !important; flex: 1; text-align: left;">${formattedBody}</div></div>
                    </div>
                    ${img}${opt}
                </div>`;
                
                // Check if adding this question would exceed page limit
                if (questionsOnCurrentPage >= outputPerPage) {
                    // Save current page and start new one
                    pagesHTML += createPageHTML(currentPage, currentPageContent, questionsOnCurrentPage, 
                                               topMargin, rightMargin, bottomMargin, leftMargin, 
                                               currentFontSize, currentLineHeight, showPageNumbers);
                    currentPage++;
                    questionsOnCurrentPage = 0;
                    currentPageContent = '';
                    isFirstSubjectOnPage = true;
                    
                    // Add subject separator again for new page if this is the first question
                    if (questionIndex === 0 && showSubjectNames && !combineAllSubjects) {
                        currentPageContent += `<div class="subject-separator ${getFontClassForElement('header')}" style="font-size: ${currentFontSize}px !important; margin-bottom: 8px;">üìò ${subject}</div>`;
                        questionsOnCurrentPage++;
                        isFirstSubjectOnPage = false;
                    }
                }
                
                currentPageContent += questionHTML;
                questionsOnCurrentPage++;
            });
        });
        
        // Add the last page
        if (questionsOnCurrentPage > 0) {
            pagesHTML += createPageHTML(currentPage, currentPageContent, questionsOnCurrentPage, 
                                       topMargin, rightMargin, bottomMargin, leftMargin, 
                                       currentFontSize, currentLineHeight, showPageNumbers);
        }
        
        totalOutputPages = currentPage;
        
        // Set HTML to container
        document.getElementById('outputPagesContainer').innerHTML = pagesHTML;
        
        // Update answer grid with appropriate serial
        let answerGridHTML = '';
        let answerSerial = 1;
        
        if (combineAllSubjects) {
            // Combined mode: all questions in one sequence
            selected.forEach((q, index) => {
                const cleanAns = (q.ans || '...').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                answerGridHTML += `<div class="ans-box ${getFontClassForElement('answer')}" style="font-size: ${currentFontSize}px !important; line-height: ${currentLineHeight} !important; text-align: center;"><span>${formatNum(index + 1)}.</span> ${cleanAns}</div>`;
            });
        } else {
            // Subject-wise mode
            Object.keys(displayGrouping).forEach(subject => {
                const subjectQuestions = displayGrouping[subject].questions;
                
                // Add subject header to answer sheet if showing subject names
                if (showSubjectNames) {
                    answerGridHTML += `<div class="subject-separator ${getFontClassForElement('header')}" style="font-size: ${currentFontSize}px !important; margin: 10px 0 5px 0; text-align: center; background: #f5f5f5;">${subject}</div>`;
                }
                
                subjectQuestions.forEach((sq, index) => {
                    const q = sq.question;
                    const cleanAns = (q.ans || '...').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                    answerGridHTML += `<div class="ans-box ${getFontClassForElement('answer')}" style="font-size: ${currentFontSize}px !important; line-height: ${currentLineHeight} !important; text-align: center;"><span>${formatNum(sq.subjectSerial)}.</span> ${cleanAns}</div>`;
                    answerSerial++;
                });
            });
        }
        
        document.getElementById('ansGrid').innerHTML = answerGridHTML;
        
        // Update main header elements for first page
        updateHeaders();
        
        // Update pagination
        updateOutputPagination();
        
        // Make first page active
        document.querySelectorAll('.output-page').forEach((page, index) => {
            page.classList.remove('active');
            if (index === 0) page.classList.add('active');
        });
        
        outputCurrentPage = 1;
        
        // Apply font settings
        setTimeout(() => {
            applyFontToOutput();
            renderMathJax();
        }, 200);
    }
    
    function createPageHTML(pageNum, content, questionCount, topMargin, rightMargin, bottomMargin, leftMargin, fontSize, lineHeight, showPageNumbers) {
        // Page header content - ONLY FOR FIRST PAGE
        let pageHeader = '';
        if (pageNum === 1) {
            pageHeader = `
            <div id="outSetLine"></div>
            <div class="header ${getFontClassForElement('header')}"><h1 id="outH1"></h1><h2 id="outH2"></h2></div>
            <div id="outClassLine" class="header-info ${getFontClassForElement('header')}"></div>
            <div id="outSubjectLine" class="header-info ${getFontClassForElement('header')}" style="margin-bottom:8px;"></div>
            <div class="marks-info ${getFontClassForElement('header')}"><span id="outTime"></span><span id="outMarks"></span></div>
            <div id="outInst" class="instruction ${getFontClassForElement('header')}"></div>`;
        }
        
        // ‚úÖ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®: ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶™‡¶æ‡¶§‡¶æ ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶°‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá, ‡ß®‡ßü ‡¶™‡¶æ‡¶§‡¶æ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡ßß‡ß¶mm
        const pagePadding = pageNum === 1 
            ? `${topMargin}mm ${rightMargin}mm ${bottomMargin}mm ${leftMargin}mm`  // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶™‡¶æ‡¶§‡¶æ
            : `10mm ${rightMargin}mm ${bottomMargin}mm ${leftMargin}mm`; // ‡ß®‡ßü, ‡ß©‡ßü, ... ‡¶™‡¶æ‡¶§‡¶æ
        
        // Page footer with page number
        let pageFooter = '';
        if (showPageNumbers) {
            pageFooter = `<div class="page-number ${getFontClassForElement('header')}" style="font-size: 12px !important;">‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ${pageNum}/${totalOutputPages}</div>`;
        }
        
        return `
        <div id="output-page-${pageNum}" class="output-page ${pageNum === outputCurrentPage ? 'active' : ''}" 
             style="font-size: ${fontSize}px !important; padding: ${pagePadding} !important;">
            ${pageHeader}
            <div class="question-container ${getFontClassForElement('question')}" style="
                column-count: ${document.getElementById('colCount').value}; 
                font-size: ${fontSize}px !important; 
                line-height: ${lineHeight} !important; 
                column-gap: 35px;
                margin-top: ${pageNum === 1 ? '15px' : '0'};
            ">
                ${content}
            </div>
            ${pageFooter}
            ${pageNum < totalOutputPages ? '<div class="print-page-break" style="font-size: 12px !important;">--- ‡¶™‡ßá‡¶ú ‡¶¨‡ßç‡¶∞‡ßá‡¶ï ---</div>' : ''}
        </div>`;
    }
    
    // ==================== END RENDER OUTPUT PAGES ====================
    
    function getFontClassForElement(elementType) {
        if (!applyToHeaders && elementType === 'header') return '';
        if (!applyToQuestions && elementType === 'question') return '';
        if (!applyToOptions && (elementType === 'cq' || elementType === 'mcq')) return '';
        if (!applyToAnswerSheet && elementType === 'answer') return '';
        
        if (selectedFont === 'custom' && customFontFamily) {
            return 'font-custom';
        }
        return `font-${selectedFont}`;
    }
    
    function updateHeaders() {
        document.getElementById('outH1').innerText = document.getElementById('h1').value;
        document.getElementById('outH2').innerText = document.getElementById('h2').value;
        document.getElementById('outClassLine').innerText = document.getElementById('hClass').value ? "‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø: " + document.getElementById('hClass').value : "";
        document.getElementById('outSubjectLine').innerText = document.getElementById('h3').value ? "‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º: " + document.getElementById('h3').value : "";
        document.getElementById('outTime').innerText = document.getElementById('hTime').value ? "‡¶∏‡¶Æ‡¶Ø‡¶º: " + document.getElementById('hTime').value : "";
        document.getElementById('outMarks').innerText = document.getElementById('hMarks').value ? "‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶Æ‡¶æ‡¶®: " + document.getElementById('hMarks').value : "";
        document.getElementById('outInst').innerText = document.getElementById('hInst').value;
        const setVal = document.getElementById('hSet').value, outSet = document.getElementById('outSetLine');
        if(setVal) { outSet.innerText = "‡¶∏‡ßá‡¶ü: " + setVal; outSet.style.display = "block"; } else { outSet.style.display = "none"; }
        document.getElementById('outH1').style.fontSize = document.getElementById('fsH1').value + "px";
        document.getElementById('outH2').style.fontSize = document.getElementById('fsH2').value + "px";
        document.getElementById('outClassLine').style.fontSize = document.getElementById('fsH3').value + "px";
        document.getElementById('outSubjectLine').style.fontSize = document.getElementById('fsH3').value + "px";
        document.getElementById('outInst').style.fontSize = document.getElementById('fsH4').value + "px";
    }
    
    function processMathInText(text) {
        if (!text) return '';
        
        // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶∏‡¶¨ ‡¶¨‡ßã‡¶≤‡ßç‡¶° ‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó ‡¶∏‡¶∞‡¶ø‡ßü‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®
        let processed = text.replace(/<b>/gi, '').replace(/<\/b>/gi, '');
        processed = processed.replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
        
        processed = processed.replace(/\n/g, '<br>');
        
        processed = processed.replace(/\$\$(.*?)\$\$/g, function(match, equation) {
            return `<div class="equation-container">\\[${equation}\\]</div>`;
        });
        
        processed = processed.replace(/\$(.*?)\$/g, '\\($1\\)');
        
        processed = processed.replace(/\\\[/g, '\\[').replace(/\\\]/g, '\\]');
        
        if (text.includes('‡¶ï:') || text.includes('‡¶ñ:') || text.includes('‡¶ó:') || text.includes('‡¶ò:')) {
            processed = processed.replace(/(‡¶ï|‡¶ñ|‡¶ó|‡¶ò):/g, '<div class="mcq-option-equation"><span>$1:</span> ');
            processed = processed + '</div>';
        }
        
        return processed;
    }
    
    function renderMathJax() {
        if (window.MathJax && window.MathJax.typesetPromise) {
            MathJax.typesetPromise().catch(err => console.log('MathJax typeset error:', err));
        } else if (window.MathJax && window.MathJax.Hub) {
            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
        }
    }
    
    function formatNum(n) { 
        return document.getElementById('qLang').value === 'bn' ? 
            n.toString().split('').map(d => '‡ß¶‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ‡ßØ'[d] || d).join('') : n; 
    }
    
    function sync() {
        document.getElementById('ansSheetArea').style.display = document.getElementById('showAnsKey').checked ? "block" : "none";
        
        // Also update subject limits display if needed
        const selectedCount = questionBank.filter(q => q.selected).length;
        if (selectedCount > 0) {
            setTimeout(() => {
                updateSubjectLimitsFromSelected();
            }, 100);
        }
        
        setTimeout(() => {
            renderOutputPages();
            applyFontToOutput();
        }, 100);
        saveData();
    }
    
    function saveData() {
        const d = { 
            sets: [document.getElementById('h1').value, document.getElementById('h2').value, document.getElementById('hClass').value, document.getElementById('h3').value, document.getElementById('hTime').value, document.getElementById('hMarks').value, document.getElementById('hInst').value, document.getElementById('targetCount').value, document.getElementById('hSet').value],
            hSizes: [document.getElementById('fsH1').value, document.getElementById('fsH2').value, document.getElementById('fsH3').value, document.getElementById('fsH4').value],
            margins: [document.getElementById('mTop').value, document.getElementById('mBottom').value, document.getElementById('mLeft').value, document.getElementById('mRight').value],
            fSize: document.getElementById('fSize').value, 
            lHeight: document.getElementById('lHeight').value, 
            cols: document.getElementById('colCount').value, 
            lang: document.getElementById('qLang').value, 
            qs: questionBank,
            restrictedList: document.getElementById('lockBox').value,
            selectionPerPage: document.getElementById('selectionPerPage').value,
            outputPerPage: document.getElementById('outputPerPage').value,
            showPageNumbers: document.getElementById('showPageNumbers').checked,
            showOutputPagination: document.getElementById('showOutputPagination').checked,
            qGap: document.getElementById('qGapSlider').value,
            monthlyExamName: document.getElementById('monthlyExamName').value,
            subjectLimits: subjectLimits,
            enableSubjectLimits: document.getElementById('enableSubjectLimits').checked,
            showSubjectNames: document.getElementById('showSubjectNames').checked,
            combineAllSubjects: document.getElementById('combineAllSubjects').checked,
            fontSettings: {
                selectedFont: selectedFont,
                selectedFontName: selectedFontName,
                customFontFamily: customFontFamily,
                questionFontSize: document.getElementById('questionFontSize').value,
                applyToQuestions: document.getElementById('applyToQuestions').checked,
                applyToOptions: document.getElementById('applyToOptions').checked,
                applyToHeaders: document.getElementById('applyToHeaders').checked,
                applyToAnswerSheet: document.getElementById('applyToAnswerSheet').checked
            }
        };
        localStorage.setItem(DB_KEY, JSON.stringify(d));
    }
    
    function loadData() {
        const d = JSON.parse(localStorage.getItem(DB_KEY) || '{}');
        if(d.qs) {
            document.getElementById('h1').value = d.sets[0] || "‡¶∂‡ßá‡¶∞‡¶ñ‡¶æ‡¶≤‡ßÄ ‡¶∏‡¶∞‡¶ï‡¶æ‡¶∞‡¶ø ‡¶Æ‡¶π‡¶ø‡¶≤‡¶æ ‡¶ï‡¶≤‡ßá‡¶ú"; 
            document.getElementById('h2').value = d.sets[1] || "‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ-‡ß®‡ß¶‡ß®‡ß¨"; 
            document.getElementById('hClass').value = d.sets[2] || "";
            document.getElementById('h3').value = d.sets[3] || "";
            document.getElementById('targetCount').value = d.sets[7] || 10; 
            document.getElementById('hSet').value = d.sets[8] || "";
            document.getElementById('fsH1').value = d.hSizes[0] || 20;
            document.getElementById('fsH2').value = d.hSizes[1] || 16;
            document.getElementById('fsH3').value = d.hSizes[2] || 13;
            document.getElementById('fsH4').value = d.hSizes[3] || 13;
            document.getElementById('lockBox').value = d.restrictedList || "";
            questionBank = d.qs;
            
            // Load monthly exam name
            if (d.monthlyExamName) {
                document.getElementById('monthlyExamName').value = d.monthlyExamName;
            }
            
            // Load margin values
            if (d.margins && d.margins.length >= 4) {
                document.getElementById('mTop').value = d.margins[0] || '12';
                document.getElementById('mBottom').value = d.margins[1] || '12';
                document.getElementById('mLeft').value = d.margins[2] || '15';
                document.getElementById('mRight').value = d.margins[3] || '15';
            }
            
            if (d.selectionPerPage) {
                document.getElementById('selectionPerPage').value = d.selectionPerPage;
            }
            if (d.outputPerPage) {
                document.getElementById('outputPerPage').value = d.outputPerPage;
            }
            if (d.showPageNumbers !== undefined) {
                document.getElementById('showPageNumbers').checked = d.showPageNumbers;
            }
            if (d.showOutputPagination !== undefined) {
                document.getElementById('showOutputPagination').checked = d.showOutputPagination;
            }
            
            if (d.qGap) {
                document.getElementById('qGapSlider').value = d.qGap;
            }
            
            // Load subject limits
            if (d.subjectLimits) {
                subjectLimits = d.subjectLimits;
            }
            if (d.enableSubjectLimits !== undefined) {
                document.getElementById('enableSubjectLimits').checked = d.enableSubjectLimits;
            }
            
            // Load monthly exam settings
            if (d.showSubjectNames !== undefined) {
                document.getElementById('showSubjectNames').checked = d.showSubjectNames;
                showSubjectNames = d.showSubjectNames;
            }
            if (d.combineAllSubjects !== undefined) {
                document.getElementById('combineAllSubjects').checked = d.combineAllSubjects;
                combineAllSubjects = d.combineAllSubjects;
            }
            
            // Load font settings
            if (d.fontSettings) {
                selectedFont = d.fontSettings.selectedFont || 'kalpurush';
                selectedFontName = d.fontSettings.selectedFontName || '‡¶ï‡¶≤‡¶™‡ßÅ‡¶∞‡ßÅ‡¶∑';
                customFontFamily = d.fontSettings.customFontFamily || '';
                questionFontSize = d.fontSettings.questionFontSize || '13';
                
                // Update UI elements
                document.getElementById('questionFontSize').value = questionFontSize;
                document.getElementById('questionFontSizeValue').textContent = questionFontSize + 'px';
                
                if (d.fontSettings.applyToQuestions !== undefined) {
                    document.getElementById('applyToQuestions').checked = d.fontSettings.applyToQuestions;
                }
                if (d.fontSettings.applyToOptions !== undefined) {
                    document.getElementById('applyToOptions').checked = d.fontSettings.applyToOptions;
                }
                if (d.fontSettings.applyToHeaders !== undefined) {
                    document.getElementById('applyToHeaders').checked = d.fontSettings.applyToHeaders;
                }
                if (d.fontSettings.applyToAnswerSheet !== undefined) {
                    document.getElementById('applyToAnswerSheet').checked = d.fontSettings.applyToAnswerSheet;
                }
                
                // Update font selection UI
                document.querySelectorAll('.font-option').forEach(option => {
                    option.classList.remove('selected');
                    if (option.classList.contains(`font-${selectedFont}`)) {
                        option.classList.add('selected');
                    }
                });
                
                // Update custom font input
                if (selectedFont === 'custom' && customFontFamily) {
                    document.getElementById('customFontName').value = customFontFamily;
                }
                
                // Update apply variables
                applyToQuestions = document.getElementById('applyToQuestions').checked;
                applyToOptions = document.getElementById('applyToOptions').checked;
                applyToHeaders = document.getElementById('applyToHeaders').checked;
                applyToAnswerSheet = document.getElementById('applyToAnswerSheet').checked;
                
                // Update font preview
                updateFontPreview();
            }
            
            // Update slider value displays
            updateSliderValue('fsH1', document.getElementById('fsH1').value + 'px');
            updateSliderValue('fsH2', document.getElementById('fsH2').value + 'px');
            updateSliderValue('fsH3', document.getElementById('fsH3').value + 'px');
            updateSliderValue('fsH4', document.getElementById('fsH4').value + 'px');
            updateSliderValue('qGapSlider', document.getElementById('qGapSlider').value + 'px');
            updateSliderValue('fSize', document.getElementById('fSize').value + 'px');
            updateSliderValue('lHeight', document.getElementById('lHeight').value);
            updateSliderValue('mTop', document.getElementById('mTop').value + 'mm');
            updateSliderValue('mBottom', document.getElementById('mBottom').value + 'mm');
            updateSliderValue('mLeft', document.getElementById('mLeft').value + 'mm');
            updateSliderValue('mRight', document.getElementById('mRight').value + 'mm');
            updateSliderValue('questionFontSize', document.getElementById('questionFontSize').value + 'px');
        }
        
        updateSubFilter(); 
        updateChapterFilter(); 
        updateQuestionCount();
        sync(); 
        renderSelectionList();
    }
    
    // ==================== FONT FUNCTIONS ====================
    
    function selectFont(fontId, fontName) {
        // Remove selected class from all font options
        document.querySelectorAll('.font-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        // Add selected class to clicked option
        const clickedOption = event.target.closest('.font-option');
        if (clickedOption) {
            clickedOption.classList.add('selected');
        }
        
        // Update selected font
        selectedFont = fontId;
        selectedFontName = fontName;
        customFontFamily = '';
        
        // Clear custom font input
        document.getElementById('customFontName').value = '';
        
        // Update font preview
        updateFontPreview();
        
        // Apply font to output
        applyFontToOutput();
        
        // Save to localStorage
        saveData();
    }
    
    function applyCustomFont() {
        const customFontInput = document.getElementById('customFontName').value.trim();
        
        if (!customFontInput) {
            alert('‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶´‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!');
            return;
        }
        
        // Remove selected class from all font options
        document.querySelectorAll('.font-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        // Set custom font
        selectedFont = 'custom';
        selectedFontName = '‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶´‡¶®‡ßç‡¶ü';
        customFontFamily = customFontInput;
        
        // Update font preview
        updateFontPreview();
        
        // Apply font to output
        applyFontToOutput();
        
        // Save to localStorage
        saveData();
        
        alert('‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶´‡¶®‡ßç‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
    }
    
    function updateFontPreview() {
        const fontPreview = document.getElementById('fontPreview');
        const fontSize = document.getElementById('questionFontSize').value + 'px';
        
        // Clear existing classes
        fontPreview.className = 'font-preview';
        
        // Add appropriate font class
        if (selectedFont === 'custom' && customFontFamily) {
            fontPreview.style.fontFamily = customFontFamily;
            fontPreview.classList.add('font-custom');
        } else {
            fontPreview.style.fontFamily = '';
            fontPreview.classList.add(`font-${selectedFont}`);
        }
        
        // Update font size
        fontPreview.style.fontSize = fontSize;
        
        // Update preview text
        let previewText = '';
        switch(selectedFont) {
            case 'kalpurush':
                previewText = '‡¶ï‡¶≤‡¶™‡ßÅ‡¶∞‡ßÅ‡¶∑ ‡¶´‡¶®‡ßç‡¶ü: ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶ü‡¶æ‡¶á‡¶™‡¶ø‡¶Ç ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ú‡¶®‡¶™‡ßç‡¶∞‡¶ø‡ßü ‡¶´‡¶®‡ßç‡¶ü‡•§ ‡ßß‡ß®‡ß©‡ß™ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶è‡¶¨‡¶Ç English text.';
                break;
            case 'solaimanlipi':
                previewText = '‡¶∏‡ßã‡¶≤‡¶æ‡¶á‡¶Æ‡¶æ‡¶®‡¶≤‡¶ø‡¶™‡¶ø ‡¶´‡¶®‡ßç‡¶ü: ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶™‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§‡•§ ‡ßß‡ß®‡ß©‡ß™ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶è‡¶¨‡¶Ç English text.';
                break;
            case 'siyamrupali':
                previewText = '‡¶∏‡¶ø‡ßü‡¶æ‡¶Æ‡¶∞‡ßÅ‡¶™‡¶æ‡¶≤‡¶ø ‡¶´‡¶®‡ßç‡¶ü: ‡¶ì‡ßü‡ßá‡¶¨‡ßá ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶â‡¶™‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡•§ ‡ßß‡ß®‡ß©‡ß™ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶è‡¶¨‡¶Ç English text.';
                break;
            case 'notosans':
                previewText = '‡¶®‡ßã‡¶ü‡ßã ‡¶∏‡¶æ‡¶®‡ßç‡¶∏ ‡¶´‡¶®‡ßç‡¶ü: Google-‡¶è‡¶∞ ‡¶Ü‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶´‡¶®‡ßç‡¶ü‡•§ ‡ßß‡ß®‡ß©‡ß™ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶è‡¶¨‡¶Ç English text.';
                break;
            case 'roboto':
                previewText = '‡¶∞‡ßã‡¶¨‡ßã‡¶ü‡ßã ‡¶´‡¶®‡ßç‡¶ü: ‡¶Ü‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï ‡¶è‡¶¨‡¶Ç ‡¶™‡ßú‡¶§‡ßá ‡¶∏‡¶π‡¶ú‡•§ ‡ßß‡ß®‡ß©‡ß™ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶è‡¶¨‡¶Ç English text.';
                break;
            case 'times':
                previewText = '‡¶ü‡¶æ‡¶á‡¶Æ‡¶∏ ‡¶®‡¶ø‡¶â ‡¶∞‡ßã‡¶Æ‡¶æ‡¶® ‡¶´‡¶®‡ßç‡¶ü: ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡¶ø‡¶ï ‡¶è‡¶¨‡¶Ç ‡¶´‡¶∞‡¶Æ‡¶æ‡¶≤‡•§ ‡ßß‡ß®‡ß©‡ß™ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶è‡¶¨‡¶Ç English text.';
                break;
            case 'arial':
                previewText = '‡¶è‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶´‡¶®‡ßç‡¶ü: ‡¶∏‡¶π‡¶ú‡¶™‡¶æ‡¶†‡ßç‡¶Ø ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶æ‡¶∞‡ßç‡¶¨‡¶ú‡¶®‡ßÄ‡¶®‡•§ ‡ßß‡ß®‡ß©‡ß™ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶è‡¶¨‡¶Ç English text.';
                break;
            case 'custom':
                previewText = `‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶´‡¶®‡ßç‡¶ü: ${customFontFamily}. ‡ßß‡ß®‡ß©‡ß™ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶è‡¶¨‡¶Ç English text.`;
                break;
            default:
                previewText = '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶´‡¶®‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â: ‡¶Ö‡¶≠‡ßç‡¶∞ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® ‡¶∏‡¶π‡¶ú‡ßá‡¶á‡•§ ‡ßß‡ß®‡ß©‡ß™ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶è‡¶¨‡¶Ç English text.';
        }
        
        fontPreview.textContent = previewText;
    }
    
    function applyFontToOutput() {
        // Get settings
        const fontSize = document.getElementById('questionFontSize').value + 'px';
        applyToQuestions = document.getElementById('applyToQuestions').checked;
        applyToOptions = document.getElementById('applyToOptions').checked;
        applyToHeaders = document.getElementById('applyToHeaders').checked;
        applyToAnswerSheet = document.getElementById('applyToAnswerSheet').checked;
        
        // Determine font family
        let fontFamily = '';
        if (selectedFont === 'custom' && customFontFamily) {
            fontFamily = customFontFamily;
        } else {
            // Get CSS class for selected font
            switch(selectedFont) {
                case 'kalpurush':
                    fontFamily = "'Kalpurush', 'Siyam Rupali', Arial, sans-serif";
                    break;
                case 'solaimanlipi':
                    fontFamily = "'SolaimanLipi', 'Siyam Rupali', Arial, sans-serif";
                    break;
                case 'siyamrupali':
                    fontFamily = "'Siyam Rupali', Arial, sans-serif";
                    break;
                case 'notosans':
                    fontFamily = "'Noto Sans Bengali', 'Kalpurush', Arial, sans-serif";
                    break;
                case 'roboto':
                    fontFamily = "'Roboto', 'SolaimanLipi', Arial, sans-serif";
                    break;
                case 'times':
                    fontFamily = "'Times New Roman', Times, serif";
                    break;
                case 'arial':
                    fontFamily = "Arial, sans-serif";
                    break;
                default:
                    fontFamily = "'Kalpurush', 'Siyam Rupali', Arial, sans-serif";
            }
        }
        
        // Apply font class to output pages
        const outputPages = document.querySelectorAll('.output-page');
        outputPages.forEach(page => {
            // Remove all font classes first
            page.classList.remove('font-kalpurush', 'font-solaimanlipi', 'font-siyamrupali', 
                                 'font-notosans', 'font-roboto', 'font-times', 'font-arial', 'font-custom');
            
            // Add appropriate font class
            if (selectedFont === 'custom' && customFontFamily) {
                page.classList.add('font-custom');
                page.style.fontFamily = fontFamily;
            } else {
                page.classList.add(`font-${selectedFont}`);
                page.style.fontFamily = '';
            }
        });
        
        // Apply to answer sheet
        const answerSheet = document.getElementById('ansSheetArea');
        if (answerSheet) {
            answerSheet.classList.remove('font-kalpurush', 'font-solaimanlipi', 'font-siyamrupali', 
                                      'font-notosans', 'font-roboto', 'font-times', 'font-arial', 'font-custom');
            
            if (selectedFont === 'custom' && customFontFamily) {
                answerSheet.classList.add('font-custom');
                answerSheet.style.fontFamily = fontFamily;
            } else {
                answerSheet.classList.add(`font-${selectedFont}`);
                answerSheet.style.fontFamily = '';
            }
        }
        
        // Apply to individual elements based on settings
        applyFontToElements();
        
        // Update MathJax rendering
        setTimeout(renderMathJax, 100);
    }
    
    function applyFontToElements() {
        // Get current font class
        const fontClass = selectedFont === 'custom' ? 'font-custom' : `font-${selectedFont}`;
        
        // Apply to headers if enabled
        if (applyToHeaders) {
            const headerElements = document.querySelectorAll('.header, .header-info, .marks-info, .instruction, .subject-separator, .page-number');
            headerElements.forEach(el => {
                el.classList.remove('font-kalpurush', 'font-solaimanlipi', 'font-siyamrupali', 
                                  'font-notosans', 'font-roboto', 'font-times', 'font-arial', 'font-custom');
                el.classList.add(fontClass);
            });
        }
        
        // Apply to questions if enabled
        if (applyToQuestions) {
            const questionElements = document.querySelectorAll('.cq-box, .normal-q, .question-container');
            questionElements.forEach(el => {
                el.classList.remove('font-kalpurush', 'font-solaimanlipi', 'font-siyamrupali', 
                                  'font-notosans', 'font-roboto', 'font-times', 'font-arial', 'font-custom');
                el.classList.add(fontClass);
            });
        }
        
        // Apply to options if enabled
        if (applyToOptions) {
            const optionElements = document.querySelectorAll('.mcq-grid, .sub-q, .q-card-options');
            optionElements.forEach(el => {
                el.classList.remove('font-kalpurush', 'font-solaimanlipi', 'font-siyamrupali', 
                                  'font-notosans', 'font-roboto', 'font-times', 'font-arial', 'font-custom');
                el.classList.add(fontClass);
            });
        }
        
        // Apply to answer sheet if enabled
        if (applyToAnswerSheet) {
            const answerElements = document.querySelectorAll('.ans-box, .ans-grid');
            answerElements.forEach(el => {
                el.classList.remove('font-kalpurush', 'font-solaimanlipi', 'font-siyamrupali', 
                                  'font-notosans', 'font-roboto', 'font-times', 'font-arial', 'font-custom');
                el.classList.add(fontClass);
            });
        }
        
        // Also apply to selection list
        const qCards = document.querySelectorAll('.q-card');
        qCards.forEach(card => {
            card.classList.remove('font-kalpurush', 'font-solaimanlipi', 'font-siyamrupali', 
                               'font-notosans', 'font-roboto', 'font-times', 'font-arial', 'font-custom');
            card.classList.add(fontClass);
        });
    }
    
    function resetFontSettings() {
        if (confirm('‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü‡ßá ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
            // Reset to default values
            selectedFont = 'kalpurush';
            selectedFontName = '‡¶ï‡¶≤‡¶™‡ßÅ‡¶∞‡ßÅ‡¶∑';
            customFontFamily = '';
            questionFontSize = '13';
            
            // Update UI
            document.getElementById('questionFontSize').value = questionFontSize;
            document.getElementById('questionFontSizeValue').textContent = questionFontSize + 'px';
            document.getElementById('customFontName').value = '';
            document.getElementById('applyToQuestions').checked = true;
            document.getElementById('applyToOptions').checked = true;
            document.getElementById('applyToHeaders').checked = true;
            document.getElementById('applyToAnswerSheet').checked = true;
            
            // Update font selection
            document.querySelectorAll('.font-option').forEach(option => {
                option.classList.remove('selected');
                if (option.classList.contains('font-kalpurush')) {
                    option.classList.add('selected');
                }
            });
            
            // Update preview
            updateFontPreview();
            
            // Apply to output
            applyFontToOutput();
            
            // Save settings
            saveData();
            
            alert('‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
        }
    }
    
    // ==================== SELECTION LIST FUNCTIONS ====================

    function renderSelectionList() {
        document.getElementById('selectionList').style.textAlign = 'left';
        
        const isAdmin = document.getElementById('adminToggle').checked;
        const subF = document.getElementById('fSub').value;
        const classF = document.getElementById('fClass').value;
        const divF = document.getElementById('fDiv').value;
        const typeF = document.getElementById('fType').value;
        const chapF = document.getElementById('fChap').value;
        
        let filtered = questionBank.map((q, i) => ({...q, originalIndex: i})).filter(q => {
            return (!subF || q.sub === subF) && 
                   (!classF || q.qClass === classF) && 
                   (!divF || q.qDiv === divF) && 
                   (!typeF || q.type === typeF) &&
                   (!chapF || q.chap === chapF);
        });
        
        const chapterGroups = {};
        filtered.forEach(q => {
            const chapter = q.chap || '‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü‡¶π‡ßÄ‡¶®';
            if (!chapterGroups[chapter]) {
                chapterGroups[chapter] = [];
            }
            chapterGroups[chapter].push(q);
        });
        
        selectionPerPage = parseInt(document.getElementById('selectionPerPage').value) || 10;
        totalSelectionPages = Math.ceil(filtered.length / selectionPerPage);
        if (totalSelectionPages < 1) totalSelectionPages = 1;
        if (selectionCurrentPage > totalSelectionPages) selectionCurrentPage = totalSelectionPages;
        
        const startIndex = (selectionCurrentPage - 1) * selectionPerPage;
        const endIndex = startIndex + selectionPerPage;
        const pagedQuestions = filtered.slice(startIndex, endIndex);
        
        const chapterCounters = {};
        
        // ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        function toBengaliNumber(num) {
            if (!num && num !== 0) return '';
            const bengaliDigits = ['‡ß¶', '‡ßß', '‡ß®', '‡ß©', '‡ß™', '‡ß´', '‡ß¨', '‡ß≠', '‡ßÆ', '‡ßØ'];
            return num.toString().replace(/\d/g, function(match) {
                return bengaliDigits[match];
            });
        }
        
        let outputHTML = '';
        let currentChapter = null;
        
        pagedQuestions.forEach((q, localIndex) => {
            const chapter = q.chap || '‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü‡¶π‡ßÄ‡¶®';
            
            if (chapter !== currentChapter) {
                currentChapter = chapter;
                
                const totalInChapter = filtered.filter(item => item.chap === chapter).length;
                const bengaliTotal = toBengaliNumber(totalInChapter);
                
                outputHTML += `
                    <div class="chapter-header ${getFontClassForElement('header')}">
                        <div style="text-align: left;">
                            <strong>üìö ${chapter}</strong>
                            <small style="display: block;">‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®: ${bengaliTotal}‡¶ü‡¶ø</small>
                        </div>
                        <div style="text-align: left;">
                            <small>${q.sub} | ${q.type === 'cq' ? '‡¶∏‡ßÉ‡¶ú‡¶®‡¶∂‡ßÄ‡¶≤' : q.type === 'mcq' ? 'MCQ' : '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£'}</small>
                        </div>
                    </div>
                `;
            }
            
            chapterCounters[chapter] = (chapterCounters[chapter] || 0) + 1;
            const chapterSerialNumber = chapterCounters[chapter];
            const bengaliSerial = toBengaliNumber(chapterSerialNumber);
            
            let optHtml = "";
            if (q.type !== 'normal') {
                const options = [
                    { label: '‡¶ï', value: q.a || '-' },
                    { label: '‡¶ñ', value: q.b || '-' },
                    { label: '‡¶ó', value: q.c || '-' },
                    { label: '‡¶ò', value: q.d || '-' }
                ];
                
                optHtml = `
                    <div class="q-card-options ${getFontClassForElement(q.type)}">
                        ${options.map(opt => `
                            <div style="text-align: left; padding-left: 0; margin-bottom: 8px; display: flex; align-items: flex-start; flex-direction: column;">
                                <div style="display: flex; align-items: flex-start; width: 100%;">
                                    <b style="margin-right: 8px; flex-shrink: 0;">${opt.label}:</b>
                                    <div style="flex: 1; text-align: left;">${processMathInText(opt.value)}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
            }
            
            // Check if this question is in search results
            const isSearchResult = searchResults.includes(q.originalIndex);
            const searchResultIndex = searchResults.indexOf(q.originalIndex) + 1;
            const isActiveSearchResult = isSearchActive && isSearchResult && searchResultIndex === currentSearchIndex + 1;
            
            outputHTML += `
            <div class="q-card ${getFontClassForElement('question')} ${isActiveSearchResult ? 'search-navigation-active' : ''}" onclick="toggleQ(${q.originalIndex})" style="border-left: ${q.selected ? '6px solid var(--primary)' : '1px solid #eee'}">
                ${isSearchResult ? `<div class="search-result-badge">${searchResultIndex}</div>` : ''}
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="chapter-serial-circle">
                            ${bengaliSerial}
                        </div>
                        <div style="text-align: left; font-size: 12px; color: #555;">
                            <span style="font-weight: bold;">${q.sub}</span> 
                            ${q.qClass ? `| ${q.qClass}` : ''}
                        </div>
                    </div>
                    ${q.board ? `<div class="board-tag" style="color: #d32f2f; font-weight: bold; font-size: 11px; background: #ffebee; padding: 2px 8px; border-radius: 3px; border: 1px solid #ffcdd2;">${q.board}</div>` : ''}
                </div>
                
                <div class="q-card-body ${getFontClassForElement('question')}" style="text-align: left; padding-left: 0; margin-left: 0; padding-right: 0;">
                    <div style="display: flex; align-items: flex-start; gap: 4px; text-align: left;">
                        <b style="flex-shrink: 0;">${bengaliSerial}.</b>
                        <div style="text-align: left; width: 100%;">${processMathInText(q.body)}</div>
                    </div>
                </div>
                ${optHtml}
                
                <div style="margin-top:10px; display: ${isAdmin ? 'flex' : 'none'}; gap: 5px; text-align: left;">
                    <button class="btn-mini" style="background:#1976d2; flex:1;" onclick="editQuestion(${q.originalIndex}, event)">üìù Edit</button>
                    <button class="btn-mini" style="background:#d32f2f; flex:1;" onclick="deleteQuestion(${q.originalIndex}, event)">üóëÔ∏è Delete</button>
                </div>
            </div>`;
        });
        
        if (outputHTML === '') {
            outputHTML = '<p style="text-align:center; color:#666; padding:20px;">‡¶ï‡ßã‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>';
        }
        
        document.getElementById('selectionList').innerHTML = outputHTML;
        
        updateSelectionPagination();
        
        sync();
        renderOutputPages();
        updateCounter();
        
        setTimeout(renderMathJax, 100);
    }
    
    function updateSelectionPagination() {
        const paginationDiv = document.getElementById('selectionPagination');
        if (totalSelectionPages > 1) {
            paginationDiv.style.display = 'flex';
        } else {
            paginationDiv.style.display = 'none';
        }
        
        document.getElementById('selectionPageInfo').innerText = `‡¶™‡ßá‡¶ú ${selectionCurrentPage}/${totalSelectionPages}`;
        document.getElementById('selectionPrevBtn').disabled = selectionCurrentPage === 1;
        document.getElementById('selectionNextBtn').disabled = selectionCurrentPage === totalSelectionPages;
    }
    
    function changeSelectionPage(delta) {
        selectionCurrentPage += delta;
        if (selectionCurrentPage < 1) selectionCurrentPage = 1;
        if (selectionCurrentPage > totalSelectionPages) selectionCurrentPage = totalSelectionPages;
        
        renderSelectionList();
    }
    
    function toggleQ(i) { 
        questionBank[i].selected = !questionBank[i].selected; 
        saveData(); 
        renderSelectionList();
    }
    
    // ==================== COUNTER FUNCTIONS ====================
    
    function updateCounter() {
        const selected = questionBank.filter(q => q.selected).length;
        const target = parseInt(document.getElementById('targetCount').value) || 0;
        document.getElementById('liveCount').innerText = selected;
        let percent = target > 0 ? (selected / target) * 100 : 0;
        const bar = document.getElementById('fillBar');
        const status = document.getElementById('counterStatus');
        bar.style.width = (percent > 100 ? 100 : percent) + "%";
        if(selected < target) { 
            status.innerText = `‡¶Ü‡¶∞‡¶ì ${target - selected}‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá`; 
            bar.style.background = "#ffeb3b"; 
        } 
        else if(selected == target) { 
            status.innerText = "‚úÖ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!"; 
            bar.style.background = "#4caf50"; 
        } 
        else { 
            status.innerText = `‚ö†Ô∏è ${selected - target}‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¨‡ßá‡¶∂‡¶ø!`; 
            bar.style.background = "#f44336"; 
        }
    }
    
    // ==================== QUESTION BANK FUNCTIONS ====================
    
    function addQuestion() {
        const editIdx = parseInt(document.getElementById('editIndex').value);
        const q = getQuestionFromForm();
        
        if(editIdx > -1) { 
            q.selected = questionBank[editIdx].selected;
            questionBank[editIdx] = q; 
            cancelEdit(); 
        }
        
        saveData(); 
        updateSubFilter(); 
        updateChapterFilter(); 
        updateQuestionCount();
        selectionCurrentPage = 1;
        renderSelectionList(); 
        alert("‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
    }
    
    function getQuestionFromForm() {
        return { 
            sub: document.getElementById('qSub').value.trim(), 
            qClass: document.getElementById('qClassInput').value,
            qDiv: document.getElementById('qDivInput').value,
            chap: document.getElementById('qChap').value.trim(), 
            type: document.getElementById('qType').value, 
            body: document.getElementById('qBody').value.trim(), 
            ans: document.getElementById('qAns').value.trim(), 
            board: document.getElementById('qBoard').value.trim(), 
            a: document.getElementById('qA').value.trim(), 
            b: document.getElementById('qB').value.trim(), 
            c: document.getElementById('qC').value.trim(), 
            d: document.getElementById('qD').value.trim(), 
            img: currentImgData, 
            selected: false,
            showOptions: document.getElementById('showOptionsToggle').checked
        };
    }
    
    function editQuestion(idx, e) {
        e.stopPropagation();
        const q = questionBank[idx];
        document.getElementById('editIndex').value = idx;
        document.getElementById('qSub').value = q.sub;
        document.getElementById('qClassInput').value = q.qClass || "";
        document.getElementById('qDivInput').value = q.qDiv || "";
        document.getElementById('qChap').value = q.chap || "";
        document.getElementById('qType').value = q.type;
        document.getElementById('qBody').value = q.body;
        document.getElementById('qA').value = q.a || "";
        document.getElementById('qB').value = q.b || "";
        document.getElementById('qC').value = q.c || "";
        document.getElementById('qD').value = q.d || "";
        document.getElementById('qAns').value = q.ans || "";
        document.getElementById('qBoard').value = q.board || "";
        document.getElementById('showOptionsToggle').checked = q.showOptions !== false;
        currentImgData = q.img || "";
        document.getElementById('imgPreview').innerHTML = currentImgData ? `<img src="${currentImgData}" style="width:100px;">` : "";
        
        toggleFields();
        document.getElementById('saveBtn').innerText = "‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®";
        document.getElementById('cancelBtn').style.display = "block";
        openTab('bank');
    }
    
    function deleteQuestion(idx, e) {
        e.stopPropagation();
        if(confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            questionBank.splice(idx, 1);
            saveData(); 
            updateSubFilter(); 
            updateChapterFilter(); 
            updateQuestionCount();
            selectionCurrentPage = 1;
            renderSelectionList();
        }
    }
    
    function cancelEdit() {
        document.getElementById('editIndex').value = "-1";
        document.getElementById('saveBtn').innerText = "‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®";
        document.getElementById('cancelBtn').style.display = "none";
        document.querySelectorAll('#bank input, #bank textarea, #bank select').forEach(i => i.value = "");
        document.getElementById('imgPreview').innerHTML = "";
        currentImgData = "";
        document.getElementById('duplicateStatus').style.display = 'none';
        document.getElementById('saveBtn').style.background = 'var(--primary)';
    }
    
    // ==================== FILTER FUNCTIONS ====================
    
    function updateSubFilter() {
        const fSub = document.getElementById('fSub');
        const lockText = document.getElementById('lockBox').value.trim();
        const isAdmin = document.getElementById('adminToggle').checked;
        let subs = [...new Set(questionBank.map(q => q.sub))];
        if (lockText !== "" && !isAdmin) {
            let allowed = lockText.split(',').map(s => s.trim().toLowerCase());
            subs = subs.filter(s => allowed.includes(s.toLowerCase()));
        }
        fSub.innerHTML = '<option value="">‡¶∏‡¶¨ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º</option>' + subs.map(s => `<option value="${s}">${s}</option>`).join('');
    }
    
    function updateChapterFilter() {
        const subF = document.getElementById('fSub').value;
        const fChap = document.getElementById('fChap');
        let chapters = [];
        if(subF) {
            chapters = [...new Set(questionBank.filter(q => q.sub === subF).map(q => q.chap))];
        } else {
            chapters = [...new Set(questionBank.map(q => q.chap))];
        }
        fChap.innerHTML = '<option value="">‡¶∏‡¶¨ ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º</option>' + chapters.filter(c => c).map(c => `<option value="${c}">${c}</option>`).join('');
    }
    
    function updateQuestionCount() {
        document.getElementById('totalQuestionCount').textContent = questionBank.length;
    }
    
    // ==================== ADMIN FUNCTIONS ====================
    
    function toggleAdmin() {
        const cb = document.getElementById('adminToggle');
        if (cb.checked) { 
            if (prompt("‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°:") === "1234") { 
                document.getElementById('sidebarMain').classList.add('admin-active'); 
                document.getElementById('currentModeDisplay').innerText = "‡¶è‡¶°‡¶Æ‡¶ø‡¶®"; 
            } else cb.checked = false; 
        }
        else { 
            document.getElementById('sidebarMain').classList.remove('admin-active'); 
            document.getElementById('currentModeDisplay').innerText = "‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£"; 
        }
        updateSubFilter(); 
        renderSelectionList();
    }
    
    function toggleFields() { 
        const type = document.getElementById('qType').value; 
        document.getElementById('extraFields').style.display = (type === 'normal') ? 'none' : 'block'; 
        document.getElementById('showOptionsLabel').style.display = (type === 'normal') ? 'none' : 'flex'; 
    }
    
    // ==================== IMAGE FUNCTIONS ====================
    
    function handleImage(e) { 
        const file = e.target.files[0]; 
        if (!file) return; 
        const reader = new FileReader(); 
        reader.onload = function(ev) { 
            document.getElementById('cropImage').src = ev.target.result; 
            document.getElementById('cropperModal').style.display = 'block'; 
            if (cropper) cropper.destroy(); 
            setTimeout(() => { 
                cropper = new Cropper(document.getElementById('cropImage'), { autoCropArea: 1, viewMode: 1 }); 
            }, 100); 
        }; 
        reader.readAsDataURL(file); 
    }
    
    function finishCrop() { 
        currentImgData = cropper.getCroppedCanvas({ maxWidth: 800 }).toDataURL('image/jpeg', 0.7); 
        document.getElementById('imgPreview').innerHTML = `<img src="${currentImgData}" style="width:100px;">`; 
        closeCropper(); 
    }
    
    function closeCropper() { 
        document.getElementById('cropperModal').style.display = 'none'; 
    }
    
    // ==================== UTILITY FUNCTIONS ====================
    
    function shuffleSelectedQuestions() {
        let selected = questionBank.filter(q => q.selected);
        let others = questionBank.filter(q => !q.selected);
        for (let i = selected.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [selected[i], selected[j]] = [selected[j], selected[i]];
        }
        questionBank = [...selected, ...others];
        saveData(); 
        renderSelectionList();
    }
    
    function exportJSON() { 
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(new Blob([localStorage.getItem(DB_KEY)], {type: "application/json"})); 
        a.download = "BCTI_Backup.json"; 
        a.click(); 
    }
    
    function importJSON(e) { 
        const r = new FileReader(); 
        r.onload = (ev) => { 
            const importedData = JSON.parse(ev.target.result);
            
            if (!importedData.qs || !Array.isArray(importedData.qs)) {
                alert("‡¶´‡¶æ‡¶á‡¶≤ ‡¶´‡¶∞‡ßç‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü!");
                return;
            }
            
            let newQuestions = importedData.qs;
            let duplicates = 0;
            let added = 0;
            const seen = new Set();
            
            // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø seen ‡¶∏‡ßá‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
            questionBank.forEach(q => {
                const normalizedBody = normalizeText(q.body);
                const questionKey = `${q.sub}|${q.chap}|${normalizedBody}`;
                seen.add(questionKey);
            });
            
            // ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶á‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡ßç‡¶ü‡ßá‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
            newQuestions.forEach(newQ => {
                const normalizedBody = normalizeText(newQ.body);
                const questionKey = `${newQ.sub}|${newQ.chap}|${normalizedBody}`;
                
                if (seen.has(questionKey)) {
                    duplicates++;
                } else {
                    seen.add(questionKey);
                    questionBank.push(newQ);
                    added++;
                }
            });
            
            if (duplicates > 0) {
                alert(`${added}‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ${duplicates}‡¶ü‡¶ø ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¨‡¶æ‡¶¶ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
            } else {
                alert(`${added}‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶á‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
            }
            
            saveData();
            updateQuestionCount();
            location.reload();
        }; 
        r.readAsText(e.target.files[0]); 
    }
    
    function openTab(id) { 
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active')); 
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        if(event) event.currentTarget.classList.add('active'); 
    }
    
    function updateSliderValue(sliderId, value) {
        const valueElement = document.getElementById(sliderId + 'Value');
        if (valueElement) {
            valueElement.textContent = value;
        }
    }
    
    // ==================== DUPLICATE FUNCTIONS ====================
    
    function normalizeText(text) {
        if (!text) return '';
        return text
            .trim()
            .toLowerCase()
            .replace(/\s+/g, ' ') // ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶∏‡ßç‡¶™‡ßá‡¶∏‡¶ï‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßç‡¶™‡ßá‡¶∏‡ßá
            .replace(/[^\w\u0980-\u09FF\s$\(\)\[\]\{\}\+\-\*\/=<>!@#%^&|~`]/g, '') // ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶æ‡¶∞ ‡¶∏‡¶∞‡¶æ‡¶®‡ßã
            .replace(/\n/g, ' ') // ‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡¶æ‡¶á‡¶®‡¶ï‡ßá ‡¶∏‡ßç‡¶™‡ßá‡¶∏‡ßá
            .replace(/\./g, '') // ‡¶°‡¶ü ‡¶∏‡¶∞‡¶æ‡¶®‡ßã
            .replace(/,/g, '') // ‡¶ï‡¶Æ‡¶æ ‡¶∏‡¶∞‡¶æ‡¶®‡ßã
            .replace(/;/g, '') // ‡¶∏‡ßá‡¶Æ‡¶ø‡¶ï‡ßã‡¶≤‡¶® ‡¶∏‡¶∞‡¶æ‡¶®‡ßã
            .replace(/:/g, '') // ‡¶ï‡ßã‡¶≤‡¶® ‡¶∏‡¶∞‡¶æ‡¶®‡ßã
            .replace(/\?/g, ''); // ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶¨‡ßã‡¶ß‡¶ï ‡¶ö‡¶ø‡¶π‡ßç‡¶® ‡¶∏‡¶∞‡¶æ‡¶®‡ßã
    }
    
    function addQuestionWithDuplicateCheck() {
        const editIdx = parseInt(document.getElementById('editIndex').value);
        
        // ‡¶è‡¶°‡¶ø‡¶ü ‡¶Æ‡ßã‡¶°‡ßá ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®
        if (editIdx > -1) {
            addQuestion();
            return;
        }
        
        const newQuestion = getQuestionFromForm();
        
        // ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶® ‡¶ö‡ßá‡¶ï
        if (!newQuestion.sub || !newQuestion.body) {
            alert("‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá!");
            return;
        }
        
        // ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶ö‡ßá‡¶ï
        const duplicateInfo = findExactDuplicate(newQuestion);
        
        if (duplicateInfo.found && duplicateInfo.confidence >= 90) {
            // ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá - ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶®‡¶ø‡¶Ç ‡¶∂‡ßã ‡¶ï‡¶∞‡ßÅ‡¶®
            showDuplicateWarning(duplicateInfo, newQuestion, function(shouldSave) {
                if (shouldSave) {
                    // ‡¶§‡¶¨‡ßÅ‡¶ì ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶á‡¶≤‡ßá
                    questionBank.push(newQuestion);
                    saveData();
                    updateSubFilter();
                    updateChapterFilter();
                    updateQuestionCount();
                    selectionCurrentPage = 1;
                    renderSelectionList();
                    alert("‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá (‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶•‡¶æ‡¶ï‡¶æ ‡¶∏‡¶§‡ßç‡¶§‡ßç‡¶¨‡ßá‡¶ì)‡•§");
                    clearForm();
                }
            });
        } else {
            // ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®
            questionBank.push(newQuestion);
            saveData();
            updateSubFilter();
            updateChapterFilter();
            updateQuestionCount();
            selectionCurrentPage = 1;
            renderSelectionList();
            alert("‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§");
            clearForm();
        }
    }
    
    function findExactDuplicate(newQuestion) {
        const newBodyNormalized = normalizeText(newQuestion.body);
        
        for (let i = 0; i < questionBank.length; i++) {
            const existing = questionBank[i];
            const existingBodyNormalized = normalizeText(existing.body);
            
            // 1. ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï
            if (newBodyNormalized === existingBodyNormalized && newBodyNormalized !== '') {
                return {
                    found: true,
                    type: 'exact_text',
                    question: existing,
                    index: i,
                    confidence: 100
                };
            }
            
            // 2. MCQ/CQ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡ßã‡¶ì ‡¶ö‡ßá‡¶ï
            if (newQuestion.type === 'mcq' || newQuestion.type === 'cq') {
                if (existing.type === newQuestion.type) {
                    // ‡¶Ö‡¶™‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ö‡ßá‡¶ï
                    const newANormalized = normalizeText(newQuestion.a);
                    const newBNormalized = normalizeText(newQuestion.b);
                    const newCNormalized = normalizeText(newQuestion.c);
                    const newDNormalized = normalizeText(newQuestion.d);
                    
                    const existingANormalized = normalizeText(existing.a);
                    const existingBNormalized = normalizeText(existing.b);
                    const existingCNormalized = normalizeText(existing.c);
                    const existingDNormalized = normalizeText(existing.d);
                    
                    // ‡¶∏‡¶¨ ‡¶Ö‡¶™‡¶∂‡¶® ‡¶Æ‡¶ø‡¶≤‡¶≤‡ßá
                    if (newANormalized === existingANormalized &&
                        newBNormalized === existingBNormalized &&
                        newCNormalized === existingCNormalized &&
                        newDNormalized === existingDNormalized &&
                        newBodyNormalized === existingBodyNormalized) {
                        return {
                            found: true,
                            type: 'exact_mcq',
                            question: existing,
                            index: i,
                            confidence: 100
                        };
                    }
                }
            }
            
            // 3. 90%+ ‡¶Æ‡¶ø‡¶≤ ‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ (‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü)
            if (newBodyNormalized.length > 20 && existingBodyNormalized.length > 20) {
                const similarity = calculateSimilarity(newBodyNormalized, existingBodyNormalized);
                if (similarity > 90) {
                    return {
                        found: true,
                        type: 'similar',
                        question: existing,
                        index: i,
                        confidence: similarity
                    };
                }
            }
        }
        
        return { found: false, type: 'none', question: null, index: -1, confidence: 0 };
    }
    
    function calculateSimilarity(str1, str2) {
        if (str1 === str2) return 100;
        
        const longer = str1.length > str2.length ? str1 : str2;
        const shorter = str1.length > str2.length ? str2 : str1;
        
        if (longer.length === 0) return 100;
        
        // ‡¶∏‡¶π‡¶ú ‡¶∏‡¶ø‡¶Æ‡¶ø‡¶≤‡¶æ‡¶∞‡¶ø‡¶ü‡¶ø ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶∂‡¶®
        let matches = 0;
        for (let i = 0; i < shorter.length; i++) {
            if (longer.includes(shorter[i])) {
                matches++;
            }
        }
        
        return Math.round((matches / longer.length) * 100);
    }
    
    function showDuplicateWarning(duplicateInfo, newQuestion, callback) {
        const modal = document.getElementById('duplicateWarningModal');
        const content = document.getElementById('duplicateWarningContent');
        
        let warningHTML = `
            <div class="duplicate-warning">
                <h4>‚ö†Ô∏è ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá!</h4>
                
                <div class="duplicate-warning-content">
                    <p><strong>‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®:</strong></p>
                    <p>${newQuestion.body.substring(0, 150)}${newQuestion.body.length > 150 ? '...' : ''}</p>
                    
                    <p style="margin-top:10px;"><strong>‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® (#${duplicateInfo.index + 1}):</strong></p>
                    <p>${duplicateInfo.question.body.substring(0, 150)}${duplicateInfo.question.body.length > 150 ? '...' : ''}</p>
                    
                    <p style="margin-top:10px; color:#d32f2f;">
                        <strong>‡¶Æ‡¶ø‡¶≤‡ßá‡¶∞ ‡¶π‡¶æ‡¶∞:</strong> ${duplicateInfo.confidence}%<br>
                        <strong>‡¶ß‡¶∞‡¶®:</strong> ${duplicateInfo.type === 'exact_text' ? '‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶Æ‡¶ø‡¶≤' : 
                                             duplicateInfo.type === 'exact_mcq' ? '‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ MCQ ‡¶Æ‡¶ø‡¶≤' : '‡¶Ö‡¶®‡ßÅ‡¶∞‡ßÇ‡¶™ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®'}
                    </p>
                </div>
                
                <div class="duplicate-buttons">
                    <button onclick="hideDuplicateWarning(); callback(false)" style="background:#4caf50; color:white;">
                        ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ)
                    </button>
                    <button onclick="hideDuplicateWarning(); callback(true)" style="background:#f44336; color:white;">
                        ‡¶§‡¶¨‡ßÅ‡¶ì ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                </div>
            </div>
        `;
        
        content.innerHTML = warningHTML;
        modal.style.display = 'block';
    }
    
    function hideDuplicateWarning() {
        document.getElementById('duplicateWarningModal').style.display = 'none';
    }
    
    function checkDuplicateWhileTyping() {
        const duplicateStatus = document.getElementById('duplicateStatus');
        const question = getQuestionFromForm();
        
        if (!question.body || question.body.trim().length < 10) {
            duplicateStatus.style.display = 'none';
            return;
        }
        
        const duplicateInfo = findExactDuplicate(question);
        
        if (duplicateInfo.found) {
            duplicateStatus.style.display = 'block';
            if (duplicateInfo.confidence === 100) {
                duplicateStatus.innerHTML = `
                    <div style="background:#ffebee; color:#c62828; padding:8px; border-radius:4px; border:1px solid #ef9a9a;">
                        ‚ö†Ô∏è <strong>‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá!</strong> ‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶Ü‡¶õ‡ßá (#${duplicateInfo.index + 1})‡•§
                    </div>
                `;
                document.getElementById('saveBtn').style.background = '#f44336';
            } else if (duplicateInfo.confidence >= 90) {
                duplicateStatus.innerHTML = `
                    <div style="background:#fff3e0; color:#e65100; padding:8px; border-radius:4px; border:1px solid #ffcc80;">
                        ‚ö†Ô∏è <strong>‡¶Ö‡¶®‡ßÅ‡¶∞‡ßÇ‡¶™ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®!</strong> ${duplicateInfo.confidence}% ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá (#${duplicateInfo.index + 1})‡•§
                    </div>
                `;
                document.getElementById('saveBtn').style.background = '#ff9800';
            }
        } else {
            duplicateStatus.style.display = 'none';
            document.getElementById('saveBtn').style.background = 'var(--primary)';
        }
    }
    
    function findAndShowAllDuplicates() {
        const duplicates = [];
        const seen = new Set();
        
        for (let i = 0; i < questionBank.length; i++) {
            for (let j = i + 1; j < questionBank.length; j++) {
                const q1 = questionBank[i];
                const q2 = questionBank[j];
                
                const q1Normalized = normalizeText(q1.body);
                const q2Normalized = normalizeText(q2.body);
                
                // ‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶Æ‡¶ø‡¶≤ ‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ
                if (q1Normalized === q2Normalized && q1Normalized !== '') {
                    const pairId = `${Math.min(i, j)}-${Math.max(i, j)}`;
                    if (!seen.has(pairId)) {
                        seen.add(pairId);
                        duplicates.push({
                            index1: i,
                            question1: q1,
                            index2: j,
                            question2: q2,
                            type: 'exact'
                        });
                    }
                }
            }
        }
        
        if (duplicates.length === 0) {
            alert("‡¶ï‡ßã‡¶® ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§");
            return;
        }
        
        let message = `‡¶Æ‡ßã‡¶ü ${duplicates.length} ‡¶ú‡ßã‡ßú‡¶æ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶õ‡ßá:\n\n`;
        
        duplicates.forEach((dup, idx) => {
            message += `${idx + 1}. ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® #${dup.index1 + 1} ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® #${dup.index2 + 1}\n`;
            message += `   ‡¶¨‡¶ø‡¶∑‡ßü: ${dup.question1.sub} | ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º: ${dup.question1.chap}\n`;
            message += `   ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®: ${dup.question1.body.substring(0, 80)}...\n\n`;
        });
        
        message += "\n‡¶∏‡¶¨ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá '‡¶∏‡¶¨ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®' ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
        
        if (confirm(`${duplicates.length} ‡¶ú‡ßã‡ßú‡¶æ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá‡•§ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá OK ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®‡•§`)) {
            alert(message);
        }
    }
    
    function removeAllDuplicates() {
        if (!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶¨ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?\n\n‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ï‡¶™‡¶ø ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡¶¨‡ßá‡•§")) {
            return;
        }
        
        const uniqueQuestions = [];
        const seen = new Set();
        let removedCount = 0;
        
        questionBank.forEach((q, index) => {
            const normalizedBody = normalizeText(q.body);
            const questionKey = `${q.sub}|${q.chap}|${normalizedBody}`;
            
            if (!seen.has(questionKey)) {
                seen.add(questionKey);
                uniqueQuestions.push(q);
            } else {
                removedCount++;
            }
        });
        
        questionBank = uniqueQuestions;
        saveData();
        updateSubFilter();
        updateChapterFilter();
        updateQuestionCount();
        renderSelectionList();
        
        alert(`${removedCount}‡¶ü‡¶ø ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ${uniqueQuestions.length}‡¶ü‡¶ø ‡¶Ö‡¶®‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∞‡ßá‡¶ñ‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
    }
    
    function clearForm() {
        document.getElementById('qSub').value = '';
        document.getElementById('qChap').value = '';
        document.getElementById('qBody').value = '';
        document.getElementById('qAns').value = '';
        document.getElementById('qBoard').value = '';
        document.getElementById('qA').value = '';
        document.getElementById('qB').value = '';
        document.getElementById('qC').value = '';
        document.getElementById('qD').value = '';
        document.getElementById('imgPreview').innerHTML = '';
        currentImgData = '';
        document.getElementById('duplicateStatus').style.display = 'none';
        document.getElementById('saveBtn').style.background = 'var(--primary)';
    }
    
    // ==================== OUTPUT PAGINATION FUNCTIONS ====================
    
    function updateOutputPagination() {
        const selected = questionBank.filter(q => q.selected).length;
        totalOutputPages = Math.max(1, totalOutputPages);
        
        document.getElementById('outputPageInfo').innerText = `‡¶™‡ßá‡¶ú ${outputCurrentPage}/${totalOutputPages}`;
        document.getElementById('totalOutputPagesDisplay').innerText = totalOutputPages;
        document.getElementById('jumpToOutputPage').value = outputCurrentPage;
        document.getElementById('jumpToOutputPage').max = totalOutputPages;
        
        document.getElementById('outputPrevBtn').disabled = outputCurrentPage === 1;
        document.getElementById('outputNextBtn').disabled = outputCurrentPage === totalOutputPages;
        
        toggleOutputPagination();
    }
    
    function changeOutputPage(delta) {
        const newPage = outputCurrentPage + delta;
        if (newPage < 1 || newPage > totalOutputPages) return;
        
        document.querySelectorAll('.output-page').forEach(page => {
            page.classList.remove('active');
        });
        
        outputCurrentPage = newPage;
        document.getElementById(`output-page-${outputCurrentPage}`).classList.add('active');
        
        updateOutputPagination();
        document.querySelector('.preview-area').scrollTop = 0;
    }
    
    function jumpToOutputPage() {
        const pageInput = document.getElementById('jumpToOutputPage');
        let pageNum = parseInt(pageInput.value);
        
        if (isNaN(pageNum) || pageNum < 1) pageNum = 1;
        if (pageNum > totalOutputPages) pageNum = totalOutputPages;
        
        document.querySelectorAll('.output-page').forEach(page => {
            page.classList.remove('active');
        });
        
        outputCurrentPage = pageNum;
        document.getElementById(`output-page-${outputCurrentPage}`).classList.add('active');
        
        updateOutputPagination();
        document.querySelector('.preview-area').scrollTop = 0;
    }
    
    function toggleOutputPagination() {
        const showPagination = document.getElementById('showOutputPagination').checked;
        const selected = questionBank.filter(q => q.selected).length;
        
        if (showPagination && totalOutputPages > 1) {
            document.getElementById('outputPagination').style.display = 'flex';
        } else {
            document.getElementById('outputPagination').style.display = 'none';
        }
    }
    
    // ==================== MONTHLY EXAM FUNCTIONS ====================
    
    function loadSubjectsForMonthly() {
        const classFilter = document.getElementById('monthlyClass').value;
        const divisionFilter = document.getElementById('monthlyDivision').value;
        const questionsPerSubject = parseInt(document.getElementById('questionsPerSubject').value) || 2;
        
        // Filter questions by class and division
        let filteredQuestions = questionBank;
        if (classFilter) {
            filteredQuestions = filteredQuestions.filter(q => q.qClass === classFilter);
        }
        if (divisionFilter) {
            filteredQuestions = filteredQuestions.filter(q => q.qDiv === divisionFilter);
        }
        
        // Get unique subjects
        const subjects = [...new Set(filteredQuestions.map(q => q.sub))];
        
        let container = document.getElementById('monthlySubjectsContainer');
        if (subjects.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">‡¶è‡¶á ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø/‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó‡ßá ‡¶ï‡ßã‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</div>';
            document.getElementById('monthlyStats').style.display = 'none';
            return;
        }
        
        let html = '';
        subjects.forEach(subject => {
            // Get questions for this subject
            const subjectQuestions = filteredQuestions.filter(q => q.sub === subject);
            
            html += `
                <div class="subject-group">
                    <div class="subject-group-header">
                        <h4>üìö ${subject}</h4>
                        <span style="font-size:12px; color:#666;">‡¶Æ‡ßã‡¶ü: ${subjectQuestions.length}‡¶ü‡¶ø</span>
                    </div>
                    <div class="questions-list" id="subject-${subject.replace(/\s+/g, '-')}">
            `;
            
            // Display questions for this subject
            subjectQuestions.forEach((q, index) => {
                const isSelected = monthlySelectedQuestions.has(subject) && 
                                  monthlySelectedQuestions.get(subject).includes(index);
                html += `
                    <div class="question-item ${isSelected ? 'selected' : ''}" onclick="toggleMonthlyQuestion('${subject}', ${index})">
                        <input type="checkbox" class="question-checkbox" ${isSelected ? 'checked' : ''}>
                        <div class="question-preview">
                            <strong>${q.type === 'cq' ? '‡¶∏‡ßÉ‡¶ú‡¶®‡¶∂‡ßÄ‡¶≤' : q.type === 'mcq' ? 'MCQ' : '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£'}</strong>: 
                            ${q.body.substring(0, 60)}${q.body.length > 60 ? '...' : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    <div style="margin-top:10px; display:flex; gap:5px;">
                        <button onclick="selectRandomFromSubject('${subject}', ${questionsPerSubject})" style="flex:1; background:#2196f3; color:white; border:none; padding:6px; border-radius:4px; cursor:pointer; font-size:12px;">
                            üé≤ ${questionsPerSubject}‡¶ü‡¶ø ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶Æ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü
                        </button>
                        <button onclick="deselectAllFromSubject('${subject}')" style="flex:1; background:#f44336; color:white; border:none; padding:6px; border-radius:4px; cursor:pointer; font-size:12px;">
                            ‚ùå ‡¶∏‡¶¨ ‡¶°‡¶ø‡¶∏‡ßá‡¶≤‡ßá‡¶ï‡ßç‡¶ü
                        </button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        updateMonthlyStats();
        document.getElementById('monthlyStats').style.display = 'block';
    }
    
    function toggleMonthlyQuestion(subject, questionIndex) {
        if (!monthlySelectedQuestions.has(subject)) {
            monthlySelectedQuestions.set(subject, []);
        }
        
        const subjectQuestions = monthlySelectedQuestions.get(subject);
        const indexInArray = subjectQuestions.indexOf(questionIndex);
        
        if (indexInArray === -1) {
            // Add question
            subjectQuestions.push(questionIndex);
        } else {
            // Remove question
            subjectQuestions.splice(indexInArray, 1);
        }
        
        // Update UI
        const questionElement = document.querySelector(`#subject-${subject.replace(/\s+/g, '-')} .question-item:nth-child(${questionIndex + 1})`);
        if (questionElement) {
            questionElement.classList.toggle('selected');
            const checkbox = questionElement.querySelector('.question-checkbox');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
            }
        }
        
        updateMonthlyStats();
    }
    
    function selectRandomFromSubject(subject, count) {
        const classFilter = document.getElementById('monthlyClass').value;
        const divisionFilter = document.getElementById('monthlyDivision').value;
        
        // Get questions for this subject
        let filteredQuestions = questionBank.filter(q => q.sub === subject);
        if (classFilter) {
            filteredQuestions = filteredQuestions.filter(q => q.qClass === classFilter);
        }
        if (divisionFilter) {
            filteredQuestions = filteredQuestions.filter(q => q.qDiv === divisionFilter);
        }
        
        if (filteredQuestions.length === 0) return;
        
        // Clear previous selections for this subject
        monthlySelectedQuestions.set(subject, []);
        
        // Select random questions
        const selectedIndices = [];
        const availableIndices = Array.from({length: filteredQuestions.length}, (_, i) => i);
        
        count = Math.min(count, filteredQuestions.length);
        
        for (let i = 0; i < count; i++) {
            if (availableIndices.length === 0) break;
            
            const randomIndex = Math.floor(Math.random() * availableIndices.length);
            const selectedIndex = availableIndices[randomIndex];
            
            selectedIndices.push(selectedIndex);
            monthlySelectedQuestions.get(subject).push(selectedIndex);
            
            availableIndices.splice(randomIndex, 1);
        }
        
        // Update UI
        loadSubjectsForMonthly();
        updateMonthlyStats();
    }
    
    function deselectAllFromSubject(subject) {
        if (monthlySelectedQuestions.has(subject)) {
            monthlySelectedQuestions.set(subject, []);
            loadSubjectsForMonthly();
            updateMonthlyStats();
        }
    }
    
    function updateMonthlyStats() {
        let totalSelected = 0;
        monthlySelectedQuestions.forEach((indices, subject) => {
            totalSelected += indices.length;
        });
        
        document.getElementById('monthlyTotalSelected').textContent = totalSelected;
        document.getElementById('monthlyStats').style.display = totalSelected > 0 ? 'block' : 'none';
    }
    
    function clearMonthlySelection() {
        if (confirm("‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶∏‡¶¨ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            monthlySelectedQuestions.clear();
            loadSubjectsForMonthly();
            updateMonthlyStats();
        }
    }
    
    function generateMonthlyExam() {
        const examName = document.getElementById('monthlyExamName').value || "‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ";
        const classFilter = document.getElementById('monthlyClass').value;
        const divisionFilter = document.getElementById('monthlyDivision').value;
        
        // Clear all existing selections
        questionBank.forEach(q => q.selected = false);
        
        // Add selected questions from monthly exam
        let selectedCount = 0;
        monthlySelectedQuestions.forEach((indices, subject) => {
            // Get questions for this subject
            let subjectQuestions = questionBank.filter(q => q.sub === subject);
            if (classFilter) {
                subjectQuestions = subjectQuestions.filter(q => q.qClass === classFilter);
            }
            if (divisionFilter) {
                subjectQuestions = subjectQuestions.filter(q => q.qDiv === divisionFilter);
            }
            
            // Select the chosen indices
            indices.forEach(index => {
                if (index < subjectQuestions.length) {
                    const question = subjectQuestions[index];
                    const originalIndex = questionBank.findIndex(q => q === question);
                    if (originalIndex !== -1) {
                        questionBank[originalIndex].selected = true;
                        selectedCount++;
                    }
                }
            });
        });
        
        if (selectedCount === 0) {
            alert("‡¶ï‡ßã‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            return;
        }
        
        // Update exam name in settings
        document.getElementById('h2').value = examName;
        
        // Update class in settings if selected
        if (classFilter) {
            document.getElementById('hClass').value = classFilter;
        }
        
        // Update subject line based on settings
        if (combineAllSubjects) {
            // If combining all subjects, don't show subject names
            document.getElementById('h3').value = "‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ - ‡¶∏‡¶ï‡¶≤ ‡¶¨‡¶ø‡¶∑‡ßü";
        } else {
            // Show subjects list
            let subjectsList = Array.from(monthlySelectedQuestions.keys()).join(', ');
            document.getElementById('h3').value = `‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶∏‡¶Æ‡ßÇ‡¶π: ${subjectsList}`;
        }
        
        // Save and update UI
        saveData();
        renderSelectionList();
        openTab('select');
        
        alert(`‚úÖ ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ${selectedCount}‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§\n\n‡¶è‡¶ñ‡¶® ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü/PDF ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§`);
    }
    
    // ==================== AUTO GENERATOR FUNCTIONS ====================
    
    function autoSelectRandom() { 
        let count = parseInt(document.getElementById('randomCount').value);
        if(!count || count < 1) {
            alert("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ï‡¶§‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ö‡¶æ‡¶® ‡¶§‡¶æ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!");
            return;
        }
        
        // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶™‡¶æ‡¶®
        const subF = document.getElementById('fSub').value;
        const classF = document.getElementById('fClass').value;
        const divF = document.getElementById('fDiv').value;
        const typeF = document.getElementById('fType').value;
        const chapF = document.getElementById('fChap').value;
        
        // ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Ø‡ßá‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á)
        let pool = questionBank.filter((q, index) => {
            const matchesFilter = (!subF || q.sub === subF) && 
                                 (!classF || q.qClass === classF) && 
                                 (!divF || q.qDiv === divF) && 
                                 (!typeF || q.type === typeF) &&
                                 (!chapF || q.chap === chapF) &&
                                 !q.selected; // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ö‡¶®‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®
            return matchesFilter;
        });
        
        if(pool.length === 0) {
            alert("‚ùå ‡¶è‡¶á ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡ßá ‡¶Ü‡¶∞ ‡¶ï‡ßã‡¶® ‡¶Ö‡¶®‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶®‡ßá‡¶á!\n‡¶Ö‡¶•‡¶¨‡¶æ ‡¶Ü‡¶ó‡ßá ‡¶∏‡¶¨ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§");
            return;
        }
        
        if(count > pool.length) {
            alert(`‚ö†Ô∏è ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ${pool.length}‡¶ü‡¶ø ‡¶Ö‡¶®‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶õ‡ßá‡•§\n‡¶∏‡¶¨‡¶ó‡ßÅ‡¶≤‡ßã‡¶á ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§`);
            count = pool.length;
        }
        
        // ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶Æ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        let selectedIndices = [];
        for(let i = 0; i < count; i++){
            if(pool.length === 0) break;
            
            let rIdx = Math.floor(Math.random() * pool.length);
            let selectedQuestion = pool[rIdx];
            
            // ‡¶Æ‡ßÇ‡¶≤ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡ßá ‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ü‡¶ø‡¶∞ ‡¶á‡¶®‡¶°‡ßá‡¶ï‡ßç‡¶∏ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
            let originalIndex = questionBank.findIndex(q => 
                q === selectedQuestion || 
                (q.sub === selectedQuestion.sub && 
                 q.body === selectedQuestion.body &&
                 q.type === selectedQuestion.type)
            );
            
            if(originalIndex !== -1) {
                questionBank[originalIndex].selected = true;
                selectedIndices.push(originalIndex + 1); // 1-based index for display
            }
            
            // ‡¶™‡ßÅ‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶ø‡¶Ø‡¶º‡ßá ‡¶¶‡¶ø‡¶® ‡¶Ø‡¶æ‡¶§‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶®‡¶æ ‡¶π‡¶Ø‡¶º
            pool.splice(rIdx, 1);
        }
        
        saveData(); 
        renderSelectionList();
        
        // ‡¶∏‡¶æ‡¶´‡¶≤‡ßç‡¶Ø ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ
        if(selectedIndices.length > 0) {
            let message = `‚úÖ ${selectedIndices.length}‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶Æ‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!`;
            
            // ‡¶Ø‡¶¶‡¶ø ‡¶ï‡¶Æ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶ï ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶∏‡ßá‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
            if(selectedIndices.length <= 10) {
                message += `\n\n‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞: ${selectedIndices.join(', ')}`;
            }
            
            alert(message);
        }
    }
    
    function advancedAutoSelect() {
        const countInput = document.getElementById('advancedRandomCount');
        const typeFilter = document.getElementById('autoTypeFilter').value;
        const statusDiv = document.getElementById('autoGenStatus');
        
        let count = parseInt(countInput.value);
        if(!count || count < 1) {
            alert("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ï‡¶§‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ö‡¶æ‡¶® ‡¶§‡¶æ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!");
            return;
        }
        
        let pool = [];
        
        if(typeFilter === 'current') {
            // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ
            const subF = document.getElementById('fSub').value;
            const classF = document.getElementById('fClass').value;
            const divF = document.getElementById('fDiv').value;
            const typeF = document.getElementById('fType').value;
            const chapF = document.getElementById('fChap').value;
            
            pool = questionBank.filter(q => {
                const matchesFilter = (!subF || q.sub === subF) && 
                                     (!classF || q.qClass === classF) && 
                                     (!divF || q.qDiv === divF) && 
                                     (!typeF || q.type === typeF) &&
                                     (!chapF || q.chap === chapF) &&
                                     !q.selected;
                return matchesFilter;
            });
        } 
        else if(typeFilter === 'all') {
            // ‡¶∏‡¶¨ ‡¶Ö‡¶®‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®
            pool = questionBank.filter(q => !q.selected);
        }
        else {
            // ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶ß‡¶∞‡¶®‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®
            pool = questionBank.filter(q => !q.selected && q.type === typeFilter);
        }
        
        if(pool.length === 0) {
            statusDiv.innerHTML = `<span style="color:#f44336;">‚ùå ‡¶ï‡ßã‡¶® ‡¶Ö‡¶®‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!</span>`;
            statusDiv.style.display = 'block';
            setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
            return;
        }
        
        if(count > pool.length) {
            statusDiv.innerHTML = `<span style="color:#ff9800;">‚ö†Ô∏è ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ${pool.length}‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶õ‡ßá‡•§ ‡¶∏‡¶¨‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§</span>`;
            statusDiv.style.display = 'block';
            count = pool.length;
        }
        
        // ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶Æ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        let selectedCount = 0;
        for(let i = 0; i < count; i++){
            if(pool.length === 0) break;
            
            let rIdx = Math.floor(Math.random() * pool.length);
            let selectedQuestion = pool[rIdx];
            
            // ‡¶Æ‡ßÇ‡¶≤ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡ßá ‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ü‡¶ø‡¶∞ ‡¶á‡¶®‡¶°‡ßá‡¶ï‡ßç‡¶∏ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
            let originalIndex = questionBank.findIndex(q => 
                q === selectedQuestion || 
                (q.sub === selectedQuestion.sub && 
                 q.body === selectedQuestion.body &&
                 q.type === selectedQuestion.type)
            );
            
            if(originalIndex !== -1) {
                questionBank[originalIndex].selected = true;
                selectedCount++;
            }
            
            // ‡¶™‡ßÅ‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶ø‡¶Ø‡¶º‡ßá ‡¶¶‡¶ø‡¶® ‡¶Ø‡¶æ‡¶§‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶®‡¶æ ‡¶π‡¶Ø‡¶º
            pool.splice(rIdx, 1);
        }
        
        saveData(); 
        renderSelectionList();
        
        // ‡¶∏‡¶æ‡¶´‡¶≤‡ßç‡¶Ø ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ
        statusDiv.innerHTML = `<span style="color:#4caf50;">‚úÖ ${selectedCount}‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!</span>`;
        statusDiv.style.display = 'block';
        setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
    }
    
    function autoDeselectRandom() {
        const countInput = document.getElementById('advancedRandomCount');
        let count = parseInt(countInput.value);
        if(!count || count < 1) {
            alert("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ï‡¶§‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶°‡¶ø‡¶∏‡ßá‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶® ‡¶§‡¶æ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!");
            return;
        }
        
        // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶™‡ßÅ‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
        let pool = questionBank.filter(q => q.selected);
        
        if(pool.length === 0) {
            alert("‚ùå ‡¶ï‡ßã‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶®‡ßá‡¶á!");
            return;
        }
        
        if(count > pool.length) {
            alert(`‚ö†Ô∏è ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ${pool.length}‡¶ü‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ü‡¶õ‡ßá‡•§ ‡¶∏‡¶¨‡¶ó‡ßÅ‡¶≤‡ßã ‡¶°‡¶ø‡¶∏‡ßá‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§`);
            count = pool.length;
        }
        
        // ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶Æ‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶ø‡¶∏‡ßá‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        let deselectedCount = 0;
        for(let i = 0; i < count; i++){
            if(pool.length === 0) break;
            
            let rIdx = Math.floor(Math.random() * pool.length);
            let deselectedQuestion = pool[rIdx];
            
            // ‡¶Æ‡ßÇ‡¶≤ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡ßá ‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ü‡¶ø‡¶∞ ‡¶á‡¶®‡¶°‡ßá‡¶ï‡ßç‡¶∏ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
            let originalIndex = questionBank.findIndex(q => 
                q === deselectedQuestion || 
                (q.sub === deselectedQuestion.sub && 
                 q.body === deselectedQuestion.body &&
                 q.type === deselectedQuestion.type)
            );
            
            if(originalIndex !== -1) {
                questionBank[originalIndex].selected = false;
                deselectedCount++;
            }
            
            // ‡¶™‡ßÅ‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶ø‡¶Ø‡¶º‡ßá ‡¶¶‡¶ø‡¶®
            pool.splice(rIdx, 1);
        }
        
        saveData(); 
        renderSelectionList();
        
        alert(`‚úÖ ${deselectedCount}‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶Æ‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶ø‡¶∏‡ßá‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!`);
    }
    
    function selectAllQuestions() {
        // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        const subF = document.getElementById('fSub').value;
        const classF = document.getElementById('fClass').value;
        const divF = document.getElementById('fDiv').value;
        const typeF = document.getElementById('fType').value;
        const chapF = document.getElementById('fChap').value;
        
        questionBank.forEach((q, i) => {
            // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
            const matchesFilter = (!subF || q.sub === subF) && 
                                 (!classF || q.qClass === classF) && 
                                 (!divF || q.qDiv === divF) && 
                                 (!typeF || q.type === typeF) &&
                                 (!chapF || q.chap === chapF);
            
            if (matchesFilter) {
                q.selected = true;
            }
        });
        
        saveData();
        renderSelectionList();
        alert("‡¶∏‡¶ï‡¶≤ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
    }
    
    function deselectAllQuestions() {
        // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶°‡¶ø‡¶∏‡ßá‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        const subF = document.getElementById('fSub').value;
        const classF = document.getElementById('fClass').value;
        const divF = document.getElementById('fDiv').value;
        const typeF = document.getElementById('fType').value;
        const chapF = document.getElementById('fChap').value;
        
        questionBank.forEach((q, i) => {
            // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶°‡¶ø‡¶∏‡ßá‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
            const matchesFilter = (!subF || q.sub === subF) && 
                                 (!classF || q.qClass === classF) && 
                                 (!divF || q.qDiv === divF) && 
                                 (!typeF || q.type === typeF) &&
                                 (!chapF || q.chap === chapF);
            
            if (matchesFilter) {
                q.selected = false;
            }
        });
        
        saveData();
        renderSelectionList();
        alert("‡¶∏‡¶ï‡¶≤ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶°‡¶ø‡¶∏‡ßá‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
    }
    
    // ==================== SUBJECT-WISE QUESTION LIMIT FUNCTIONS ====================
    
    function updateSubjectLimitsFromSelected() {
        const selected = questionBank.filter(q => q.selected);
        if (selected.length === 0) {
            alert("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!");
            return;
        }
        
        // Group by subject
        const subjects = {};
        selected.forEach(q => {
            const subject = q.sub || '‡¶¨‡¶ø‡¶∑‡ßü‡¶π‡ßÄ‡¶®';
            if (!subjects[subject]) {
                subjects[subject] = 0;
            }
            subjects[subject]++;
        });
        
        // Generate HTML for subject limits
        let html = '';
        Object.keys(subjects).forEach(subject => {
            const currentCount = subjects[subject];
            const currentLimit = subjectLimits[subject] || currentCount; // Default to all questions
            
            html += `
            <div class="subject-limit-item" style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div>
                        <strong style="font-size: 14px;">${subject}</strong>
                        <div style="font-size: 11px; color: #666;">
                            ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°: ${currentCount}‡¶ü‡¶ø | ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü: 
                            <input type="number" 
                                   id="limit_${subject.replace(/\s+/g, '_')}" 
                                   value="${currentLimit}"
                                   min="0" 
                                   max="${currentCount}"
                                   style="width: 60px; padding: 3px; border: 1px solid #ccc; border-radius: 3px; text-align: center; margin: 0 5px;"
                                   onchange="updateSubjectLimit('${subject}', this.value)">
                            ‡¶ü‡¶ø
                        </div>
                    </div>
                    <div>
                        <button onclick="setLimitToAll('${subject}', ${currentCount})" 
                                style="background: #4caf50; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                            ‡¶∏‡¶¨ (${currentCount})
                        </button>
                    </div>
                </div>
                
                <!-- Progress bar -->
                <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-top: 5px;">
                    <div style="width: ${(currentLimit / currentCount) * 100}%; height: 100%; background: var(--primary); transition: 0.3s;"></div>
                </div>
                
                <div style="font-size: 10px; color: #666; margin-top: 3px; display: flex; justify-content: space-between;">
                    <span>‡ß¶‡¶ü‡¶ø</span>
                    <span>${Math.min(currentLimit, currentCount)}/${currentCount}‡¶ü‡¶ø ‡¶Ø‡¶æ‡¶¨‡ßá</span>
                    <span>${currentCount}‡¶ü‡¶ø</span>
                </div>
            </div>`;
        });
        
        document.getElementById('subjectLimitContainer').innerHTML = html || '<p>‡¶ï‡ßã‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶®‡ßá‡¶á</p>';
        
        // Save to localStorage
        saveSubjectLimits();
        
        // Re-render output with new limits
        renderOutputPages();
    }
    
    function updateSubjectLimit(subject, value) {
        const maxQuestions = questionBank.filter(q => q.selected && q.sub === subject).length;
        const limitValue = parseInt(value);
        
        if (isNaN(limitValue) || limitValue < 0) {
            subjectLimits[subject] = maxQuestions; // Default to all
        } else if (limitValue > maxQuestions) {
            subjectLimits[subject] = maxQuestions;
            alert(`‚ö†Ô∏è "${subject}" ‡¶¨‡¶ø‡¶∑‡ßü‡ßá ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ${maxQuestions}‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá!`);
        } else {
            subjectLimits[subject] = limitValue;
        }
        
        // Update the input field
        const inputId = `limit_${subject.replace(/\s+/g, '_')}`;
        const inputElement = document.getElementById(inputId);
        if (inputElement) {
            inputElement.value = subjectLimits[subject];
        }
        
        saveSubjectLimits();
        renderOutputPages();
    }
    
    function setLimitToAll(subject, maxCount) {
        subjectLimits[subject] = maxCount;
        
        // Update the input field
        const inputId = `limit_${subject.replace(/\s+/g, '_')}`;
        const inputElement = document.getElementById(inputId);
        if (inputElement) {
            inputElement.value = maxCount;
        }
        
        saveSubjectLimits();
        renderOutputPages();
    }
    
    function clearAllSubjectLimits() {
        if (confirm("‡¶∏‡¶¨ ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶∏‡¶¨ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§")) {
            subjectLimits = {};
            saveSubjectLimits();
            updateSubjectLimitsFromSelected();
            renderOutputPages();
        }
    }
    
    function toggleSubjectLimits() {
        const isEnabled = document.getElementById('enableSubjectLimits').checked;
        
        // Re-render output with or without limits
        renderOutputPages();
    }
    
    function saveSubjectLimits() {
        // Save to localStorage along with other data
        const data = JSON.parse(localStorage.getItem(DB_KEY) || '{}');
        data.subjectLimits = subjectLimits;
        data.enableSubjectLimits = document.getElementById('enableSubjectLimits').checked;
        localStorage.setItem(DB_KEY, JSON.stringify(data));
    }
    
    // ==================== TEMPORARY EDIT FUNCTIONS ====================
    
    function openTemporaryEditor() {
        const selected = questionBank.filter(q => q.selected);
        if (selected.length === 0) {
            alert("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!");
            return;
        }
        
        // Create temporary editor modal
        const modalHTML = `
        <div id="tempEditModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; display:flex; justify-content:center; align-items:center;">
            <div style="background:white; width:90%; max-width:800px; height:80vh; border-radius:10px; padding:20px; display:flex; flex-direction:column;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:2px solid var(--primary); padding-bottom:10px;">
                    <h3 style="margin:0; color:var(--primary);">üñäÔ∏è ‡¶ü‡ßá‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡¶æ‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü</h3>
                    <button onclick="closeTempEditor()" style="background:#f44336; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">‚úñ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
                
                <div style="display:flex; gap:20px; flex:1; overflow:hidden;">
                    <!-- Left sidebar - question list -->
                    <div style="width:300px; border-right:1px solid #ddd; padding-right:15px; overflow-y:auto;">
                        <h4 style="margin-top:0; margin-bottom:10px;">‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® (${selected.length})</h4>
                        <div id="tempEditQuestionList" style="display:flex; flex-direction:column; gap:8px;">
                            <!-- Questions will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Right editor area -->
                    <div style="flex:1; overflow-y:auto; display:flex; flex-direction:column;">
                        <div id="tempEditCurrentInfo" style="background:#e3f2fd; padding:10px; border-radius:5px; margin-bottom:15px;">
                            <strong>‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶õ‡ßá‡¶®:</strong> ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® <span id="currentEditNum">1</span>/${selected.length}
                        </div>
                        
                        <div style="margin-bottom:15px;">
                            <label style="display:block; margin-bottom:5px; font-weight:bold;">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü</label>
                            <textarea id="tempEditBody" rows="6" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; font-family:inherit;"></textarea>
                        </div>
                        
                        <div id="tempEditOptionsArea" style="margin-bottom:15px; display:none;">
                            <label style="display:block; margin-bottom:5px; font-weight:bold;">‡¶Ö‡¶™‡¶∂‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π</label>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                <div>
                                    <label style="font-size:12px;">‡¶ï</label>
                                    <textarea id="tempEditOptionA" rows="2" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:5px;"></textarea>
                                </div>
                                <div>
                                    <label style="font-size:12px;">‡¶ñ</label>
                                    <textarea id="tempEditOptionB" rows="2" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:5px;"></textarea>
                                </div>
                                <div>
                                    <label style="font-size:12px;">‡¶ó</label>
                                    <textarea id="tempEditOptionC" rows="2" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:5px;"></textarea>
                                </div>
                                <div>
                                    <label style="font-size:12px;">‡¶ò</label>
                                    <textarea id="tempEditOptionD" rows="2" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:5px;"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display:flex; gap:10px; margin-top:auto;">
                            <button onclick="saveTempEdit()" style="flex:1; background:#4caf50; color:white; border:none; padding:12px; border-radius:5px; cursor:pointer; font-weight:bold;">üíæ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                            <button onclick="loadPrevQuestion()" style="width:50px; background:#2196f3; color:white; border:none; padding:12px; border-radius:5px; cursor:pointer;">‚Üê</button>
                            <button onclick="loadNextQuestion()" style="width:50px; background:#2196f3; color:white; border:none; padding:12px; border-radius:5px; cursor:pointer;">‚Üí</button>
                        </div>
                        
                        <div style="margin-top:15px; background:#f5f5f5; padding:10px; border-radius:5px; font-size:12px;">
                            <strong>üìå ‡¶®‡ßã‡¶ü:</strong> ‡¶ü‡ßá‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡¶æ‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶è‡¶á ‡¶∏‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø‡•§ ‡¶™‡ßá‡¶ú ‡¶∞‡¶ø‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Æ‡ßÇ‡¶≤ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ü‡¶∏‡¶¨‡ßá‡•§
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        loadTempEditorQuestions();
        loadQuestionForTempEdit(0);
    }
    
    function loadTempEditorQuestions() {
        const selected = questionBank.filter(q => q.selected);
        const listDiv = document.getElementById('tempEditQuestionList');
        
        listDiv.innerHTML = '';
        
        selected.forEach((q, index) => {
            const isEdited = temporaryEdits.has(index);
            const item = document.createElement('div');
            item.className = 'q-card temp-edit-q-item';
            item.style.cursor = 'pointer';
            item.style.padding = '10px';
            item.style.border = isEdited ? '2px solid #4caf50' : '1px solid #ddd';
            item.style.background = isEdited ? '#e8f5e9' : '#fff';
            
            item.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <strong style="color:var(--primary);">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ${index + 1}</strong>
                    ${isEdited ? '<span style="color:#4caf50; font-size:11px;">‚úèÔ∏è ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ</span>' : ''}
                </div>
                <div style="font-size:12px; color:#666; max-height:60px; overflow:hidden;">
                    ${q.body.substring(0, 80)}${q.body.length > 80 ? '...' : ''}
                </div>
                <div style="font-size:11px; color:#999; margin-top:5px;">
                    ${q.sub} | ${q.type === 'cq' ? '‡¶∏‡ßÉ‡¶ú‡¶®‡¶∂‡ßÄ‡¶≤' : q.type === 'mcq' ? 'MCQ' : '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£'}
                </div>
            `;
            
            item.onclick = () => {
                // Remove active class from all items
                document.querySelectorAll('.temp-edit-q-item').forEach(el => {
                    el.classList.remove('active');
                    el.style.background = el.style.background.includes('#e8f5e9') ? '#e8f5e9' : '#fff';
                });
                
                // Add active class to clicked item
                item.classList.add('active');
                item.style.background = '#e3f2fd';
                
                loadQuestionForTempEdit(index);
            };
            
            listDiv.appendChild(item);
        });
    }
    
    function loadQuestionForTempEdit(index) {
        const selected = questionBank.filter(q => q.selected);
        if (index >= selected.length) return;
        
        currentEditingIndex = index;
        const q = selected[index];
        
        // Check if there's a temporary edit
        const editedQ = temporaryEdits.get(index);
        
        document.getElementById('currentEditNum').textContent = index + 1;
        document.getElementById('tempEditBody').value = editedQ ? editedQ.body : q.body;
        
        // Show/hide options area
        if (q.type !== 'normal') {
            document.getElementById('tempEditOptionsArea').style.display = 'block';
            document.getElementById('tempEditOptionA').value = editedQ ? editedQ.a : (q.a || '');
            document.getElementById('tempEditOptionB').value = editedQ ? editedQ.b : (q.b || '');
            document.getElementById('tempEditOptionC').value = editedQ ? editedQ.c : (q.c || '');
            document.getElementById('tempEditOptionD').value = editedQ ? editedQ.d : (q.d || '');
        } else {
            document.getElementById('tempEditOptionsArea').style.display = 'none';
        }
        
        // Update active item in list
        document.querySelectorAll('.temp-edit-q-item').forEach((el, i) => {
            el.classList.remove('active');
            const isEdited = temporaryEdits.has(i);
            el.style.background = isEdited ? '#e8f5e9' : '#fff';
        });
        
        const currentItem = document.querySelectorAll('.temp-edit-q-item')[index];
        if (currentItem) {
            currentItem.classList.add('active');
            currentItem.style.background = '#e3f2fd';
        }
    }
    
    function saveTempEdit() {
        const selected = questionBank.filter(q => q.selected);
        if (currentEditingIndex >= selected.length) return;
        
        const q = selected[currentEditingIndex];
        
        // Get edited values
        const editedBody = document.getElementById('tempEditBody').value.trim();
        
        // Create edited question object
        const editedQ = {
            body: editedBody,
            sub: q.sub,
            type: q.type,
            chap: q.chap
        };
        
        // Add options if not normal type
        if (q.type !== 'normal') {
            editedQ.a = document.getElementById('tempEditOptionA').value.trim();
            editedQ.b = document.getElementById('tempEditOptionB').value.trim();
            editedQ.c = document.getElementById('tempEditOptionC').value.trim();
            editedQ.d = document.getElementById('tempEditOptionD').value.trim();
        }
        
        // Store in temporary edits map
        temporaryEdits.set(currentEditingIndex, editedQ);
        
        // Update the actual question in the bank for this session
        // Find the original question index
        const originalQ = selected[currentEditingIndex];
        const originalIndex = questionBank.findIndex(qb => qb === originalQ);
        
        if (originalIndex !== -1) {
            // Create a modified copy
            questionBank[originalIndex] = {
                ...questionBank[originalIndex],
                body: editedBody,
                ...(q.type !== 'normal' && {
                    a: editedQ.a,
                    b: editedQ.b,
                    c: editedQ.c,
                    d: editedQ.d
                })
            };
        }
        
        // Update UI
        loadTempEditorQuestions();
        
        // Highlight current item
        const currentItem = document.querySelectorAll('.temp-edit-q-item')[currentEditingIndex];
        if (currentItem) {
            currentItem.classList.add('active');
            currentItem.style.background = '#e3f2fd';
        }
        
        // Re-render output to see changes
        renderOutputPages();
        
        alert("‚úÖ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
    }
    
    function loadPrevQuestion() {
        if (currentEditingIndex > 0) {
            loadQuestionForTempEdit(currentEditingIndex - 1);
        }
    }
    
    function loadNextQuestion() {
        const selected = questionBank.filter(q => q.selected);
        if (currentEditingIndex < selected.length - 1) {
            loadQuestionForTempEdit(currentEditingIndex + 1);
        }
    }
    
    function closeTempEditor() {
        const modal = document.getElementById('tempEditModal');
        if (modal) {
            modal.remove();
        }
    }
    
    // ==================== SEARCH FUNCTIONS - FIXED ====================
    
    function performSearch() {
        const searchInput = document.getElementById('searchBox');
        const clearBtn = document.getElementById('clearSearchBtn');
        const searchNavButtons = document.getElementById('searchNavButtons');
        const searchInfoDisplay = document.getElementById('searchInfoDisplay');
        
        searchTerm = searchInput.value.trim().toLowerCase();
        
        if (searchTerm === '') {
            clearSearch();
            return;
        }
        
        // Show clear button
        clearBtn.style.display = 'block';
        
        // Search in all fields
        searchResults = [];
        
        questionBank.forEach((q, index) => {
            let found = false;
            
            // Search in body
            if (q.body && q.body.toLowerCase().includes(searchTerm)) {
                found = true;
            }
            
            // Search in subject
            if (q.sub && q.sub.toLowerCase().includes(searchTerm)) {
                found = true;
            }
            
            // Search in chapter
            if (q.chap && q.chap.toLowerCase().includes(searchTerm)) {
                found = true;
            }
            
            // Search in answer
            if (q.ans && q.ans.toLowerCase().includes(searchTerm)) {
                found = true;
            }
            
            // Search in options
            if (q.a && q.a.toLowerCase().includes(searchTerm)) found = true;
            if (q.b && q.b.toLowerCase().includes(searchTerm)) found = true;
            if (q.c && q.c.toLowerCase().includes(searchTerm)) found = true;
            if (q.d && q.d.toLowerCase().includes(searchTerm)) found = true;
            
            if (found) {
                searchResults.push(index);
            }
        });
        
        // Update search status
        isSearchActive = searchResults.length > 0;
        currentSearchIndex = 0;
        
        // Update search info
        document.getElementById('searchResultCount').textContent = searchResults.length;
        
        if (searchResults.length > 0) {
            searchInfoDisplay.classList.add('active');
            searchNavButtons.style.display = 'flex';
            
            // Highlight first result
            highlightCurrentSearchResult();
        } else {
            searchInfoDisplay.classList.remove('active');
            searchNavButtons.style.display = 'none';
            searchInput.style.background = '#ffebee';
            searchInput.style.borderColor = '#f44336';
        }
        
        // Re-render the list to show highlights
        renderSelectionList();
        
        // Navigate to first result
        if (searchResults.length > 0) {
            navigateToSearchResult(0);
        }
    }
    
    function highlightCurrentSearchResult() {
        // Remove all active highlights
        document.querySelectorAll('.search-navigation-active').forEach(el => {
            el.classList.remove('search-navigation-active');
        });
        
        // Add highlight to current
        if (searchResults.length > 0 && currentSearchIndex < searchResults.length) {
            const resultIndex = searchResults[currentSearchIndex];
            const questionElement = document.querySelector(`.q-card[onclick*="toggleQ(${resultIndex})"]`);
            if (questionElement) {
                questionElement.classList.add('search-navigation-active');
                
                // Scroll into view
                setTimeout(() => {
                    questionElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
        }
    }
    
    function navigateToSearchResult(index) {
        if (searchResults.length === 0) return;
        
        if (index < 0) index = searchResults.length - 1;
        if (index >= searchResults.length) index = 0;
        
        currentSearchIndex = index;
        
        highlightCurrentSearchResult();
        
        // Update search info
        document.getElementById('searchResultCount').textContent = searchResults.length;
        document.getElementById('searchBox').title = `‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ${currentSearchIndex + 1}/${searchResults.length}`;
    }
    
    function clearSearch() {
        const searchInput = document.getElementById('searchBox');
        const clearBtn = document.getElementById('clearSearchBtn');
        const searchNavButtons = document.getElementById('searchNavButtons');
        const searchInfoDisplay = document.getElementById('searchInfoDisplay');
        
        searchInput.value = '';
        searchTerm = '';
        searchResults = [];
        currentSearchIndex = 0;
        isSearchActive = false;
        
        // Hide clear button and navigation
        clearBtn.style.display = 'none';
        searchNavButtons.style.display = 'none';
        searchInfoDisplay.classList.remove('active');
        
        // Reset search box styling
        searchInput.style.background = '';
        searchInput.style.borderColor = '#ccc';
        searchInput.title = '';
        
        // Remove highlights and re-render
        renderSelectionList();
    }
    
    function handleSearchKeyPress(e) {
        if (e.key === 'Enter' && searchResults.length > 0) {
            navigateToSearchResult(currentSearchIndex + 1);
        }
    }
    
    // ==================== INITIALIZATION ====================
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
        checkLicense();
    });
</script>
</body>
</html>