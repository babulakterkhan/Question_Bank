<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>BCTI - Advanced Exam Maker (Smart Counter & Option Control)</title>
    
    <!-- MathJax for LaTeX equations -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Cropper.js for image cropping -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

    <style>
        :root { --primary: #1a237e; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 450px; background: #fff; border-right: 2px solid #ddd; display: flex; flex-direction: column; }
        .tab-btn-group { display: flex; background: #eee; }
        .tab-btn { flex: 1; padding: 12px; border: none; cursor: pointer; font-weight: bold; background: #eee; font-size: 13px; }
        .tab-btn.active { background: #fff; border-bottom: 2px solid var(--primary); color: var(--primary); }
        .panel { padding: 15px; flex: 1; overflow-y: auto; display: none; box-sizing: border-box; }
        .panel.active { display: block; }
        .admin-only { display: none; }
        .admin-active .admin-only { display: block; }
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 4px; font-size: 13px; }
        .input-group input, textarea, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .preview-area { 
            flex: 1; 
            background: #ffffff !important;
            display: flex; 
            justify-content: center; 
            padding: 20px; 
            overflow-y: auto; 
        }
        .exam-paper { 
            width: 210mm; 
            min-height: 297mm; 
            background: white; 
            box-sizing: border-box; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative; 
        }
        
        .header { text-align: center; margin-bottom: 5px; padding-bottom: 5px; }
        .header h1 { margin: 0; font-weight: bold; line-height: 1.3; font-size: 20px; }
        .header h2 { margin: 0; font-weight: bold; line-height: 1.3; font-size: 16px; }
        
        .header-info { margin: 0; font-weight: bold; text-align: center; display: block; line-height: 1.3; font-size: 12px; }
        #outSubjectLine { padding-bottom: 4px; margin-bottom: 8px; text-align: center; }

        .smart-counter-dashboard { background: var(--primary); color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .counter-stats { display: flex; justify-content: space-around; align-items: center; text-align: center; }
        .stat-item h4 { margin: 0; font-size: 10px; text-transform: uppercase; opacity: 0.8; }
        .stat-item .val { font-size: 24px; font-weight: bold; display: block; }
        .stat-item input { width: 50px; background: rgba(255,255,255,0.2); border: 1px solid white; color: white; text-align: center; border-radius: 4px; font-size: 18px; font-weight: bold; }
        .progress-line { width: 100%; background: rgba(255,255,255,0.1); height: 6px; border-radius: 10px; margin-top: 10px; overflow: hidden; }
        #fillBar { width: 0%; height: 100%; background: #4caf50; transition: 0.4s; }

        .restriction-box { background: #e8f5e9; border: 1px solid #c8e6c9; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        .restriction-box h4 { margin: 0 0 5px 0; color: #2e7d32; font-size: 14px; }
        .restriction-box input { border: 1px solid #a5d6a7 !important; background: #fff !important; }

        #outSetLine { position: absolute; top: 15px; right: 15px; border: 2px solid #000; padding: 3px 10px; font-weight: bold; font-size: 16px; display: none; }
        .marks-info { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 4px; border-bottom: 1px solid #ddd; padding-bottom: 2px; font-size: 12px; }
        .instruction { text-align: center; font-style: italic; font-weight: bold; margin-bottom: 10px; text-decoration: underline; font-size: 11px; }
        .question-container { column-gap: 35px; margin-top: 15px; column-rule: 1px solid #000; }
        .cq-box, .normal-q { break-inside: avoid; margin-bottom: 12px; display: block; }
        .sub-q { display: flex; justify-content: space-between; margin-bottom: 3px; }
        .mcq-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 4px; padding-left: 18px; }
        #ansSheetArea { margin-top: 25px; border-top: 2px dashed #333; padding-top: 15px; break-before: page; }
        .ans-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .ans-box { border: 1px solid #ccc; padding: 5px; border-radius: 3px; }
        .btn-action { border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; }
        .btn-mini { padding: 4px 10px; border: none; border-radius: 3px; color: white; cursor: pointer; font-size: 11px; margin-right: 5px; }
        .lock-status { padding: 10px; background: #1a237e; color: white; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        
        .q-card { 
            transition: 0.2s; 
            border: 1px solid #eee; 
            margin-bottom: 8px; 
            border-radius: 8px; 
            cursor: pointer; 
            background: #fff; 
            padding: 10px; 
            width: 100%; 
            box-sizing: border-box; 
            overflow-wrap: break-word;
            text-align: left !important;
        }
        .q-card:hover { background: #f9f9f9 !important; }
        .q-card-body { 
            white-space: pre-wrap; 
            color: #333; 
            margin: 8px 0; 
            line-height: 1.4; 
            word-break: break-word;
            text-align: left !important;
        }
        
        .q-card-options { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 4px; 
            color: #555; 
            background: #f1f8e9; 
            padding: 6px; 
            border-radius: 4px; 
            margin-top: 5px; 
            border: 1px solid #dcedc8; 
            box-sizing: border-box;
            text-align: left !important;
        }
        .q-card-options div { 
            word-break: break-all;
            text-align: left !important;
        }

        .board-tag { color: #d32f2f; font-weight: bold; font-size: 11px; margin-left: 5px; }
        .magic-tools { background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 10px; border: 1px solid #bbdefb; }
        #cropperModal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: #fff; width: 90%; max-width: 600px; margin: 50px auto; padding: 20px; border-radius: 8px; text-align: center; }
        #cropImageWrap { max-height: 400px; margin-bottom: 20px; overflow: hidden; }
        #cropImageWrap img { max-width: 100%; }
        
        /* ================== PAGINATION STYLES ================== */
        .selection-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .selection-pagination button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            min-width: 80px;
        }
        .selection-pagination button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .selection-page-info {
            font-weight: bold;
            color: var(--primary);
            font-size: 14px;
        }
        
        .output-pagination {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            border: 2px solid var(--primary);
        }
        .page-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            min-width: 80px;
        }
        .page-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .page-info {
            font-weight: bold;
            color: var(--primary);
            font-size: 16px;
            min-width: 120px;
            text-align: center;
        }
        .page-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f0f0f0;
            padding: 5px 15px;
            border-radius: 20px;
        }
        .page-input-group input {
            width: 50px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px;
        }
        
        .output-page {
            display: none;
            width: 100%;
            min-height: 297mm;
            box-sizing: border-box;
            position: relative;
            page-break-after: always;
            background: white !important;
        }
        .output-page.active {
            display: block;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 2px solid #000;
            padding-bottom: 8px;
        }
        
        .page-number {
            position: absolute;
            bottom: 10px;
            right: 20px;
            font-size: 11px;
            color: #666;
        }
        
        .pagination-settings {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .auto-page-indicator {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 10px;
        }
        
        /* Smart auto-pagination indicator */
        .page-status-indicator {
            background: #1976d2;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
            font-weight: bold;
        }
        /* ================== END PAGINATION STYLES ================== */
        
        /* Slider Styles */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        
        .slider-container input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .slider-container input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            color: var(--primary);
            font-size: 13px;
        }
        
        /* Active slider highlight */
        input[type="range"]:active {
            background: #d0d0d0;
        }
        
        input[type="range"]:active::-webkit-slider-thumb {
            background: #0d1b6b;
            transform: scale(1.1);
        }
        
        /* Slider labels */
        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
            margin-top: 3px;
        }
        
        /* Second page header styles */
        .second-page-header {
            display: none;
        }
        
        /* ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .chapter-header {
            background: #e8eaf6;
            color: var(--primary);
            padding: 8px 12px;
            border-radius: 6px;
            margin: 15px 0 10px 0;
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left !important;
        }

        .chapter-header strong {
            font-size: 14px;
            display: block;
        }

        .chapter-header small {
            font-size: 11px;
            color: #666;
        }

        /* ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶¨‡ßÉ‡¶§‡ßç‡¶§ */
        .chapter-serial-circle {
            background: var(--primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 13px;
            flex-shrink: 0;
        }
        
        /* MathJax Equation Styling */
        .MathJax_Display {
            text-align: left !important;
            margin: 10px 0 !important;
            padding: 5px 0 !important;
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            display: block !important;
        }
        
        .mjx-chtml {
            white-space: normal !important;
            word-wrap: break-word !important;
            display: inline-block !important;
        }
        
        .math-equation {
            display: block;
            margin: 8px 0;
            padding: 5px;
            text-align: center;
        }
        
        .equation-container {
            display: block !important;
            margin: 10px 0 !important;
            text-align: center !important;
        }
        
        /* MCQ option styling for equations */
        .mcq-option-equation {
            display: block;
            margin: 5px 0;
            padding: 3px 0;
            text-align: left;
        }
        
        /* Second page margin indicator */
        .second-page-margin-indicator {
            display: inline-block;
            background: #7b1fa2;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 5px;
            font-weight: bold;
        }
        
        /* Temporary Editor Styles */
        .temp-edit-q-item:hover {
            background: #e8f5e9 !important;
            border-color: #4caf50 !important;
        }

        .temp-edit-q-item.active {
            background: #e3f2fd !important;
            border-color: var(--primary) !important;
        }

        #tempEditBtn {
            background: #ff9800 !important;
            color: white !important;
            border: none !important;
            padding: 12px !important;
            border-radius: 5px !important;
            cursor: pointer !important;
            font-weight: bold !important;
            width: 100% !important;
            margin-top: 10px !important;
        }
        
        @media print { 
            body {
                background: white !important;
            }
            .sidebar { display: none; } 
            .preview-area { 
                padding: 0; 
                background: white !important;
                overflow: visible; 
            } 
            .exam-paper { 
                box-shadow: none !important; 
                width: 100%; 
                border: none; 
                margin: 0;
                overflow: visible;
                background: white !important;
            } 
            @page { 
                size: A4; 
                margin: 6mm 6mm 6mm 6mm;
            } 
            .question-container { column-rule: 1px solid #000; column-gap: 30px; } 
            #ansSheetArea.hidden-print { display: none !important; } 
            #outSetLine { display: block !important; border: 2px solid #000 !important; } 
            .output-pagination { display: none !important; }
            .output-page { 
                display: block !important; 
                min-height: 0;
                height: auto;
                page-break-after: always;
                margin: 0;
                padding: 0;
                background: white !important;
            }
            .output-page:last-child { page-break-after: auto; }
            .page-number { display: block !important; }
            
            /* ‚úÖ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® */
            .output-page:first-child {
                padding: 12mm 15mm 12mm 15mm !important;
            }
            .output-page:not(:first-child) {
                padding: 10mm 15mm 12mm 15mm !important;
            }
            
            /* Prevent questions from breaking across pages */
            .cq-box, .normal-q {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            /* Print optimization with smaller headers */
            .header h1 { 
                font-size: 18px !important; 
                margin: 3px 0 !important;
                padding: 0 !important;
            }
            .header h2 { 
                font-size: 14px !important; 
                margin: 2px 0 !important;
                padding: 0 !important;
            }
            .header-info { 
                font-size: 10px !important; 
                margin: 1px 0 !important;
                line-height: 1.2 !important;
            }
            .marks-info { 
                font-size: 10px !important; 
                margin: 3px 0 !important;
                padding-bottom: 1px !important;
            }
            .instruction { 
                font-size: 9px !important; 
                margin: 3px 0 !important;
            }
            .cq-box, .normal-q { 
                margin-bottom: 8px !important; 
            }
            .sub-q { 
                font-size: 9px !important; 
                margin-bottom: 2px !important;
            }
            .mcq-grid { 
                font-size: 9px !important; 
                gap: 2px !important;
                margin-top: 2px !important;
            }
            
            /* Hide header on second page and beyond */
            .output-page:not(:first-child) .header,
            .output-page:not(:first-child) .header-info,
            .output-page:not(:first-child) #outSubjectLine,
            .output-page:not(:first-child) .marks-info,
            .output-page:not(:first-child) .instruction,
            .output-page:not(:first-child) #outSetLine {
                display: none !important;
            }
            
            /* Remove border from subject line in print mode */
            #outSubjectLine { 
                padding-bottom: 2px !important; 
                margin-bottom: 4px !important; 
                text-align: center; 
            }
            /* ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞‡ßá‡¶∞ ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶∏‡ßç‡¶™‡ßá‡¶∏ ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü‡ßá‡¶ì ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶® */
            .question-container {
                margin-top: 8px !important;
            }
            /* MathJax equations in print */
            .MathJax_Display {
                margin: 3px 0 !important;
                page-break-inside: avoid !important;
            }
        }
        
        /* Auto page break hint for print preview */
        .print-page-break {
            display: none;
            text-align: center;
            color: #f44336;
            font-weight: bold;
            padding: 3px;
            margin: 5px 0;
            border-top: 2px dashed #f44336;
            font-size: 11px;
        }
        
        .print-preview-mode .print-page-break {
            display: block;
        }
        
        /* Duplicate warning style */
        .duplicate-warning {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: left;
        }
        
        .duplicate-warning h4 {
            color: #e65100;
            margin-top: 0;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .duplicate-warning-content {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ffcc80;
            margin: 10px 0;
            font-size: 13px;
        }
        
        .duplicate-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .duplicate-buttons button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>

    <!-- MathJax Configuration for proper equation display -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                processRefs: true,
                packages: {'[+]': ['ams', 'mathtools']}
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {load: ['[tex]/ams', '[tex]/mathtools']},
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    MathJax.typesetPromise();
                }
            },
            svg: {
                fontCache: 'global',
                scale: 1,
                linebreaks: { automatic: true }
            },
            CommonHTML: {
                linebreaks: { automatic: true }
            }
        };
    </script>

</head>
<body onload="checkLicense()">

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<!-- Image Cropper Modal -->
<div id="cropperModal">
    <div class="modal-content">
        <h3>‡¶õ‡¶¨‡¶ø ‡¶ï‡ßç‡¶∞‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
        <div id="cropImageWrap"><img id="cropImage" src=""></div>
        <button class="btn-action" style="background:var(--primary); color:white; width:auto; padding:10px 30px;" onclick="finishCrop()">‡¶ï‡ßç‡¶∞‡¶™ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button class="btn-action" style="background:#777; color:white; width:auto; padding:10px 30px;" onclick="closeCropper()">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
    </div>
</div>

<!-- Duplicate Warning Modal -->
<div id="duplicateWarningModal" style="display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.7);">
    <div style="background:white; width:90%; max-width:500px; margin:50px auto; padding:20px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
        <div id="duplicateWarningContent"></div>
    </div>
</div>

<!-- Sidebar -->
<div class="sidebar" id="sidebarMain">
    <div class="lock-status">
        <span id="lockText">üîí ‡¶Æ‡ßã‡¶°: <b id="currentModeDisplay">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£</b></span>
        <label style="cursor: pointer;"><input type="checkbox" id="adminToggle" onchange="toggleAdmin()"> ‡¶è‡¶°‡¶Æ‡¶ø‡¶®</label>
    </div>

    <div class="tab-btn-group">
        <button class="tab-btn active" onclick="openTab('select')">‡¶¨‡¶æ‡¶õ‡¶æ‡¶á</button>
        <button class="tab-btn" onclick="openTab('bank')">‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï</button>
        <button class="tab-btn" onclick="openTab('sets')">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
    </div>

    <!-- Selection Panel -->
    <div id="select" class="panel active">
        <div class="smart-counter-dashboard">
            <div class="counter-stats">
                <div class="stat-item"><h4>‡¶≤‡¶æ‡¶ó‡¶¨‡ßá</h4><input type="number" id="targetCount" value="10" oninput="updateCounter()"></div>
                <div style="width: 1px; height: 35px; background: rgba(255,255,255,0.2);"></div>
                <div class="stat-item"><h4>‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°</h4><span id="liveCount" class="val" style="color: #ffeb3b;">0</span></div>
            </div>
            <div class="progress-line"><div id="fillBar"></div></div>
            <div id="counterStatus" style="font-size: 11px; text-align: center; margin-top: 6px;">‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§</div>
        </div>

        <!-- ‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü/‡¶°‡¶ø‡¶∏‡ßá‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® -->
        <div style="margin-bottom: 15px; display: flex; gap: 5px;">
            <button onclick="selectAllQuestions()" style="flex:1; background:#1a237e; color:white; border:none; border-radius:4px; padding:10px; cursor:pointer; font-weight:bold;">‡¶∏‡¶¨ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button onclick="deselectAllQuestions()" style="flex:1; background:#d32f2f; color:white; border:none; border-radius:4px; padding:10px; cursor:pointer; font-weight:bold;">‡¶∏‡¶¨ ‡¶°‡¶ø‡¶∏‡ßá‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>

        <div class="magic-tools">
            <label style="font-size: 12px; font-weight: bold;">üé≤ ‡¶Ö‡¶ü‡ßã ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü‡¶∞</label>
            <div style="display: flex; gap: 5px; margin-top: 5px;">
                <input type="number" id="randomCount" placeholder="‡¶ï‡¶Ø‡¶º‡¶ü‡¶ø?" style="width: 70px; padding: 5px;">
                <button onclick="autoSelectRandom()" style="flex:1; background:#673ab7; color:white; border:none; border-radius:4px; cursor:pointer;">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¨‡¶æ‡¶õ‡¶æ‡¶á ‡¶ï‡¶∞‡ßã</button>
            </div>
            <button onclick="shuffleSelectedQuestions()" style="width:100%; margin-top:5px; background:#ff9800; color:white; border:none; border-radius:4px; padding:8px; cursor:pointer; font-weight:bold;">üîÄ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶â‡¶≤‡¶ü-‡¶™‡¶æ‡¶≤‡¶ü ‡¶ï‡¶∞‡ßã</button>
        </div>

        <div id="filterGroup" style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 10px; border:1px solid #ddd;">
            <div class="admin-only restriction-box">
                <h4>üîí ‡¶∏‡¶æ‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶∞‡ßá‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ï‡¶∂‡¶®</h4>
                <input type="text" id="lockBox" placeholder="‡¶â‡¶¶‡¶æ: ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ, ‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø" oninput="saveData(); updateSubFilter()" class="input-group" style="margin-bottom:0;">
                <small style="font-size:10px; color:#666;">‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶ó‡ßÅ‡¶≤‡ßã ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</small>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 5px;">
                <select id="fClass" onchange="renderSelectionList()" style="padding:8px; border-radius:4px;">
                    <option value="">‡¶∏‡¶¨ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø</option>
                    <option value="HSC">HSC</option>
                    <option value="‡¶¶‡¶∂‡¶Æ">‡¶¶‡¶∂‡¶Æ</option>
                    <option value="‡¶®‡¶¨‡¶Æ">‡¶®‡¶¨‡¶Æ</option>
                    <option value="‡¶Ö‡¶∑‡ßç‡¶ü‡¶Æ">‡¶Ö‡¶∑‡ßç‡¶ü‡¶Æ</option>
                    <option value="‡¶∏‡¶™‡ßç‡¶§‡¶Æ">‡¶∏‡¶™‡ßç‡¶§‡¶Æ</option>
                    <option value="‡¶∑‡¶∑‡ßç‡¶†">‡¶∑‡¶∑‡ßç‡¶†</option>
                    <option value="‡¶™‡¶û‡ßç‡¶ö‡¶Æ">‡¶™‡¶û‡ßç‡¶ö‡¶Æ</option>
                    <option value="‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶•">‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶•</option>
                    <option value="‡¶§‡ßÉ‡¶§‡ßÄ‡ßü">‡¶§‡ßÉ‡¶§‡ßÄ‡ßü</option>
                    <option value="‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü">‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü</option>
                    <option value="‡¶™‡ßç‡¶∞‡¶•‡¶Æ">‡¶™‡ßç‡¶∞‡¶•‡¶Æ</option>
                </select>
                <select id="fDiv" onchange="renderSelectionList()" style="padding:8px; border-radius:4px;">
                    <option value="">‡¶∏‡¶¨ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó</option>
                    <option value="‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£</option>
                    <option value="‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®">‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®</option>
                    <option value="‡¶Æ‡¶æ‡¶®‡¶¨‡¶ø‡¶ï">‡¶Æ‡¶æ‡¶®‡¶¨‡¶ø‡¶ï</option>
                    <option value="‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ">‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ</option>
                </select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 5px;">
                <select id="fSub" onchange="updateChapterFilter(); renderSelectionList()" style="padding:8px; border-radius:4px;"></select>
                <select id="fChap" onchange="renderSelectionList()" style="padding:8px; border-radius:4px;">
                    <option value="">‡¶∏‡¶¨ ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º</option>
                </select>
            </div>
            
            <select id="fType" onchange="renderSelectionList()" style="width:100%; padding:8px; border-radius:4px;">
                <option value="">‡¶∏‡¶¨ ‡¶ß‡¶∞‡¶®</option>
                <option value="normal">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£</option>
                <option value="cq">‡¶∏‡ßÉ‡¶ú‡¶®‡¶∂‡ßÄ‡¶≤</option>
                <option value="mcq">MCQ</option>
            </select>
        </div>
        
        <!-- Selection Questions List with Pagination -->
        <div id="selectionList"></div>
        
        <!-- Selection Pagination Controls -->
        <div id="selectionPagination" class="selection-pagination" style="display: none;">
            <button onclick="changeSelectionPage(-1)" id="selectionPrevBtn">‚Üê ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞</button>
            <div class="selection-page-info" id="selectionPageInfo">‡¶™‡ßá‡¶ú 1/1</div>
            <button onclick="changeSelectionPage(1)" id="selectionNextBtn">‡¶™‡¶∞‡ßá‡¶∞ ‚Üí</button>
        </div>
        
        <!-- Temporary Edit Button - This will be added dynamically -->
        <button id="tempEditBtn" class="btn-action" style="background:#ff9800; color:white; margin-top:10px; display:none;" onclick="openTemporaryEditor()">üñäÔ∏è ‡¶ü‡ßá‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡¶æ‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü</button>
        
        <button class="btn-action" style="background:#2e7d32; color:white; margin-top:15px;" onclick="window.print()">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü / PDF</button>
    </div>

    <!-- Bank Panel -->
    <div id="bank" class="panel">
        <div class="admin-only">
            <h3>‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ø‡ßã‡¶ó/‡¶è‡¶°‡¶ø‡¶ü</h3>
            <input type="hidden" id="editIndex" value="-1">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <select id="qClassInput" class="input-group" style="margin-bottom:0;">
                    <option value="">‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                    <option value="HSC">HSC</option>
                    <option value="‡¶¶‡¶∂‡¶Æ">‡¶¶‡¶∂‡¶Æ</option>
                    <option value="‡¶®‡¶¨‡¶Æ">‡¶®‡¶¨‡¶Æ</option>
                    <option value="‡¶Ö‡¶∑‡ßç‡¶ü‡¶Æ">‡¶Ö‡¶∑‡ßç‡¶ü‡¶Æ</option>
                    <option value="‡¶∏‡¶™‡ßç‡¶§‡¶Æ">‡¶∏‡¶™‡ßç‡¶§‡¶Æ</option>
                    <option value="‡¶∑‡¶∑‡ßç‡¶†">‡¶∑‡¶∑‡ßç‡¶†</option>
                    <option value="‡¶™‡¶û‡ßç‡¶ö‡¶Æ">‡¶™‡¶û‡ßç‡¶ö‡¶Æ</option>
                    <option value="‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶•">‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶•</option>
                    <option value="‡¶§‡ßÉ‡¶§‡ßÄ‡ßü">‡¶§‡ßÉ‡¶§‡ßÄ‡ßü</option>
                    <option value="‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü">‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü</option>
                    <option value="‡¶™‡ßç‡¶∞‡¶•‡¶Æ">‡¶™‡ßç‡¶∞‡¶•‡¶Æ</option>
                </select>
                <select id="qDivInput" class="input-group" style="margin-bottom:0;">
                    <option value="">‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                    <option value="‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£</option>
                    <option value="‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®">‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®</option>
                    <option value="‡¶Æ‡¶æ‡¶®‡¶¨‡¶ø‡¶ï">‡¶Æ‡¶æ‡¶®‡¶¨‡¶ø‡¶ï</option>
                    <option value="‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ">‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ</option>
                </select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="text" id="qSub" placeholder="‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º" class="input-group" oninput="checkDuplicateWhileTyping()">
                <input type="text" id="qChap" placeholder="‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º" class="input-group" oninput="checkDuplicateWhileTyping()">
            </div>
            <select id="qType" onchange="toggleFields(); checkDuplicateWhileTyping()" class="input-group">
                <option value="normal">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£</option>
                <option value="cq">‡¶∏‡ßÉ‡¶ú‡¶®‡¶∂‡ßÄ‡¶≤</option>
                <option value="mcq">MCQ</option>
            </select>
            <label id="showOptionsLabel" style="display:none; align-items:center; cursor:pointer; font-weight:bold; margin-bottom:10px; font-size: 13px; color: var(--primary);">
                <input type="checkbox" id="showOptionsToggle" checked style="width:auto; margin-right:8px;"> ‡¶Ö‡¶™‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
            </label>
            <textarea id="qBody" rows="3" placeholder="‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®..." class="input-group" oninput="checkDuplicateWhileTyping()"></textarea>
            <input type="text" id="qAns" placeholder="‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞" class="input-group" oninput="checkDuplicateWhileTyping()">
            <input type="text" id="qBoard" placeholder="‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶ì ‡¶∏‡¶æ‡¶≤" class="input-group">
            <div id="extraFields" style="display:none; background:#f5f5f5; padding:10px; border-radius:5px; margin-bottom:10px;">
                <input type="text" id="qA" placeholder="‡¶ï" class="input-group" oninput="checkDuplicateWhileTyping()">
                <input type="text" id="qB" placeholder="‡¶ñ" class="input-group" oninput="checkDuplicateWhileTyping()">
                <input type="text" id="qC" placeholder="‡¶ó" class="input-group" oninput="checkDuplicateWhileTyping()">
                <input type="text" id="qD" placeholder="‡¶ò" class="input-group" oninput="checkDuplicateWhileTyping()">
            </div>
            <input type="file" id="qImg" accept="image/*" class="input-group" onchange="handleImage(event)">
            <div id="imgPreview" style="margin: 5px 0;"></div>
            
            <!-- Duplicate Check Status -->
            <div id="duplicateStatus" style="display:none; margin:10px 0; padding:10px; border-radius:5px; text-align:center; font-size:13px;"></div>
            
            <button class="btn-action" id="saveBtn" style="background:var(--primary); color:white;" onclick="addQuestionWithDuplicateCheck()">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn-action" style="background:#777; color:white; display:none;" id="cancelBtn" onclick="cancelEdit()">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
            
            <!-- Duplicate Management Section -->
            <div style="margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; border: 1px solid #ffb74d;">
                <h4 style="color: #e65100; margin-top: 0; margin-bottom: 10px;">üîÑ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h4>
                
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn-action" style="background: #ff9800; color: white;" onclick="findAndShowAllDuplicates()">
                        üîç ‡¶∏‡¶¨ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®
                    </button>
                    
                    <button class="btn-action" style="background: #f44336; color: white;" onclick="removeAllDuplicates()">
                        üóëÔ∏è ‡¶∏‡¶¨ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
                    </button>
                    
                    <div style="font-size: 12px; color: #666; text-align: center;">
                        ‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®: <span id="totalQuestionCount">0</span>‡¶ü‡¶ø
                    </div>
                </div>
            </div>
            
            <!-- Equation Help Text -->
            <div style="background:#e3f2fd; padding:10px; border-radius:5px; margin-top:15px; font-size:12px;">
                <strong>‡¶á‡¶ï‡ßÅ‡ßü‡ßá‡¶∂‡¶® ‡¶≤‡¶ø‡¶ñ‡¶æ‡¶∞ ‡¶®‡¶ø‡ßü‡¶Æ:</strong><br>
                1. ‡¶è‡¶ï ‡¶≤‡¶æ‡¶á‡¶®‡ßá‡¶∞ ‡¶á‡¶ï‡ßÅ‡ßü‡ßá‡¶∂‡¶®: $E = mc^2$<br>
                2. ‡¶¨‡ßú ‡¶á‡¶ï‡ßÅ‡ßü‡ßá‡¶∂‡¶® (‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡¶æ‡¶á‡¶®‡ßá): $$x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}$$<br>
                3. MCQ ‡¶Ö‡¶™‡¶∂‡¶®‡ßá: ‡¶ï: $$v = \sqrt{\frac{eV_0}{m}}$$<br>
                4. ‡¶≤‡¶æ‡¶á‡¶® ‡¶¨‡ßç‡¶∞‡ßá‡¶ï‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø: Enter ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®<br>
                5. ‡¶¨‡ßú ‡¶¨‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ü: $$\left(\frac{a}{b}\right)$$
            </div>
        </div>
        <div class="admin-hide-msg" style="text-align:center; color:#999; margin-top:30px;"><p>‚ö†Ô∏è ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®‡•§</p></div>
    </div>

    <!-- Settings Panel -->
    <div id="sets" class="panel">
        <div style="background: #fff8e1; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #ffe082;">
            <label style="display:flex; align-items:center; cursor:pointer; font-weight:bold;">
                <input type="checkbox" id="showAnsKey" checked onchange="sync()" style="width:auto; margin-right:10px;"> 
                ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü‡ßá ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶™‡¶§‡ßç‡¶∞ ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®
            </label>
        </div>
        
        <h4 style="color:var(--primary); margin-top:0; border-bottom:1px solid #ddd;">‚öôÔ∏è ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶≤ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h4>
        
        <div class="input-group">
            <label>‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü</label>
            <input type="text" id="hSet" placeholder="‡¶ï" oninput="sync()">
        </div>
        
        <div class="input-group">
            <label>‡¶≠‡¶æ‡¶∑‡¶æ</label>
            <select id="qLang" onchange="sync()">
                <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
                <option value="en">‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø</option>
            </select>
        </div>
        
        <div class="input-group">
            <label>‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
            <input type="text" id="h1" value="‡¶∂‡ßá‡¶∞‡¶ñ‡¶æ‡¶≤‡ßÄ ‡¶∏‡¶∞‡¶ï‡¶æ‡¶∞‡¶ø ‡¶Æ‡¶π‡¶ø‡¶≤‡¶æ ‡¶ï‡¶≤‡ßá‡¶ú" oninput="sync()">
            <div class="slider-container">
                <input type="range" id="fsH1" min="14" max="40" value="20" oninput="updateSliderValue('fsH1', this.value + 'px'); updateHeaders(); sync()">
                <span class="slider-value" id="fsH1Value">20px</span>
            </div>
            <div class="slider-label">
                <span>‡¶õ‡ßã‡¶ü</span>
                <span>‡¶¨‡¶°‡¶º</span>
            </div>
        </div>
        
        <div class="input-group">
            <label>‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
            <input type="text" id="h2" value="‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ-‡ß®‡ß¶‡ß®‡ß¨" oninput="sync()">
            <div class="slider-container">
                <input type="range" id="fsH2" min="12" max="30" value="16" oninput="updateSliderValue('fsH2', this.value + 'px'); updateHeaders(); sync()">
                <span class="slider-value" id="fsH2Value">16px</span>
            </div>
            <div class="slider-label">
                <span>‡¶õ‡ßã‡¶ü</span>
                <span>‡¶¨‡¶°‡¶º</span>
            </div>
        </div>
  
        <div class="input-group">
            <label>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø (‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶≤‡¶æ‡¶á‡¶®)</label>
            <input type="text" id="hClass" placeholder="‡¶è‡¶ï‡¶æ‡¶¶‡¶∂ (‡¶Æ‡¶æ‡¶®‡¶¨‡¶ø‡¶ï)" oninput="sync()">
        </div>
        
        <div class="input-group">
            <label>‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º (‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶≤‡¶æ‡¶á‡¶®)</label>
            <input type="text" id="h3" oninput="sync()">
        </div>
        
        <div class="input-group">
            <label>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø ‡¶ì ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶∏‡¶æ‡¶á‡¶ú</label>
            <div class="slider-container">
                <input type="range" id="fsH3" min="10" max="22" value="13" oninput="updateSliderValue('fsH3', this.value + 'px'); updateHeaders(); sync()">
                <span class="slider-value" id="fsH3Value">13px</span>
            </div>
            <div class="slider-label">
                <span>‡¶õ‡ßã‡¶ü</span>
                <span>‡¶¨‡¶°‡¶º</span>
            </div>
        </div>

        <div style="display: flex; gap: 5px;">
            <div class="input-group">
                <label>‡¶∏‡¶Æ‡¶Ø‡¶º</label>
                <input type="text" id="hTime" oninput="sync()">
            </div>
            <div class="input-group">
                <label>‡¶Æ‡¶æ‡¶®</label>
                <input type="text" id="hMarks" oninput="sync()">
            </div>
        </div>
        
        <div class="input-group">
            <label>‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶ø‡¶ï‡¶æ</label>
            <input type="text" id="hInst" oninput="sync()">
            <div class="slider-container">
                <input type="range" id="fsH4" min="10" max="20" value="13" oninput="updateSliderValue('fsH4', this.value + 'px'); updateHeaders(); sync()">
                <span class="slider-value" id="fsH4Value">13px</span>
            </div>
            <div class="slider-label">
                <span>‡¶õ‡ßã‡¶ü</span>
                <span>‡¶¨‡¶°‡¶º</span>
            </div>
        </div>
        
        <!-- Pagination Settings -->
        <div class="pagination-settings">
            <h4 style="color:var(--primary); margin-top:0; margin-bottom:10px;">üìÑ ‡¶™‡ßá‡¶ú‡¶ø‡¶®‡ßá‡¶∂‡¶® ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h4>
            <div class="input-group">
                <label>‡¶¨‡¶æ‡¶õ‡¶æ‡¶á‡¶§‡ßá ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶™‡ßá‡¶ú‡ßá ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®</label>
                <input type="number" id="selectionPerPage" value="10" min="1" max="50" oninput="saveData(); renderSelectionList()">
            </div>
            <div class="input-group">
                <label>‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü‡ßá ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶™‡ßá‡¶ú‡ßá ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®</label>
                <input type="number" id="outputPerPage" value="30" min="15" max="60" oninput="saveData(); renderOutputPages()">
            </div>
            <div style="background: #e8f5e9; padding: 10px; border-radius: 5px; margin-top: 10px;">
                <label style="font-weight: bold; color: #2e7d32; display: block; margin-bottom: 5px;">
                    üìÑ ‡¶Ö‡¶™‡¶ü‡¶ø‡¶Æ‡¶æ‡¶á‡¶ú‡¶° ‡¶≤‡ßá‡¶Ü‡¶â‡¶ü: <span class="page-status-indicator">‡ß©‡ß¶ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®/‡¶™‡ßá‡¶ú</span>
                </label>
                <small style="color:#666; display:block;">‡¶è‡¶ï ‡¶™‡ßá‡¶ú‡ßá ‡ß©‡ß¶‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶´‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡¶ü‡¶ø‡¶Æ‡¶æ‡¶á‡¶ú‡¶°‡•§</small>
                <small style="color:#666; display:block;">‡ß®‡ßü ‡¶™‡¶æ‡¶§‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá ‡¶®‡¶æ</small>
            </div>
            <label style="display:flex; align-items:center; cursor:pointer; font-weight:bold; margin-top:10px; font-size:13px;">
                <input type="checkbox" id="showPageNumbers" checked onchange="saveData(); renderOutputPages()" style="width:auto; margin-right:8px;"> 
                ‡¶™‡ßá‡¶ú ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
            </label>
            <label style="display:flex; align-items:center; cursor:pointer; font-weight:bold; margin-top:10px; font-size:13px;">
                <input type="checkbox" id="showOutputPagination" checked onchange="toggleOutputPagination()" style="width:auto; margin-right:8px;"> 
                ‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü ‡¶™‡ßá‡¶ú‡¶ø‡¶®‡ßá‡¶∂‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
            </label>
        </div>
        
        <!-- ‚úÖ ‡ß®‡ßü ‡¶™‡¶æ‡¶§‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡ßß‡ß¶mm (‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶°) -->
        <div style="background: #f3e5f5; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ce93d8;">
            <h4 style="color: #7b1fa2; margin-top: 0; margin-bottom: 8px;">üìÑ ‡ß®‡ßü ‡¶™‡¶æ‡¶§‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h4>
            <div style="display: flex; align-items: center; gap: 10px; background: white; padding: 10px; border-radius: 6px; border: 1px solid #d1c4e9;">
                <div style="width: 40px; height: 40px; background: #7b1fa2; color: white; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; font-size: 18px;">
                    ‡ßß‡ß¶
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: bold; color: #7b1fa2; font-size: 16px;">‡ß®‡ßü ‡¶™‡¶æ‡¶§‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶®: ‡ßß‡ß¶mm</div>
                    <small style="color:#666; display:block;">‡ß®‡ßü, ‡ß©‡ßü, ... ‡¶™‡¶æ‡¶§‡¶æ‡¶∞ ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡ßß‡ß¶mm</small>
                    <small style="color:#666; display:block;">‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶™‡¶æ‡¶§‡¶æ: ‡ßß‡ß®mm | ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶™‡¶æ‡¶§‡¶æ: ‡ßß‡ß¶mm</small>
                </div>
            </div>
        </div>
        
        <div class="input-group">
            <label style="color: blue;">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ó‡ßç‡¶Ø‡¶æ‡¶™ (Spacing)</label>
            <div class="slider-container">
                <input type="range" id="qGapSlider" min="0" max="50" value="12" oninput="updateSliderValue('qGapSlider', this.value + 'px'); sync()">
                <span class="slider-value" id="qGapSliderValue">12px</span>
            </div>
            <div class="slider-label">
                <span>‡¶∏‡¶Ç‡¶ï‡ßÄ‡¶∞‡ßç‡¶£</span>
                <span>‡¶´‡¶æ‡¶Å‡¶ï‡¶æ</span>
            </div>
        </div>        
        
        <div class="input-group">
            <label>‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú</label>
            <div class="slider-container">
                <input type="range" id="fSize" min="10" max="20" value="13" oninput="updateSliderValue('fSize', this.value + 'px'); sync()">
                <span class="slider-value" id="fSizeValue">13px</span>
            </div>
            <div class="slider-label">
                <span>‡¶õ‡ßã‡¶ü</span>
                <span>‡¶¨‡¶°‡¶º</span>
            </div>
        </div>
        
        <div class="input-group">
            <label>‡¶≤‡¶æ‡¶á‡¶® ‡¶∏‡ßç‡¶™‡ßá‡¶∏‡¶ø‡¶Ç</label>
            <div class="slider-container">
                <input type="range" id="lHeight" min="1.0" max="2.5" step="0.1" value="1.3" oninput="updateSliderValue('lHeight', this.value); sync()">
                <span class="slider-value" id="lHeightValue">1.3</span>
            </div>
            <div class="slider-label">
                <span>‡¶∏‡¶Ç‡¶ï‡ßÄ‡¶∞‡ßç‡¶£</span>
                <span>‡¶´‡¶æ‡¶Å‡¶ï‡¶æ</span>
            </div>
        </div>
        
        <div class="input-group">
            <label>‡¶ï‡¶≤‡¶æ‡¶Æ</label>
            <select id="colCount" onchange="sync()">
                <option value="2">‡ß® ‡¶ï‡¶≤‡¶æ‡¶Æ</option>
                <option value="1">‡ßß ‡¶ï‡¶≤‡¶æ‡¶Æ</option>
            </select>
        </div>
        
        <h4 style="color:var(--primary); margin-top:20px; border-bottom:1px solid #ddd;">üìê ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ (‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶™‡¶æ‡¶§‡¶æ)</h4>
        
        <div class="input-group">
            <label>‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® (‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶™‡¶æ‡¶§‡¶æ)</label>
            <div class="slider-container">
                <input type="range" id="mTop" min="5" max="30" value="12" oninput="updateSliderValue('mTop', this.value + 'mm'); sync()">
                <span class="slider-value" id="mTopValue">12mm</span>
            </div>
            <div class="slider-label">
                <span>‡¶õ‡ßã‡¶ü</span>
                <span>‡¶¨‡¶°‡¶º</span>
            </div>
        </div>
        
        <div class="input-group">
            <label>‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶®</label>
            <div class="slider-container">
                <input type="range" id="mBottom" min="5" max="30" value="12" oninput="updateSliderValue('mBottom', this.value + 'mm'); sync()">
                <span class="slider-value" id="mBottomValue">12mm</span>
            </div>
            <div class="slider-label">
                <span>‡¶õ‡ßã‡¶ü</span>
                <span>‡¶¨‡¶°‡¶º</span>
            </div>
        </div>
        
        <div class="input-group">
            <label>‡¶¨‡¶æ‡¶Æ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶®</label>
            <div class="slider-container">
                <input type="range" id="mLeft" min="5" max="30" value="15" oninput="updateSliderValue('mLeft', this.value + 'mm'); sync()">
                <span class="slider-value" id="mLeftValue">15mm</span>
            </div>
            <div class="slider-label">
                <span>‡¶õ‡ßã‡¶ü</span>
                <span>‡¶¨‡¶°‡¶º</span>
            </div>
        </div>
        
        <div class="input-group">
            <label>‡¶°‡¶æ‡¶® ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶®</label>
            <div class="slider-container">
                <input type="range" id="mRight" min="5" max="30" value="15" oninput="updateSliderValue('mRight', this.value + 'mm'); sync()">
                <span class="slider-value" id="mRightValue">15mm</span>
            </div>
            <div class="slider-label">
                <span>‡¶õ‡ßã‡¶ü</span>
                <span>‡¶¨‡¶°‡¶º</span>
            </div>
        </div>
        
        <button class="btn-action" style="background:#555; color:white; margin-top:20px;" onclick="exportJSON()">üì• ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™</button>
        <button class="btn-action" style="background:#00796b; color:white;" onclick="document.getElementById('importFile').click()">üì§ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞</button>
        <input type="file" id="importFile" style="display:none;" onchange="importJSON(event)">
    </div>
</div>

<!-- Preview Area -->
<div class="preview-area" id="previewArea">
    <div id="examPaper" class="exam-paper">
        <!-- Output Pages Container -->
        <div id="outputPagesContainer"></div>
        
        <!-- Answer Sheet -->
        <div id="ansSheetArea"><h3 style="text-align:center; border-bottom: 1px solid #000; margin-bottom:10px; font-size: 16px;">‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶Æ‡¶æ‡¶≤‡¶æ</h3><div id="ansGrid" class="ans-grid"></div></div>
    </div>
</div>

<!-- Output Pagination Controls -->
<div id="outputPagination" class="output-pagination">
    <div style="display: flex; align-items: center; gap: 15px;">
        <button class="page-btn" onclick="changeOutputPage(-1)" id="outputPrevBtn">‚Üê ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶™‡ßá‡¶ú</button>
        <div class="page-info" id="outputPageInfo">‡¶™‡ßá‡¶ú 1/1</div>
        <button class="page-btn" onclick="changeOutputPage(1)" id="outputNextBtn">‡¶™‡¶∞‡ßá‡¶∞ ‡¶™‡ßá‡¶ú ‚Üí</button>
    </div>
    <div class="page-input-group">
        <span>‡¶Ø‡¶æ‡¶®:</span>
        <input type="number" id="jumpToOutputPage" min="1" value="1" onchange="jumpToOutputPage()">
        <span>/<span id="totalOutputPagesDisplay">1</span></span>
    </div>
</div>

<script>
    let questionBank = [];
    const DB_KEY = 'bcti_v25_final';
    let currentImgData = "", cropper;
    const MASTER_KEY = "BCTI-2026-PRO";
    
    // Pagination Variables
    let selectionCurrentPage = 1;
    let outputCurrentPage = 1;
    let selectionPerPage = 10;
    let outputPerPage = 30;
    let totalSelectionPages = 1;
    let totalOutputPages = 1;
    
    // Temporary Edits Storage
    let temporaryEdits = new Map();
    let currentEditingIndex = 0;

    function checkLicense() { 
        const savedKey = localStorage.getItem('bcti_app_license'); 
        if (savedKey !== MASTER_KEY) { 
            const userInput = prompt("License Key:"); 
            if (userInput === MASTER_KEY) { localStorage.setItem('bcti_app_license', userInput); loadData(); } 
            else { document.body.innerHTML = `<h1>Invalid Access</h1>`; } 
        } else { loadData(); } 
    }
    
    // ==================== TEMPORARY EDIT FUNCTIONS ====================
    
    function openTemporaryEditor() {
        const selectedQuestions = questionBank.filter(q => q.selected);
        if (selectedQuestions.length === 0) {
            alert("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!");
            return;
        }
        
        let editorHTML = `
            <div id="temporaryEditorModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10001; display:flex; justify-content:center; align-items:center;">
                <div style="background:white; width:90%; max-width:800px; height:80%; border-radius:10px; padding:20px; display:flex; flex-direction:column;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0; color:var(--primary);">üñäÔ∏è ‡¶ü‡ßá‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡¶æ‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü‡¶∞</h3>
                        <button onclick="closeTemporaryEditor()" style="background:#f44336; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">‚úñ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </div>
                    
                    <div style="display:flex; gap:15px; flex:1; overflow:hidden;">
                        <!-- Left: Question List -->
                        <div style="width:40%; border-right:1px solid #ddd; padding-right:15px; overflow-y:auto;">
                            <h4 style="margin-top:0; color:#555;">‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® (${selectedQuestions.length}‡¶ü‡¶ø)</h4>
                            <div id="tempEditQuestionList" style="display:flex; flex-direction:column; gap:8px;">
                                ${selectedQuestions.map((q, index) => `
                                    <div class="temp-edit-q-item" onclick="loadQuestionForEditing(${index})" 
                                         style="padding:10px; border:1px solid #ddd; border-radius:5px; cursor:pointer; background:#f9f9f9;"
                                         id="tempQItem${index}">
                                        <strong style="color:var(--primary);">${index + 1}. ${q.sub}</strong>
                                        <div style="font-size:12px; color:#666; margin-top:3px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                                            ${q.body.substring(0, 50)}${q.body.length > 50 ? '...' : ''}
                                        </div>
                                        <div style="font-size:11px; color:#888; margin-top:5px;">
                                            ${temporaryEdits.has(index) ? '<span style="color:#4caf50;">‚úì ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ</span>' : '<span style="color:#999;">‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø</span>'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Right: Editor -->
                        <div style="width:60%; display:flex; flex-direction:column;">
                            <div id="tempEditCurrentQuestionInfo" style="background:#e3f2fd; padding:10px; border-radius:5px; margin-bottom:10px;">
                                <strong>‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® #1</strong> ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                            </div>
                            
                            <div style="flex:1; overflow-y:auto; margin-bottom:15px;">
                                <div class="input-group">
                                    <label>‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü</label>
                                    <textarea id="tempEditQuestionBody" rows="6" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:5px;" placeholder="‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®..."></textarea>
                                </div>
                                
                                <div id="tempEditOptionsSection" style="display:none;">
                                    <h4 style="margin-top:15px; margin-bottom:10px;">MCQ ‡¶Ö‡¶™‡¶∂‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π</h4>
                                    <div class="input-group">
                                        <label>‡¶ï</label>
                                        <input type="text" id="tempEditOptionA" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:5px;">
                                    </div>
                                    <div class="input-group">
                                        <label>‡¶ñ</label>
                                        <input type="text" id="tempEditOptionB" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:5px;">
                                    </div>
                                    <div class="input-group">
                                        <label>‡¶ó</label>
                                        <input type="text" id="tempEditOptionC" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:5px;">
                                    </div>
                                    <div class="input-group">
                                        <label>‡¶ò</label>
                                        <input type="text" id="tempEditOptionD" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:5px;">
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <label>‡¶â‡¶§‡ßç‡¶§‡¶∞ (‡¶Ø‡¶¶‡¶ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®)</label>
                                    <input type="text" id="tempEditAnswer" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:5px;" placeholder="‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞...">
                                </div>
                            </div>
                            
                            <div style="display:flex; gap:10px;">
                                <button onclick="saveTemporaryEdit()" style="flex:1; background:var(--primary); color:white; border:none; padding:12px; border-radius:5px; cursor:pointer; font-weight:bold;">üíæ ‡¶è‡¶°‡¶ø‡¶ü ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                                <button onclick="resetTemporaryEdit()" style="flex:1; background:#ff9800; color:white; border:none; padding:12px; border-radius:5px; cursor:pointer; font-weight:bold;">üîÑ ‡¶Æ‡ßÇ‡¶≤ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡ßá ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top:15px; padding-top:15px; border-top:1px solid #ddd; display:flex; justify-content:space-between;">
                        <button onclick="applyTemporaryEditsToPreview()" style="background:#4caf50; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-weight:bold;">üëÅÔ∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â‡¶§‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                        <button onclick="clearAllTemporaryEdits()" style="background:#f44336; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-weight:bold;">üóëÔ∏è ‡¶∏‡¶¨ ‡¶è‡¶°‡¶ø‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
                        <button onclick="closeTemporaryEditorAndUpdate()" style="background:#2196f3; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-weight:bold;">‚úÖ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', editorHTML);
        loadQuestionForEditing(0);
    }
    
    function closeTemporaryEditor() {
        const editor = document.getElementById('temporaryEditorModal');
        if (editor) editor.remove();
    }
    
    function closeTemporaryEditorAndUpdate() {
        renderOutputPages(); // Update preview with temporary edits
        closeTemporaryEditor();
        alert("‡¶ü‡ßá‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡¶æ‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶è‡¶ñ‡¶® ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
    }
    
    function loadQuestionForEditing(index) {
        currentEditingIndex = index;
        const selectedQuestions = questionBank.filter(q => q.selected);
        const question = selectedQuestions[index];
        
        // Update question list highlight
        document.querySelectorAll('.temp-edit-q-item').forEach(item => {
            item.style.background = '#f9f9f9';
            item.style.borderColor = '#ddd';
        });
        const currentItem = document.getElementById(`tempQItem${index}`);
        if (currentItem) {
            currentItem.style.background = '#e3f2fd';
            currentItem.style.borderColor = 'var(--primary)';
        }
        
        // Update info
        document.getElementById('tempEditCurrentQuestionInfo').innerHTML = `
            <strong>‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® #${index + 1}</strong> - ${question.sub} (${question.type === 'cq' ? '‡¶∏‡ßÉ‡¶ú‡¶®‡¶∂‡ßÄ‡¶≤' : question.type === 'mcq' ? 'MCQ' : '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£'})
            <br><small style="color:#666;">${question.chap ? '‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º: ' + question.chap : ''}</small>
        `;
        
        // Load original or edited content
        let editedContent = temporaryEdits.get(index);
        
        document.getElementById('tempEditQuestionBody').value = editedContent ? editedContent.body : question.body;
        document.getElementById('tempEditAnswer').value = editedContent ? editedContent.ans : question.ans || '';
        
        // Handle MCQ options
        const optionsSection = document.getElementById('tempEditOptionsSection');
        if (question.type === 'mcq' || question.type === 'cq') {
            optionsSection.style.display = 'block';
            document.getElementById('tempEditOptionA').value = editedContent ? editedContent.a : question.a || '';
            document.getElementById('tempEditOptionB').value = editedContent ? editedContent.b : question.b || '';
            document.getElementById('tempEditOptionC').value = editedContent ? editedContent.c : question.c || '';
            document.getElementById('tempEditOptionD').value = editedContent ? editedContent.d : question.d || '';
        } else {
            optionsSection.style.display = 'none';
        }
    }
    
    function saveTemporaryEdit() {
        const selectedQuestions = questionBank.filter(q => q.selected);
        const originalQuestion = selectedQuestions[currentEditingIndex];
        
        const editedQuestion = {
            body: document.getElementById('tempEditQuestionBody').value.trim(),
            ans: document.getElementById('tempEditAnswer').value.trim(),
            a: originalQuestion.type === 'mcq' || originalQuestion.type === 'cq' ? 
               document.getElementById('tempEditOptionA').value.trim() : '',
            b: originalQuestion.type === 'mcq' || originalQuestion.type === 'cq' ? 
               document.getElementById('tempEditOptionB').value.trim() : '',
            c: originalQuestion.type === 'mcq' || originalQuestion.type === 'cq' ? 
               document.getElementById('tempEditOptionC').value.trim() : '',
            d: originalQuestion.type === 'mcq' || originalQuestion.type === 'cq' ? 
               document.getElementById('tempEditOptionD').value.trim() : '',
            type: originalQuestion.type,
            sub: originalQuestion.sub,
            chap: originalQuestion.chap,
            originalIndex: currentEditingIndex
        };
        
        // Save to temporary edits map
        temporaryEdits.set(currentEditingIndex, editedQuestion);
        
        // Update UI
        const itemElement = document.getElementById(`tempQItem${currentEditingIndex}`);
        if (itemElement) {
            itemElement.innerHTML = `
                <strong style="color:var(--primary);">${currentEditingIndex + 1}. ${originalQuestion.sub}</strong>
                <div style="font-size:12px; color:#666; margin-top:3px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    ${editedQuestion.body.substring(0, 50)}${editedQuestion.body.length > 50 ? '...' : ''}
                </div>
                <div style="font-size:11px; color:#4caf50; margin-top:5px;">
                    ‚úì ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
                </div>
            `;
        }
        
        alert(`‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® #${currentEditingIndex + 1} ‡¶è‡¶∞ ‡¶è‡¶°‡¶ø‡¶ü ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá (‡¶Ö‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá)‡•§`);
    }
    
    function resetTemporaryEdit() {
        temporaryEdits.delete(currentEditingIndex);
        loadQuestionForEditing(currentEditingIndex);
        alert(`‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® #${currentEditingIndex + 1} ‡¶Æ‡ßÇ‡¶≤ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡•§`);
    }
    
    function clearAllTemporaryEdits() {
        if (temporaryEdits.size > 0 && confirm("‡¶∏‡¶¨ ‡¶ü‡ßá‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡¶æ‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            temporaryEdits.clear();
            loadQuestionForEditing(currentEditingIndex);
            alert("‡¶∏‡¶¨ ‡¶ü‡ßá‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡¶æ‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
        }
    }
    
    function applyTemporaryEditsToPreview() {
        renderOutputPages(); // This will use temporary edits
        alert("‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Ç‡¶∏‡ßç‡¶ï‡¶∞‡¶£ ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â‡¶§‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§ ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§");
    }
    
    // Modified renderOutputPages function to use temporary edits
    const originalRenderOutputPages = renderOutputPages;
    renderOutputPages = function() {
        const selected = questionBank.filter(q => q.selected);
        
        if (selected.length === 0) {
            return originalRenderOutputPages.call(this);
        }
        
        // If there are temporary edits, create a modified copy
        let questionsToRender = selected;
        if (temporaryEdits.size > 0) {
            questionsToRender = selected.map((q, index) => {
                if (temporaryEdits.has(index)) {
                    const edit = temporaryEdits.get(index);
                    return {
                        ...q,
                        body: edit.body,
                        ans: edit.ans || q.ans,
                        a: edit.a || q.a,
                        b: edit.b || q.b,
                        c: edit.c || q.c,
                        d: edit.d || q.d
                    };
                }
                return q;
            });
        }
        
        // Temporarily replace selected questions with modified version
        const originalSelected = [...selected];
        
        // Call the original function but with modified questions
        const tempQuestionBank = questionBank.map(q => {
            const isSelected = q.selected;
            if (isSelected) {
                const selectedIndex = originalSelected.indexOf(q);
                if (selectedIndex !== -1 && temporaryEdits.has(selectedIndex)) {
                    const edit = temporaryEdits.get(selectedIndex);
                    return {
                        ...q,
                        body: edit.body,
                        ans: edit.ans || q.ans,
                        a: edit.a || q.a,
                        b: edit.b || q.b,
                        c: edit.c || q.c,
                        d: edit.d || q.d
                    };
                }
            }
            return q;
        });
        
        // Save original questionBank and temporarily replace it
        const originalQuestionBank = [...questionBank];
        questionBank = tempQuestionBank;
        
        // Call original render function
        originalRenderOutputPages.call(this);
        
        // Restore original questionBank
        questionBank = originalQuestionBank;
    };
    
    // Add temporary edit button to selection panel
    function addTemporaryEditButton() {
        const selectionPanel = document.getElementById('select');
        const printButton = selectionPanel.querySelector('.btn-action[style*="background:#2e7d32"]');
        
        if (printButton && !document.getElementById('tempEditBtn')) {
            const tempEditBtn = document.createElement('button');
            tempEditBtn.id = 'tempEditBtn';
            tempEditBtn.className = 'btn-action';
            tempEditBtn.style.cssText = 'background:#ff9800; color:white; margin-top:10px;';
            tempEditBtn.innerHTML = 'üñäÔ∏è ‡¶ü‡ßá‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡¶æ‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü';
            tempEditBtn.onclick = openTemporaryEditor;
            
            printButton.parentNode.insertBefore(tempEditBtn, printButton);
        }
        
        // Show the button
        if (document.getElementById('tempEditBtn')) {
            document.getElementById('tempEditBtn').style.display = 'block';
        }
    }
    
    // Initialize the button when page loads
    setTimeout(addTemporaryEditButton, 1000);
    
    // ==================== DUPLICATE PREVENTION FUNCTIONS ====================
    
    // ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶®‡¶∞‡¶Æ‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (‡¶∏‡ßç‡¶™‡ßá‡¶∏, ‡¶ï‡ßá‡¶∏ ‡¶á‡¶ó‡¶®‡ßã‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
    function normalizeText(text) {
        if (!text) return '';
        return text
            .trim()
            .toLowerCase()
            .replace(/\s+/g, ' ') // ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶∏‡ßç‡¶™‡ßá‡¶∏‡¶ï‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßç‡¶™‡ßá‡¶∏‡ßá
            .replace(/[^\w\u0980-\u09FF\s$\(\)\[\]\{\}\+\-\*\/=<>!@#%^&|~`]/g, '') // ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶æ‡¶∞ ‡¶∏‡¶∞‡¶æ‡¶®‡ßã
            .replace(/\n/g, ' ') // ‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡¶æ‡¶á‡¶®‡¶ï‡ßá ‡¶∏‡ßç‡¶™‡ßá‡¶∏‡ßá
            .replace(/\./g, '') // ‡¶°‡¶ü ‡¶∏‡¶∞‡¶æ‡¶®‡ßã
            .replace(/,/g, '') // ‡¶ï‡¶Æ‡¶æ ‡¶∏‡¶∞‡¶æ‡¶®‡ßã
            .replace(/;/g, '') // ‡¶∏‡ßá‡¶Æ‡¶ø‡¶ï‡ßã‡¶≤‡¶® ‡¶∏‡¶∞‡¶æ‡¶®‡ßã
            .replace(/:/g, '') // ‡¶ï‡ßã‡¶≤‡¶® ‡¶∏‡¶∞‡¶æ‡¶®‡ßã
            .replace(/\?/g, ''); // ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶¨‡ßã‡¶ß‡¶ï ‡¶ö‡¶ø‡¶π‡ßç‡¶® ‡¶∏‡¶∞‡¶æ‡¶®‡ßã
    }
    
    // ‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶Æ‡¶ø‡¶≤ ‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function findExactDuplicate(newQuestion) {
        const newBodyNormalized = normalizeText(newQuestion.body);
        
        for (let i = 0; i < questionBank.length; i++) {
            const existing = questionBank[i];
            const existingBodyNormalized = normalizeText(existing.body);
            
            // 1. ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï
            if (newBodyNormalized === existingBodyNormalized && newBodyNormalized !== '') {
                return {
                    found: true,
                    type: 'exact_text',
                    question: existing,
                    index: i,
                    confidence: 100
                };
            }
            
            // 2. MCQ/CQ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡ßã‡¶ì ‡¶ö‡ßá‡¶ï
            if (newQuestion.type === 'mcq' || newQuestion.type === 'cq') {
                if (existing.type === newQuestion.type) {
                    // ‡¶Ö‡¶™‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ö‡ßá‡¶ï
                    const newANormalized = normalizeText(newQuestion.a);
                    const newBNormalized = normalizeText(newQuestion.b);
                    const newCNormalized = normalizeText(newQuestion.c);
                    const newDNormalized = normalizeText(newQuestion.d);
                    
                    const existingANormalized = normalizeText(existing.a);
                    const existingBNormalized = normalizeText(existing.b);
                    const existingCNormalized = normalizeText(existing.c);
                    const existingDNormalized = normalizeText(existing.d);
                    
                    // ‡¶∏‡¶¨ ‡¶Ö‡¶™‡¶∂‡¶® ‡¶Æ‡¶ø‡¶≤‡¶≤‡ßá
                    if (newANormalized === existingANormalized &&
                        newBNormalized === existingBNormalized &&
                        newCNormalized === existingCNormalized &&
                        newDNormalized === existingDNormalized &&
                        newBodyNormalized === existingBodyNormalized) {
                        return {
                            found: true,
                            type: 'exact_mcq',
                            question: existing,
                            index: i,
                            confidence: 100
                        };
                    }
                }
            }
            
            // 3. 90%+ ‡¶Æ‡¶ø‡¶≤ ‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ (‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü)
            if (newBodyNormalized.length > 20 && existingBodyNormalized.length > 20) {
                const similarity = calculateSimilarity(newBodyNormalized, existingBodyNormalized);
                if (similarity > 90) {
                    return {
                        found: true,
                        type: 'similar',
                        question: existing,
                        index: i,
                        confidence: similarity
                    };
                }
            }
        }
        
        return { found: false, type: 'none', question: null, index: -1, confidence: 0 };
    }
    
    // ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶∏‡¶ø‡¶Æ‡¶ø‡¶≤‡¶æ‡¶∞‡¶ø‡¶ü‡¶ø ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function calculateSimilarity(str1, str2) {
        if (str1 === str2) return 100;
        
        const longer = str1.length > str2.length ? str1 : str2;
        const shorter = str1.length > str2.length ? str2 : str1;
        
        if (longer.length === 0) return 100;
        
        // ‡¶∏‡¶π‡¶ú ‡¶∏‡¶ø‡¶Æ‡¶ø‡¶≤‡¶æ‡¶∞‡¶ø‡¶ü‡¶ø ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶∂‡¶®
        let matches = 0;
        for (let i = 0; i < shorter.length; i++) {
            if (longer.includes(shorter[i])) {
                matches++;
            }
        }
        
        return Math.round((matches / longer.length) * 100);
    }
    
    // ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶®‡¶ø‡¶Ç ‡¶∂‡ßã ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function showDuplicateWarning(duplicateInfo, newQuestion, callback) {
        const modal = document.getElementById('duplicateWarningModal');
        const content = document.getElementById('duplicateWarningContent');
        
        let warningHTML = `
            <div class="duplicate-warning">
                <h4>‚ö†Ô∏è ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá!</h4>
                
                <div class="duplicate-warning-content">
                    <p><strong>‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®:</strong></p>
                    <p>${newQuestion.body.substring(0, 150)}${newQuestion.body.length > 150 ? '...' : ''}</p>
                    
                    <p style="margin-top:10px;"><strong>‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® (#${duplicateInfo.index + 1}):</strong></p>
                    <p>${duplicateInfo.question.body.substring(0, 150)}${duplicateInfo.question.body.length > 150 ? '...' : ''}</p>
                    
                    <p style="margin-top:10px; color:#d32f2f;">
                        <strong>‡¶Æ‡¶ø‡¶≤‡ßá‡¶∞ ‡¶π‡¶æ‡¶∞:</strong> ${duplicateInfo.confidence}%<br>
                        <strong>‡¶ß‡¶∞‡¶®:</strong> ${duplicateInfo.type === 'exact_text' ? '‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶Æ‡¶ø‡¶≤' : 
                                             duplicateInfo.type === 'exact_mcq' ? '‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ MCQ ‡¶Æ‡¶ø‡¶≤' : '‡¶Ö‡¶®‡ßÅ‡¶∞‡ßÇ‡¶™ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®'}
                    </p>
                </div>
                
                <div class="duplicate-buttons">
                    <button onclick="hideDuplicateWarning(); callback(false)" style="background:#4caf50; color:white;">
                        ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ)
                    </button>
                    <button onclick="hideDuplicateWarning(); callback(true)" style="background:#f44336; color:white;">
                        ‡¶§‡¶¨‡ßÅ‡¶ì ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                </div>
            </div>
        `;
        
        content.innerHTML = warningHTML;
        modal.style.display = 'block';
    }
    
    function hideDuplicateWarning() {
        document.getElementById('duplicateWarningModal').style.display = 'none';
    }
    
    // ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£‡ßá‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function addQuestionWithDuplicateCheck() {
        const editIdx = parseInt(document.getElementById('editIndex').value);
        
        // ‡¶è‡¶°‡¶ø‡¶ü ‡¶Æ‡ßã‡¶°‡ßá ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®
        if (editIdx > -1) {
            addQuestion();
            return;
        }
        
        const newQuestion = getQuestionFromForm();
        
        // ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶® ‡¶ö‡ßá‡¶ï
        if (!newQuestion.sub || !newQuestion.body) {
            alert("‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá!");
            return;
        }
        
        // ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶ö‡ßá‡¶ï
        const duplicateInfo = findExactDuplicate(newQuestion);
        
        if (duplicateInfo.found && duplicateInfo.confidence >= 90) {
            // ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá - ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶®‡¶ø‡¶Ç ‡¶∂‡ßã ‡¶ï‡¶∞‡ßÅ‡¶®
            showDuplicateWarning(duplicateInfo, newQuestion, function(shouldSave) {
                if (shouldSave) {
                    // ‡¶§‡¶¨‡ßÅ‡¶ì ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶á‡¶≤‡ßá
                    questionBank.push(newQuestion);
                    saveData();
                    updateSubFilter();
                    updateChapterFilter();
                    updateQuestionCount();
                    selectionCurrentPage = 1;
                    renderSelectionList();
                    alert("‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá (‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶•‡¶æ‡¶ï‡¶æ ‡¶∏‡¶§‡ßç‡¶§‡ßç‡¶¨‡ßá‡¶ì)‡•§");
                    clearForm();
                }
            });
        } else {
            // ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®
            questionBank.push(newQuestion);
            saveData();
            updateSubFilter();
            updateChapterFilter();
            updateQuestionCount();
            selectionCurrentPage = 1;
            renderSelectionList();
            alert("‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§");
            clearForm();
        }
    }
    
    // ‡¶´‡¶∞‡ßç‡¶Æ ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function getQuestionFromForm() {
        return { 
            sub: document.getElementById('qSub').value.trim(), 
            qClass: document.getElementById('qClassInput').value,
            qDiv: document.getElementById('qDivInput').value,
            chap: document.getElementById('qChap').value.trim(), 
            type: document.getElementById('qType').value, 
            body: document.getElementById('qBody').value.trim(), 
            ans: document.getElementById('qAns').value.trim(), 
            board: document.getElementById('qBoard').value.trim(), 
            a: document.getElementById('qA').value.trim(), 
            b: document.getElementById('qB').value.trim(), 
            c: document.getElementById('qC').value.trim(), 
            d: document.getElementById('qD').value.trim(), 
            img: currentImgData, 
            selected: false,
            showOptions: document.getElementById('showOptionsToggle').checked
        };
    }
    
    // ‡¶´‡¶∞‡ßç‡¶Æ ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function clearForm() {
        document.getElementById('qSub').value = '';
        document.getElementById('qChap').value = '';
        document.getElementById('qBody').value = '';
        document.getElementById('qAns').value = '';
        document.getElementById('qBoard').value = '';
        document.getElementById('qA').value = '';
        document.getElementById('qB').value = '';
        document.getElementById('qC').value = '';
        document.getElementById('qD').value = '';
        document.getElementById('imgPreview').innerHTML = '';
        currentImgData = '';
        document.getElementById('duplicateStatus').style.display = 'none';
    }
    
    // ‡¶ü‡¶æ‡¶á‡¶™ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function checkDuplicateWhileTyping() {
        const duplicateStatus = document.getElementById('duplicateStatus');
        const question = getQuestionFromForm();
        
        if (!question.body || question.body.trim().length < 10) {
            duplicateStatus.style.display = 'none';
            return;
        }
        
        const duplicateInfo = findExactDuplicate(question);
        
        if (duplicateInfo.found) {
            duplicateStatus.style.display = 'block';
            if (duplicateInfo.confidence === 100) {
                duplicateStatus.innerHTML = `
                    <div style="background:#ffebee; color:#c62828; padding:8px; border-radius:4px; border:1px solid #ef9a9a;">
                        ‚ö†Ô∏è <strong>‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá!</strong> ‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶Ü‡¶õ‡ßá (#${duplicateInfo.index + 1})‡•§
                    </div>
                `;
                document.getElementById('saveBtn').style.background = '#f44336';
            } else if (duplicateInfo.confidence >= 90) {
                duplicateStatus.innerHTML = `
                    <div style="background:#fff3e0; color:#e65100; padding:8px; border-radius:4px; border:1px solid #ffcc80;">
                        ‚ö†Ô∏è <strong>‡¶Ö‡¶®‡ßÅ‡¶∞‡ßÇ‡¶™ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®!</strong> ${duplicateInfo.confidence}% ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá (#${duplicateInfo.index + 1})‡•§
                    </div>
                `;
                document.getElementById('saveBtn').style.background = '#ff9800';
            }
        } else {
            duplicateStatus.style.display = 'none';
            document.getElementById('saveBtn').style.background = 'var(--primary)';
        }
    }
    
    // ‡¶∏‡¶¨ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function findAndShowAllDuplicates() {
        const duplicates = [];
        const seen = new Set();
        
        for (let i = 0; i < questionBank.length; i++) {
            for (let j = i + 1; j < questionBank.length; j++) {
                const q1 = questionBank[i];
                const q2 = questionBank[j];
                
                const q1Normalized = normalizeText(q1.body);
                const q2Normalized = normalizeText(q2.body);
                
                // ‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶Æ‡¶ø‡¶≤ ‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ
                if (q1Normalized === q2Normalized && q1Normalized !== '') {
                    const pairId = `${Math.min(i, j)}-${Math.max(i, j)}`;
                    if (!seen.has(pairId)) {
                        seen.add(pairId);
                        duplicates.push({
                            index1: i,
                            question1: q1,
                            index2: j,
                            question2: q2,
                            type: 'exact'
                        });
                    }
                }
            }
        }
        
        if (duplicates.length === 0) {
            alert("‡¶ï‡ßã‡¶® ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§");
            return;
        }
        
        let message = `‡¶Æ‡ßã‡¶ü ${duplicates.length} ‡¶ú‡ßã‡ßú‡¶æ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶õ‡ßá:\n\n`;
        
        duplicates.forEach((dup, idx) => {
            message += `${idx + 1}. ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® #${dup.index1 + 1} ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® #${dup.index2 + 1}\n`;
            message += `   ‡¶¨‡¶ø‡¶∑‡ßü: ${dup.question1.sub} | ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º: ${dup.question1.chap}\n`;
            message += `   ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®: ${dup.question1.body.substring(0, 80)}...\n\n`;
        });
        
        message += "\n‡¶∏‡¶¨ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá '‡¶∏‡¶¨ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®' ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
        
        if (confirm(`${duplicates.length} ‡¶ú‡ßã‡ßú‡¶æ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá‡•§ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá OK ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®‡•§`)) {
            alert(message);
        }
    }
    
    // ‡¶∏‡¶¨ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function removeAllDuplicates() {
        if (!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶¨ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?\n\n‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ï‡¶™‡¶ø ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡¶¨‡ßá‡•§")) {
            return;
        }
        
        const uniqueQuestions = [];
        const seen = new Set();
        let removedCount = 0;
        
        questionBank.forEach((q, index) => {
            const normalizedBody = normalizeText(q.body);
            const questionKey = `${q.sub}|${q.chap}|${normalizedBody}`;
            
            if (!seen.has(questionKey)) {
                seen.add(questionKey);
                uniqueQuestions.push(q);
            } else {
                removedCount++;
            }
        });
        
        questionBank = uniqueQuestions;
        saveData();
        updateSubFilter();
        updateChapterFilter();
        updateQuestionCount();
        renderSelectionList();
        
        alert(`${removedCount}‡¶ü‡¶ø ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ${uniqueQuestions.length}‡¶ü‡¶ø ‡¶Ö‡¶®‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∞‡ßá‡¶ñ‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
    }
    
    // ‡¶á‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡ßç‡¶ü‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶ö‡ßá‡¶ï
    function importJSON(e) { 
        const r = new FileReader(); 
        r.onload = (ev) => { 
            const importedData = JSON.parse(ev.target.result);
            
            if (!importedData.qs || !Array.isArray(importedData.qs)) {
                alert("‡¶´‡¶æ‡¶á‡¶≤ ‡¶´‡¶∞‡ßç‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü!");
                return;
            }
            
            let newQuestions = importedData.qs;
            let duplicates = 0;
            let added = 0;
            const seen = new Set();
            
            // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø seen ‡¶∏‡ßá‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
            questionBank.forEach(q => {
                const normalizedBody = normalizeText(q.body);
                const questionKey = `${q.sub}|${q.chap}|${normalizedBody}`;
                seen.add(questionKey);
            });
            
            // ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶á‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡ßç‡¶ü‡ßá‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
            newQuestions.forEach(newQ => {
                const normalizedBody = normalizeText(newQ.body);
                const questionKey = `${newQ.sub}|${newQ.chap}|${normalizedBody}`;
                
                if (seen.has(questionKey)) {
                    duplicates++;
                } else {
                    seen.add(questionKey);
                    questionBank.push(newQ);
                    added++;
                }
            });
            
            if (duplicates > 0) {
                alert(`${added}‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ${duplicates}‡¶ü‡¶ø ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¨‡¶æ‡¶¶ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
            } else {
                alert(`${added}‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶á‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
            }
            
            saveData();
            updateQuestionCount();
            location.reload();
        }; 
        r.readAsText(e.target.files[0]); 
    }
    
    // ‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function updateQuestionCount() {
        document.getElementById('totalQuestionCount').textContent = questionBank.length;
    }
    
    // ==================== END DUPLICATE FUNCTIONS ====================
    
    function selectAllQuestions() {
        // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        const subF = document.getElementById('fSub').value;
        const classF = document.getElementById('fClass').value;
        const divF = document.getElementById('fDiv').value;
        const typeF = document.getElementById('fType').value;
        const chapF = document.getElementById('fChap').value;
        
        questionBank.forEach((q, i) => {
            // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
            const matchesFilter = (!subF || q.sub === subF) && 
                                 (!classF || q.qClass === classF) && 
                                 (!divF || q.qDiv === divF) && 
                                 (!typeF || q.type === typeF) &&
                                 (!chapF || q.chap === chapF);
            
            if (matchesFilter) {
                q.selected = true;
            }
        });
        
        saveData();
        renderSelectionList();
        alert("‡¶∏‡¶ï‡¶≤ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
    }

    function deselectAllQuestions() {
        // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶°‡¶ø‡¶∏‡ßá‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        const subF = document.getElementById('fSub').value;
        const classF = document.getElementById('fClass').value;
        const divF = document.getElementById('fDiv').value;
        const typeF = document.getElementById('fType').value;
        const chapF = document.getElementById('fChap').value;
        
        questionBank.forEach((q, i) => {
            // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶°‡¶ø‡¶∏‡ßá‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
            const matchesFilter = (!subF || q.sub === subF) && 
                                 (!classF || q.qClass === classF) && 
                                 (!divF || q.qDiv === divF) && 
                                 (!typeF || q.type === typeF) &&
                                 (!chapF || q.chap === chapF);
            
            if (matchesFilter) {
                q.selected = false;
            }
        });
        
        saveData();
        renderSelectionList();
        alert("‡¶∏‡¶ï‡¶≤ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶°‡¶ø‡¶∏‡ßá‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
    }
    
    function processMathInText(text) {
        if (!text) return '';
        
        // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶∏‡¶¨ ‡¶¨‡ßã‡¶≤‡ßç‡¶° ‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó ‡¶∏‡¶∞‡¶ø‡ßü‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®
        let processed = text.replace(/<b>/gi, '').replace(/<\/b>/gi, '');
        processed = processed.replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
        
        processed = processed.replace(/\n/g, '<br>');
        
        processed = processed.replace(/\$\$(.*?)\$\$/g, function(match, equation) {
            return `<div class="equation-container">\\[${equation}\\]</div>`;
        });
        
        processed = processed.replace(/\$(.*?)\$/g, '\\($1\\)');
        
        processed = processed.replace(/\\\[/g, '\\[').replace(/\\\]/g, '\\]');
        
        if (text.includes('‡¶ï:') || text.includes('‡¶ñ:') || text.includes('‡¶ó:') || text.includes('‡¶ò:')) {
            processed = processed.replace(/(‡¶ï|‡¶ñ|‡¶ó|‡¶ò):/g, '<div class="mcq-option-equation"><span>$1:</span> ');
            processed = processed + '</div>';
        }
        
        return processed;
    }
    
    function renderMathJax() {
        if (window.MathJax && window.MathJax.typesetPromise) {
            MathJax.typesetPromise().catch(err => console.log('MathJax typeset error:', err));
        } else if (window.MathJax && window.MathJax.Hub) {
            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
        }
    }
    
    function updateCounter() {
        const selected = questionBank.filter(q => q.selected).length;
        const target = parseInt(document.getElementById('targetCount').value) || 0;
        document.getElementById('liveCount').innerText = selected;
        let percent = target > 0 ? (selected / target) * 100 : 0;
        const bar = document.getElementById('fillBar');
        const status = document.getElementById('counterStatus');
        bar.style.width = (percent > 100 ? 100 : percent) + "%";
        if(selected < target) { status.innerText = `‡¶Ü‡¶∞‡¶ì ${target - selected}‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá`; bar.style.background = "#ffeb3b"; } 
        else if(selected == target) { status.innerText = "‚úÖ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!"; bar.style.background = "#4caf50"; } 
        else { status.innerText = `‚ö†Ô∏è ${selected - target}‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¨‡ßá‡¶∂‡¶ø!`; bar.style.background = "#f44336"; }
    }

    function renderSelectionList() {
        document.getElementById('selectionList').style.textAlign = 'left';
        
        const isAdmin = document.getElementById('adminToggle').checked;
        const subF = document.getElementById('fSub').value;
        const classF = document.getElementById('fClass').value;
        const divF = document.getElementById('fDiv').value;
        const typeF = document.getElementById('fType').value;
        const chapF = document.getElementById('fChap').value;
        
        let filtered = questionBank.map((q, i) => ({...q, originalIndex: i})).filter(q => {
            return (!subF || q.sub === subF) && 
                   (!classF || q.qClass === classF) && 
                   (!divF || q.qDiv === divF) && 
                   (!typeF || q.type === typeF) &&
                   (!chapF || q.chap === chapF);
        });
        
        const chapterGroups = {};
        filtered.forEach(q => {
            const chapter = q.chap || '‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü‡¶π‡ßÄ‡¶®';
            if (!chapterGroups[chapter]) {
                chapterGroups[chapter] = [];
            }
            chapterGroups[chapter].push(q);
        });
        
        selectionPerPage = parseInt(document.getElementById('selectionPerPage').value) || 10;
        totalSelectionPages = Math.ceil(filtered.length / selectionPerPage);
        if (totalSelectionPages < 1) totalSelectionPages = 1;
        if (selectionCurrentPage > totalSelectionPages) selectionCurrentPage = totalSelectionPages;
        
        const startIndex = (selectionCurrentPage - 1) * selectionPerPage;
        const endIndex = startIndex + selectionPerPage;
        const pagedQuestions = filtered.slice(startIndex, endIndex);
        
        const chapterCounters = {};
        
        let outputHTML = '';
        let currentChapter = null;
        
        pagedQuestions.forEach((q, localIndex) => {
            const chapter = q.chap || '‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü‡¶π‡ßÄ‡¶®';
            
            if (chapter !== currentChapter) {
                currentChapter = chapter;
                
                const totalInChapter = filtered.filter(item => item.chap === chapter).length;
                
                outputHTML += `
                    <div class="chapter-header">
                        <div style="text-align: left;">
                            <strong>üìö ${chapter}</strong>
                            <small style="display: block;">‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®: ${totalInChapter}‡¶ü‡¶ø</small>
                        </div>
                        <div style="text-align: left;">
                            <small>${q.sub} | ${q.type === 'cq' ? '‡¶∏‡ßÉ‡¶ú‡¶®‡¶∂‡ßÄ‡¶≤' : q.type === 'mcq' ? 'MCQ' : '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£'}</small>
                        </div>
                    </div>
                `;
            }
            
            chapterCounters[chapter] = (chapterCounters[chapter] || 0) + 1;
            const chapterSerialNumber = chapterCounters[chapter];
            
            let optHtml = "";
            if (q.type !== 'normal') {
                const options = [
                    { label: '‡¶ï', value: q.a || '-' },
                    { label: '‡¶ñ', value: q.b || '-' },
                    { label: '‡¶ó', value: q.c || '-' },
                    { label: '‡¶ò', value: q.d || '-' }
                ];
                
                optHtml = `
                    <div class="q-card-options">
                        ${options.map(opt => `
                            <div style="text-align: left; padding-left: 0; margin-bottom: 8px; display: flex; align-items: flex-start; flex-direction: column;">
                                <div style="display: flex; align-items: flex-start; width: 100%;">
                                    <b style="margin-right: 8px; flex-shrink: 0;">${opt.label}:</b>
                                    <div style="flex: 1; text-align: left;">${processMathInText(opt.value)}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
            }
            
            outputHTML += `
            <div class="q-card" onclick="toggleQ(${q.originalIndex})" style="border-left: ${q.selected ? '6px solid var(--primary)' : '1px solid #eee'}">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="chapter-serial-circle">
                            ${chapterSerialNumber}
                        </div>
                        <div style="text-align: left; font-size: 12px; color: #555;">
                            <span style="font-weight: bold;">${q.sub}</span> 
                            ${q.qClass ? `| ${q.qClass}` : ''}
                        </div>
                    </div>
                    ${q.board ? `<div class="board-tag" style="color: #d32f2f; font-weight: bold; font-size: 11px; background: #ffebee; padding: 2px 8px; border-radius: 3px; border: 1px solid #ffcdd2;">${q.board}</div>` : ''}
                </div>
                
                <div class="q-card-body" style="text-align: left; padding-left: 0; margin-left: 0; padding-right: 0;">
                    <div style="display: flex; align-items: flex-start; gap: 4px; text-align: left;">
                        <b style="flex-shrink: 0;">${chapterSerialNumber}.</b>
                        <div style="text-align: left; width: 100%;">${processMathInText(q.body)}</div>
                    </div>
                </div>
                ${optHtml}
                
                <div style="margin-top:10px; display: ${isAdmin ? 'flex' : 'none'}; gap: 5px; text-align: left;">
                    <button class="btn-mini" style="background:#1976d2; flex:1;" onclick="editQuestion(${q.originalIndex}, event)">üìù Edit</button>
                    <button class="btn-mini" style="background:#d32f2f; flex:1;" onclick="deleteQuestion(${q.originalIndex}, event)">üóëÔ∏è Delete</button>
                </div>
            </div>`;
        });
        
        if (outputHTML === '') {
            outputHTML = '<p style="text-align:center; color:#666; padding:20px;">‡¶ï‡ßã‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>';
        }
        
        document.getElementById('selectionList').innerHTML = outputHTML;
        
        updateSelectionPagination();
        
        sync();
        renderOutputPages();
        updateCounter();
        
        setTimeout(renderMathJax, 100);
    }

    function updateSelectionPagination() {
        const paginationDiv = document.getElementById('selectionPagination');
        if (totalSelectionPages > 1) {
            paginationDiv.style.display = 'flex';
        } else {
            paginationDiv.style.display = 'none';
        }
        
        document.getElementById('selectionPageInfo').innerText = `‡¶™‡ßá‡¶ú ${selectionCurrentPage}/${totalSelectionPages}`;
        document.getElementById('selectionPrevBtn').disabled = selectionCurrentPage === 1;
        document.getElementById('selectionNextBtn').disabled = selectionCurrentPage === totalSelectionPages;
    }

    function changeSelectionPage(delta) {
        selectionCurrentPage += delta;
        if (selectionCurrentPage < 1) selectionCurrentPage = 1;
        if (selectionCurrentPage > totalSelectionPages) selectionCurrentPage = totalSelectionPages;
        
        renderSelectionList();
    }

    function toggleQ(i) { 
        questionBank[i].selected = !questionBank[i].selected; 
        saveData(); 
        renderSelectionList();
    }

    function renderOutputPages() {
        const selected = questionBank.filter(q => q.selected);
        const showPageNumbers = document.getElementById('showPageNumbers').checked;
        
        // Clear previous pages
        document.getElementById('outputPagesContainer').innerHTML = '';
        
        // If no questions, show empty page
        if (selected.length === 0) {
            totalOutputPages = 1;
            outputCurrentPage = 1;
            
            // ‚úÖ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶™‡¶æ‡¶§‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶°‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶ø‡¶®
            const topMargin = document.getElementById('mTop').value || '12';
            const rightMargin = document.getElementById('mRight').value || '15';
            const bottomMargin = document.getElementById('mBottom').value || '12';
            const leftMargin = document.getElementById('mLeft').value || '15';
            
            let pageHeader = `
            <div id="outSetLine"></div>
            <div class="header"><h1 id="outH1"></h1><h2 id="outH2"></h2></div>
            <div id="outClassLine" class="header-info"></div>
            <div id="outSubjectLine" class="header-info" style="margin-bottom:10px;"></div>
            <div class="marks-info"><span id="outTime"></span><span id="outMarks"></span></div>
            <div id="outInst" class="instruction"></div>`;
            
            let pageFooter = '';
            if (showPageNumbers) {
                pageFooter = `<div class="page-number">‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ 1/1</div>`;
            }
            
            document.getElementById('outputPagesContainer').innerHTML = `
            <div id="output-page-1" class="output-page active" style="padding: ${topMargin}mm ${rightMargin}mm ${bottomMargin}mm ${leftMargin}mm !important;">
                ${pageHeader}
                <div class="question-container" style="column-count: ${document.getElementById('colCount').value}; text-align: center; padding: 50px;">
                    <p style="font-size: 18px; color: #666;">‡¶ï‡ßã‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶¨‡¶æ‡¶Æ ‡¶™‡¶æ‡¶∂ ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                </div>
                ${pageFooter}
            </div>`;
            
            // Update header elements
            updateHeaders();
            updateOutputPagination();
            
            return;
        }
        
        // Get output per page setting
        outputPerPage = parseInt(document.getElementById('outputPerPage').value) || 30;
        if (outputPerPage < 15) outputPerPage = 15;
        if (outputPerPage > 60) outputPerPage = 60;
        
        // Calculate number of pages needed based on questions
        totalOutputPages = Math.ceil(selected.length / outputPerPage);
        if (totalOutputPages < 1) totalOutputPages = 1;
        
        // Create pages
        let pagesHTML = '';
        
        // Get font size and line height from slider
        const currentFontSize = document.getElementById('fSize').value;
        const currentLineHeight = document.getElementById('lHeight').value;
        
        // ‚úÖ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶™‡¶æ‡¶§‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶°‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶ø‡¶®
        const topMargin = document.getElementById('mTop').value || '12';
        const rightMargin = document.getElementById('mRight').value || '15';
        const bottomMargin = document.getElementById('mBottom').value || '12';
        const leftMargin = document.getElementById('mLeft').value || '15';
        
        // ‚úÖ ‡ß®‡ßü ‡¶™‡¶æ‡¶§‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡ßß‡ß¶mm
        const secondPageTopMargin = '10';
        
        for (let pageNum = 1; pageNum <= totalOutputPages; pageNum++) {
            const startIdx = (pageNum - 1) * outputPerPage;
            const endIdx = Math.min(startIdx + outputPerPage, selected.length);
            const pageQuestions = selected.slice(startIdx, endIdx);
            
            // Page header content - ONLY FOR FIRST PAGE
            let pageHeader = '';
            if (pageNum === 1) {
                pageHeader = `
                <div id="outSetLine"></div>
                <div class="header"><h1 id="outH1"></h1><h2 id="outH2"></h2></div>
                <div id="outClassLine" class="header-info"></div>
                <div id="outSubjectLine" class="header-info" style="margin-bottom:8px;"></div>
                <div class="marks-info"><span id="outTime"></span><span id="outMarks"></span></div>
                <div id="outInst" class="instruction"></div>`;
            }
            
            // ‚úÖ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®: ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶™‡¶æ‡¶§‡¶æ ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶°‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá, ‡ß®‡ßü ‡¶™‡¶æ‡¶§‡¶æ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡ßß‡ß¶mm
            const pagePadding = pageNum === 1 
                ? `${topMargin}mm ${rightMargin}mm ${bottomMargin}mm ${leftMargin}mm`  // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶™‡¶æ‡¶§‡¶æ
                : `${secondPageTopMargin}mm ${rightMargin}mm ${bottomMargin}mm ${leftMargin}mm`; // ‡ß®‡ßü, ‡ß©‡ßü, ... ‡¶™‡¶æ‡¶§‡¶æ
            
            let pageContent = pageQuestions.map((q, i) => {
                const num = formatNum(startIdx + i + 1);
                const img = q.img ? `<img src="${q.img}" style="max-width:100%; display:block; margin:5px auto; max-height: 100px;">` : '';
                const isEnglish = q.sub.toLowerCase().includes("english") || q.sub.includes("‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø");
                const labels = isEnglish ? ["a", "b", "c", "d"] : ["‡¶ï", "‡¶ñ", "‡¶ó", "‡¶ò"];
                
                // ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶•‡ßá‡¶ï‡ßá <b>, <strong> ‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó ‡¶∏‡¶∞‡¶ø‡ßü‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®
                let cleanBody = q.body;
                cleanBody = cleanBody.replace(/<b>/gi, '').replace(/<\/b>/gi, '');
                cleanBody = cleanBody.replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                
                const formattedBody = processMathInText(cleanBody);

                let opt = "";
                if (q.type !== 'normal' && q.showOptions !== false) {
                    if (q.type === 'cq') {
                        // ‡¶Ö‡¶™‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶¨‡ßã‡¶≤‡ßç‡¶° ‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó‡¶ì ‡¶∏‡¶∞‡¶ø‡ßü‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®
                        const cleanA = (q.a || '').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                        const cleanB = (q.b || '').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                        const cleanC = (q.c || '').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                        const cleanD = (q.d || '').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                        
                        const options = [
                            { label: labels[0], value: cleanA || '', mark: '‡ßß' },
                            { label: labels[1], value: cleanB || '', mark: '‡ß®' },
                            { label: labels[2], value: cleanC || '', mark: '‡ß©' },
                            { label: labels[3], value: cleanD || '', mark: '‡ß™' }
                        ];
                        
                        opt = `
                        <div style="margin-top:4px; margin-left: 18px; font-size: ${currentFontSize}px !important; line-height: ${currentLineHeight} !important;">
                            ${options.map(opt => `
                                <div class="sub-q" style="font-size: ${currentFontSize}px !important; line-height: ${currentLineHeight} !important; margin-bottom: 8px; display: flex; align-items: flex-start; justify-content: space-between;">
                                    <div style="display: flex; align-items: flex-start; flex: 1;">
                                        <span style="margin-right: 5px; flex-shrink: 0;">${opt.label}.</span>
                                        <div style="flex: 1; text-align: left;">${processMathInText(opt.value)}</div>
                                    </div>
                                    <span style="margin-left: 10px; flex-shrink: 0;">${opt.mark}</span>
                                </div>
                            `).join('')}
                        </div>`;
                    } else {
                        // MCQ ‡¶Ö‡¶™‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶¨‡ßã‡¶≤‡ßç‡¶° ‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó‡¶ì ‡¶∏‡¶∞‡¶ø‡ßü‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®
                        const cleanA = (q.a || '').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                        const cleanB = (q.b || '').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                        const cleanC = (q.c || '').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                        const cleanD = (q.d || '').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
                        
                        const options = [
                            { label: labels[0], value: cleanA || '' },
                            { label: labels[1], value: cleanB || '' },
                            { label: labels[2], value: cleanC || '' },
                            { label: labels[3], value: cleanD || '' }
                        ];
                        
                        opt = `
                        <div class="mcq-grid" style="font-size: ${currentFontSize}px !important; line-height: ${currentLineHeight} !important; margin-top: 8px;">
                            ${options.map(opt => `
                                <div style="display: flex; align-items: flex-start; text-align: left; margin-bottom: 4px;">
                                    <span style="margin-right: 5px; flex-shrink: 0;">${opt.label}.</span>
                                    <div style="flex: 1;">${processMathInText(opt.value)}</div>
                                </div>
                            `).join('')}
                        </div>`;
                    }
                }
                
                return `
                <div class="${q.type==='cq'?'cq-box':'normal-q'}" style="font-size: ${currentFontSize}px !important; line-height: ${currentLineHeight} !important; margin-bottom: ${document.getElementById('qGapSlider').value}px !important;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div style="display:flex; gap:4px; width: 100%;"><span style="font-size: ${currentFontSize}px !important; flex-shrink: 0;">${num}.</span> <div style="font-size: ${currentFontSize}px !important; flex: 1; text-align: left;">${formattedBody}</div></div>
                    </div>
                    ${img}${opt}
                </div>`;
            }).join('');
            
            // Page footer with page number
            let pageFooter = '';
            if (showPageNumbers) {
                pageFooter = `<div class="page-number" style="font-size: 12px !important;">‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ${pageNum}/${totalOutputPages}</div>`;
            }
            
            pagesHTML += `
            <div id="output-page-${pageNum}" class="output-page ${pageNum === outputCurrentPage ? 'active' : ''}" 
                 style="font-size: ${currentFontSize}px !important; padding: ${pagePadding} !important;">
                ${pageHeader}
                <div class="question-container" style="
                    column-count: ${document.getElementById('colCount').value}; 
                    font-size: ${currentFontSize}px !important; 
                    line-height: ${currentLineHeight} !important; 
                    column-gap: 35px;
                    margin-top: ${pageNum === 1 ? '15px' : '0'};
                ">
                    ${pageContent}
                </div>
                ${pageFooter}
                ${pageNum < totalOutputPages ? '<div class="print-page-break" style="font-size: 12px !important;">--- ‡¶™‡ßá‡¶ú ‡¶¨‡ßç‡¶∞‡ßá‡¶ï ---</div>' : ''}
            </div>`;
        }
        
        document.getElementById('outputPagesContainer').innerHTML = pagesHTML;
        
        // Update answer grid (‡¶è‡¶ñ‡¶æ‡¶®‡ßá‡¶ì ‡¶¨‡ßã‡¶≤‡ßç‡¶° ‡¶∏‡¶∞‡¶ø‡ßü‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®)
        document.getElementById('ansGrid').innerHTML = selected.map((q, i) => {
            const cleanAns = (q.ans || '...').replace(/<b>/gi, '').replace(/<\/b>/gi, '').replace(/<strong>/gi, '').replace(/<\/strong>/gi, '');
            return `<div class="ans-box" style="font-size: ${currentFontSize}px !important; line-height: ${currentLineHeight} !important; text-align: center;"><span>${formatNum(i+1)}.</span> ${cleanAns}</div>`;
        }).join('');
        
        // Update main header elements for first page
        updateHeaders();
        
        updateOutputPagination();
        
        // Render MathJax after content is loaded
        setTimeout(renderMathJax, 200);
    }

    function updateHeaders() {
        document.getElementById('outH1').innerText = document.getElementById('h1').value;
        document.getElementById('outH2').innerText = document.getElementById('h2').value;
        document.getElementById('outClassLine').innerText = document.getElementById('hClass').value ? "‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø: " + document.getElementById('hClass').value : "";
        document.getElementById('outSubjectLine').innerText = document.getElementById('h3').value ? "‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º: " + document.getElementById('h3').value : "";
        document.getElementById('outTime').innerText = document.getElementById('hTime').value ? "‡¶∏‡¶Æ‡¶Ø‡¶º: " + document.getElementById('hTime').value : "";
        document.getElementById('outMarks').innerText = document.getElementById('hMarks').value ? "‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶Æ‡¶æ‡¶®: " + document.getElementById('hMarks').value : "";
        document.getElementById('outInst').innerText = document.getElementById('hInst').value;
        const setVal = document.getElementById('hSet').value, outSet = document.getElementById('outSetLine');
        if(setVal) { outSet.innerText = "‡¶∏‡ßá‡¶ü: " + setVal; outSet.style.display = "block"; } else { outSet.style.display = "none"; }
        document.getElementById('outH1').style.fontSize = document.getElementById('fsH1').value + "px";
        document.getElementById('outH2').style.fontSize = document.getElementById('fsH2').value + "px";
        document.getElementById('outClassLine').style.fontSize = document.getElementById('fsH3').value + "px";
        document.getElementById('outSubjectLine').style.fontSize = document.getElementById('fsH3').value + "px";
        document.getElementById('outInst').style.fontSize = document.getElementById('fsH4').value + "px";
    }

    function updateSliderValue(sliderId, value) {
        const valueElement = document.getElementById(sliderId + 'Value');
        if (valueElement) {
            valueElement.textContent = value;
        }
    }

    function updateOutputPagination() {
        const selected = questionBank.filter(q => q.selected).length;
        totalOutputPages = Math.max(1, totalOutputPages);
        
        document.getElementById('outputPageInfo').innerText = `‡¶™‡ßá‡¶ú ${outputCurrentPage}/${totalOutputPages}`;
        document.getElementById('totalOutputPagesDisplay').innerText = totalOutputPages;
        document.getElementById('jumpToOutputPage').value = outputCurrentPage;
        document.getElementById('jumpToOutputPage').max = totalOutputPages;
        
        document.getElementById('outputPrevBtn').disabled = outputCurrentPage === 1;
        document.getElementById('outputNextBtn').disabled = outputCurrentPage === totalOutputPages;
        
        toggleOutputPagination();
    }

    function changeOutputPage(delta) {
        const newPage = outputCurrentPage + delta;
        if (newPage < 1 || newPage > totalOutputPages) return;
        
        document.querySelectorAll('.output-page').forEach(page => {
            page.classList.remove('active');
        });
        
        outputCurrentPage = newPage;
        document.getElementById(`output-page-${outputCurrentPage}`).classList.add('active');
        
        updateOutputPagination();
        document.querySelector('.preview-area').scrollTop = 0;
    }

    function jumpToOutputPage() {
        const pageInput = document.getElementById('jumpToOutputPage');
        let pageNum = parseInt(pageInput.value);
        
        if (isNaN(pageNum) || pageNum < 1) pageNum = 1;
        if (pageNum > totalOutputPages) pageNum = totalOutputPages;
        
        document.querySelectorAll('.output-page').forEach(page => {
            page.classList.remove('active');
        });
        
        outputCurrentPage = pageNum;
        document.getElementById(`output-page-${outputCurrentPage}`).classList.add('active');
        
        updateOutputPagination();
        document.querySelector('.preview-area').scrollTop = 0;
    }

    function toggleOutputPagination() {
        const showPagination = document.getElementById('showOutputPagination').checked;
        const selected = questionBank.filter(q => q.selected).length;
        
        if (showPagination && totalOutputPages > 1) {
            document.getElementById('outputPagination').style.display = 'flex';
        } else {
            document.getElementById('outputPagination').style.display = 'none';
        }
    }

    // ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® addQuestion ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (‡¶è‡¶°‡¶ø‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
    function addQuestion() {
        const editIdx = parseInt(document.getElementById('editIndex').value);
        const q = getQuestionFromForm();
        
        if(editIdx > -1) { 
            q.selected = questionBank[editIdx].selected;
            questionBank[editIdx] = q; 
            cancelEdit(); 
        }
        
        saveData(); 
        updateSubFilter(); 
        updateChapterFilter(); 
        updateQuestionCount();
        selectionCurrentPage = 1;
        renderSelectionList(); 
        alert("‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
    }

    function editQuestion(idx, e) {
        e.stopPropagation();
        const q = questionBank[idx];
        document.getElementById('editIndex').value = idx;
        document.getElementById('qSub').value = q.sub;
        document.getElementById('qClassInput').value = q.qClass || "";
        document.getElementById('qDivInput').value = q.qDiv || "";
        document.getElementById('qChap').value = q.chap || "";
        document.getElementById('qType').value = q.type;
        document.getElementById('qBody').value = q.body;
        document.getElementById('qA').value = q.a || "";
        document.getElementById('qB').value = q.b || "";
        document.getElementById('qC').value = q.c || "";
        document.getElementById('qD').value = q.d || "";
        document.getElementById('qAns').value = q.ans || "";
        document.getElementById('qBoard').value = q.board || "";
        document.getElementById('showOptionsToggle').checked = q.showOptions !== false;
        currentImgData = q.img || "";
        document.getElementById('imgPreview').innerHTML = currentImgData ? `<img src="${currentImgData}" style="width:100px;">` : "";
        
        toggleFields();
        document.getElementById('saveBtn').innerText = "‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®";
        document.getElementById('cancelBtn').style.display = "block";
        openTab('bank');
    }

    function deleteQuestion(idx, e) {
        e.stopPropagation();
        if(confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            questionBank.splice(idx, 1);
            saveData(); 
            updateSubFilter(); 
            updateChapterFilter(); 
            updateQuestionCount();
            selectionCurrentPage = 1;
            renderSelectionList();
        }
    }

    function cancelEdit() {
        document.getElementById('editIndex').value = "-1";
        document.getElementById('saveBtn').innerText = "‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®";
        document.getElementById('cancelBtn').style.display = "none";
        document.querySelectorAll('#bank input, #bank textarea, #bank select').forEach(i => i.value = "");
        document.getElementById('imgPreview').innerHTML = "";
        currentImgData = "";
        document.getElementById('duplicateStatus').style.display = 'none';
        document.getElementById('saveBtn').style.background = 'var(--primary)';
    }

    function sync() {
        document.getElementById('ansSheetArea').style.display = document.getElementById('showAnsKey').checked ? "block" : "none";
        
        // ‚úÖ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        setTimeout(() => {
            renderOutputPages();
        }, 100);
        saveData();
    }

    function updateSubFilter() {
        const fSub = document.getElementById('fSub');
        const lockText = document.getElementById('lockBox').value.trim();
        const isAdmin = document.getElementById('adminToggle').checked;
        let subs = [...new Set(questionBank.map(q => q.sub))];
        if (lockText !== "" && !isAdmin) {
            let allowed = lockText.split(',').map(s => s.trim().toLowerCase());
            subs = subs.filter(s => allowed.includes(s.toLowerCase()));
        }
        fSub.innerHTML = '<option value="">‡¶∏‡¶¨ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º</option>' + subs.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    function updateChapterFilter() {
        const subF = document.getElementById('fSub').value;
        const fChap = document.getElementById('fChap');
        let chapters = [];
        if(subF) {
            chapters = [...new Set(questionBank.filter(q => q.sub === subF).map(q => q.chap))];
        } else {
            chapters = [...new Set(questionBank.map(q => q.chap))];
        }
        fChap.innerHTML = '<option value="">‡¶∏‡¶¨ ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º</option>' + chapters.filter(c => c).map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function toggleAdmin() {
        const cb = document.getElementById('adminToggle');
        if (cb.checked) { 
            if (prompt("‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°:") === "1234") { 
                document.getElementById('sidebarMain').classList.add('admin-active'); 
                document.getElementById('currentModeDisplay').innerText = "‡¶è‡¶°‡¶Æ‡¶ø‡¶®"; 
            } else cb.checked = false; 
        }
        else { 
            document.getElementById('sidebarMain').classList.remove('admin-active'); 
            document.getElementById('currentModeDisplay').innerText = "‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£"; 
        }
        updateSubFilter(); 
        renderSelectionList();
    }

    function saveData() {
        const d = { 
            sets: [document.getElementById('h1').value, document.getElementById('h2').value, document.getElementById('hClass').value, document.getElementById('h3').value, document.getElementById('hTime').value, document.getElementById('hMarks').value, document.getElementById('hInst').value, document.getElementById('targetCount').value, document.getElementById('hSet').value],
            hSizes: [document.getElementById('fsH1').value, document.getElementById('fsH2').value, document.getElementById('fsH3').value, document.getElementById('fsH4').value],
            margins: [document.getElementById('mTop').value, document.getElementById('mBottom').value, document.getElementById('mLeft').value, document.getElementById('mRight').value],
            fSize: document.getElementById('fSize').value, 
            lHeight: document.getElementById('lHeight').value, 
            cols: document.getElementById('colCount').value, 
            lang: document.getElementById('qLang').value, 
            qs: questionBank,
            restrictedList: document.getElementById('lockBox').value,
            selectionPerPage: document.getElementById('selectionPerPage').value,
            outputPerPage: document.getElementById('outputPerPage').value,
            showPageNumbers: document.getElementById('showPageNumbers').checked,
            showOutputPagination: document.getElementById('showOutputPagination').checked,
            qGap: document.getElementById('qGapSlider').value
        };
        localStorage.setItem(DB_KEY, JSON.stringify(d));
    }

    function loadData() {
        const d = JSON.parse(localStorage.getItem(DB_KEY) || '{}');
        if(d.qs) {
            document.getElementById('h1').value = d.sets[0] || "‡¶∂‡ßá‡¶∞‡¶ñ‡¶æ‡¶≤‡ßÄ ‡¶∏‡¶∞‡¶ï‡¶æ‡¶∞‡¶ø ‡¶Æ‡¶π‡¶ø‡¶≤‡¶æ ‡¶ï‡¶≤‡ßá‡¶ú"; 
            document.getElementById('h2').value = d.sets[1] || "‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ-‡ß®‡ß¶‡ß®‡ß¨"; 
            document.getElementById('hClass').value = d.sets[2] || "";
            document.getElementById('h3').value = d.sets[3] || "";
            document.getElementById('targetCount').value = d.sets[7] || 10; 
            document.getElementById('hSet').value = d.sets[8] || "";
            document.getElementById('fsH1').value = d.hSizes[0] || 20;
            document.getElementById('fsH2').value = d.hSizes[1] || 16;
            document.getElementById('fsH3').value = d.hSizes[2] || 13;
            document.getElementById('fsH4').value = d.hSizes[3] || 13;
            document.getElementById('lockBox').value = d.restrictedList || "";
            questionBank = d.qs;
            
            // Load margin values
            if (d.margins && d.margins.length >= 4) {
                document.getElementById('mTop').value = d.margins[0] || '12';
                document.getElementById('mBottom').value = d.margins[1] || '12';
                document.getElementById('mLeft').value = d.margins[2] || '15';
                document.getElementById('mRight').value = d.margins[3] || '15';
            }
            
            if (d.selectionPerPage) {
                document.getElementById('selectionPerPage').value = d.selectionPerPage;
            }
            if (d.outputPerPage) {
                document.getElementById('outputPerPage').value = d.outputPerPage;
            }
            if (d.showPageNumbers !== undefined) {
                document.getElementById('showPageNumbers').checked = d.showPageNumbers;
            }
            if (d.showOutputPagination !== undefined) {
                document.getElementById('showOutputPagination').checked = d.showOutputPagination;
            }
            
            if (d.qGap) {
                document.getElementById('qGapSlider').value = d.qGap;
            }
            
            // Update slider value displays
            updateSliderValue('fsH1', document.getElementById('fsH1').value + 'px');
            updateSliderValue('fsH2', document.getElementById('fsH2').value + 'px');
            updateSliderValue('fsH3', document.getElementById('fsH3').value + 'px');
            updateSliderValue('fsH4', document.getElementById('fsH4').value + 'px');
            updateSliderValue('qGapSlider', document.getElementById('qGapSlider').value + 'px');
            updateSliderValue('fSize', document.getElementById('fSize').value + 'px');
            updateSliderValue('lHeight', document.getElementById('lHeight').value);
            updateSliderValue('mTop', document.getElementById('mTop').value + 'mm');
            updateSliderValue('mBottom', document.getElementById('mBottom').value + 'mm');
            updateSliderValue('mLeft', document.getElementById('mLeft').value + 'mm');
            updateSliderValue('mRight', document.getElementById('mRight').value + 'mm');
        }
        
        updateSubFilter(); 
        updateChapterFilter(); 
        updateQuestionCount();
        sync(); 
        renderSelectionList();
        
        // Show temporary edit button
        addTemporaryEditButton();
    }

    function formatNum(n) { 
        return document.getElementById('qLang').value === 'bn' ? 
            n.toString().split('').map(d => '‡ß¶‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ‡ßØ'[d] || d).join('') : n; 
    }
    
    function openTab(id) { 
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active')); 
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        if(event) event.currentTarget.classList.add('active'); 
    }
    
    function toggleFields() { 
        const type = document.getElementById('qType').value; 
        document.getElementById('extraFields').style.display = (type === 'normal') ? 'none' : 'block'; 
        document.getElementById('showOptionsLabel').style.display = (type === 'normal') ? 'none' : 'flex'; 
    }
    
    function handleImage(e) { 
        const file = e.target.files[0]; 
        if (!file) return; 
        const reader = new FileReader(); 
        reader.onload = function(ev) { 
            document.getElementById('cropImage').src = ev.target.result; 
            document.getElementById('cropperModal').style.display = 'block'; 
            if (cropper) cropper.destroy(); 
            setTimeout(() => { 
                cropper = new Cropper(document.getElementById('cropImage'), { autoCropArea: 1, viewMode: 1 }); 
            }, 100); 
        }; 
        reader.readAsDataURL(file); 
    }
    
    function finishCrop() { 
        currentImgData = cropper.getCroppedCanvas({ maxWidth: 800 }).toDataURL('image/jpeg', 0.7); 
        document.getElementById('imgPreview').innerHTML = `<img src="${currentImgData}" style="width:100px;">`; 
        closeCropper(); 
    }
    
    function closeCropper() { 
        document.getElementById('cropperModal').style.display = 'none'; 
    }
    
    function autoSelectRandom() { 
        let count = parseInt(document.getElementById('randomCount').value);
        if(!count) return;
        let pool = questionBank.filter(q => !q.selected);
        for(let i=0; i<count && pool.length>0; i++){
            let rIdx = Math.floor(Math.random() * pool.length);
            pool[rIdx].selected = true;
            pool.splice(rIdx, 1);
        }
        saveData(); 
        renderSelectionList();
    }
    
    function shuffleSelectedQuestions() {
        let selected = questionBank.filter(q => q.selected);
        let others = questionBank.filter(q => !q.selected);
        for (let i = selected.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [selected[i], selected[j]] = [selected[j], selected[i]];
        }
        questionBank = [...selected, ...others];
        saveData(); 
        renderSelectionList();
    }
    
    function exportJSON() { 
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(new Blob([localStorage.getItem(DB_KEY)], {type: "application/json"})); 
        a.download = "BCTI_Backup.json"; 
        a.click(); 
    }
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
        checkLicense();
    });

// ==================== SMART SEARCH FEATURE ====================

function initializeSmartSearch() {
    // Add search box to selection panel
    const filterGroup = document.getElementById('filterGroup');
    if (filterGroup && !document.getElementById('smartSearchBox')) {
        const searchHTML = `
            <div style="margin-bottom:10px;">
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input type="text" id="smartSearchBox" placeholder="üîç ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®, ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º, ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶¨‡¶æ ‡¶ï‡ßÄ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." 
                           style="flex:1; padding:10px; border:1px solid #ccc; border-radius:5px; font-size:13px;"
                           oninput="performSmartSearch()">
                    <button onclick="clearSmartSearch()" style="background:#f44336; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">‚úñ</button>
                </div>
                <div style="font-size:11px; color:#666; display:flex; justify-content:space-between;">
                    <span>‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö: ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü, ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º, ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º, ‡¶¨‡ßã‡¶∞‡ßç‡¶°, ‡¶ü‡¶æ‡¶á‡¶™</span>
                    <button onclick="showSearchTips()" style="background:none; border:none; color:var(--primary); cursor:pointer; font-size:11px;">‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ü‡¶ø‡¶™‡¶∏</button>
                </div>
            </div>
        `;
        
        filterGroup.insertAdjacentHTML('afterbegin', searchHTML);
        
        // Add search filters
        const searchFiltersHTML = `
            <div id="searchFilters" style="display:none; background:#e3f2fd; padding:10px; border-radius:5px; margin-top:10px; border:1px solid #bbdefb;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <strong style="color:var(--primary); font-size:13px;">üîç ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞</strong>
                    <button onclick="toggleSearchFilters()" style="background:none; border:none; color:#666; cursor:pointer; font-size:12px;">‚ñ≤</button>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div>
                        <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:3px;">‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶´‡¶ø‡¶≤‡ßç‡¶°:</label>
                        <select id="searchField" style="width:100%; padding:5px; border:1px solid #ccc; border-radius:3px; font-size:12px;">
                            <option value="all">‡¶∏‡¶¨ ‡¶´‡¶ø‡¶≤‡ßç‡¶°</option>
                            <option value="body">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü</option>
                            <option value="sub">‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º</option>
                            <option value="chap">‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º</option>
                            <option value="board">‡¶¨‡ßã‡¶∞‡ßç‡¶°/‡¶∏‡¶æ‡¶≤</option>
                            <option value="ans">‡¶â‡¶§‡ßç‡¶§‡¶∞</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:3px;">‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö ‡¶ü‡¶æ‡¶á‡¶™:</label>
                        <select id="matchType" style="width:100%; padding:5px; border:1px solid #ccc; border-radius:3px; font-size:12px;">
                            <option value="contains">‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶Ç‡¶∂‡ßá ‡¶Ü‡¶õ‡ßá</option>
                            <option value="exact">‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶Æ‡¶ø‡¶≤</option>
                            <option value="start">‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá ‡¶Ü‡¶õ‡ßá</option>
                            <option value="end">‡¶∂‡ßá‡¶∑‡ßá ‡¶Ü‡¶õ‡ßá</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top:8px;">
                    <label style="font-size:12px; display:flex; align-items:center; cursor:pointer;">
                        <input type="checkbox" id="caseSensitive" style="margin-right:5px;"> 
                        ‡¶ï‡ßá‡¶∏ ‡¶∏‡ßá‡¶®‡ßç‡¶∏‡¶ø‡¶ü‡¶ø‡¶≠
                    </label>
                    <label style="font-size:12px; display:flex; align-items:center; cursor:pointer;">
                        <input type="checkbox" id="searchSelectedOnly" style="margin-right:5px;"> 
                        ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®
                    </label>
                </div>
                <div style="margin-top:10px; padding-top:10px; border-top:1px solid #bbdefb;">
                    <div style="font-size:11px; color:#666;">
                        <strong>‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶ü‡¶∞:</strong><br>
                        <code>"exact phrase"</code> - ‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶¨‡¶æ‡¶ï‡ßç‡¶Ø<br>
                        <code>‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶® AND ‡¶ó‡¶£‡¶ø‡¶§</code> - ‡¶¶‡ßÅ‡¶ü‡ßã‡¶á ‡¶Ü‡¶õ‡ßá<br>
                        <code>MCQ OR ‡¶∏‡ßÉ‡¶ú‡¶®‡¶∂‡ßÄ‡¶≤</code> - ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã‡¶ü‡¶ø ‡¶Ü‡¶õ‡ßá<br>
                        <code>-‡¶¨‡ßã‡¶∞‡ßç‡¶°</code> - ‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á ‡¶è‡¶Æ‡¶®<br>
                        <code>‡¶™‡ßç‡¶∞‡¶•‡¶Æ*</code> - ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ<br>
                    </div>
                </div>
            </div>
        `;
        
        filterGroup.insertAdjacentHTML('afterbegin', searchFiltersHTML);
        
        // Add toggle button for advanced filters
        const toggleBtn = document.createElement('button');
        toggleBtn.innerHTML = 'üîç ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞';
        toggleBtn.style.cssText = 'width:100%; background:#e3f2fd; color:var(--primary); border:1px solid #bbdefb; padding:8px; border-radius:5px; cursor:pointer; font-size:12px; font-weight:bold; margin-bottom:10px;';
        toggleBtn.onclick = toggleSearchFilters;
        filterGroup.insertAdjacentElement('afterbegin', toggleBtn);
    }
}

function toggleSearchFilters() {
    const filters = document.getElementById('searchFilters');
    const toggleBtn = document.querySelector('[onclick="toggleSearchFilters()"]');
    
    if (filters.style.display === 'none' || filters.style.display === '') {
        filters.style.display = 'block';
        if (toggleBtn) toggleBtn.innerHTML = '‚ñ≤ ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®';
    } else {
        filters.style.display = 'none';
        if (toggleBtn) toggleBtn.innerHTML = 'üîç ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞';
    }
}

function performSmartSearch() {
    const searchTerm = document.getElementById('smartSearchBox').value.trim();
    const searchField = document.getElementById('searchField')?.value || 'all';
    const matchType = document.getElementById('matchType')?.value || 'contains';
    const caseSensitive = document.getElementById('caseSensitive')?.checked || false;
    const searchSelectedOnly = document.getElementById('searchSelectedOnly')?.checked || false;
    
    if (searchTerm === '') {
        clearSearchHighlights();
        renderSelectionList();
        return;
    }
    
    let searchPool = questionBank;
    if (searchSelectedOnly) {
        searchPool = questionBank.filter(q => q.selected);
    }
    
    const searchResults = smartSearchAlgorithm(searchTerm, searchPool, {
        field: searchField,
        matchType: matchType,
        caseSensitive: caseSensitive
    });
    
    highlightSearchResults(searchResults);
    updateSearchStats(searchResults.length, searchPool.length);
}

function smartSearchAlgorithm(searchTerm, pool, options) {
    const results = [];
    const terms = parseSearchQuery(searchTerm);
    
    pool.forEach((q, index) => {
        let matchScore = 0;
        let maxPossibleScore = 0;
        
        // Parse search operators
        if (terms.exact) {
            // Exact phrase search
            const text = getSearchText(q, options.field);
            if (text.includes(terms.exact)) {
                matchScore += 100;
                maxPossibleScore += 100;
            }
        }
        
        if (terms.and.length > 0) {
            // AND operator
            maxPossibleScore += terms.and.length * 50;
            terms.and.forEach(term => {
                if (checkMatch(q, term, options)) {
                    matchScore += 50;
                }
            });
        }
        
        if (terms.or.length > 0) {
            // OR operator
            maxPossibleScore += 30;
            let orMatched = false;
            terms.or.forEach(term => {
                if (checkMatch(q, term, options)) {
                    orMatched = true;
                }
            });
            if (orMatched) {
                matchScore += 30;
            }
        }
        
        if (terms.not.length > 0) {
            // NOT operator
            maxPossibleScore += 20;
            let notMatched = false;
            terms.not.forEach(term => {
                if (checkMatch(q, term, options)) {
                    notMatched = true;
                }
            });
            if (!notMatched) {
                matchScore += 20;
            }
        }
        
        if (terms.wildcard.length > 0) {
            // Wildcard search
            maxPossibleScore += terms.wildcard.length * 40;
            terms.wildcard.forEach(wildcard => {
                if (wildcardMatch(q, wildcard, options)) {
                    matchScore += 40;
                }
            });
        }
        
        // If no operators, do simple search
        if (terms.simple.length > 0 && terms.and.length === 0 && terms.or.length === 0) {
            maxPossibleScore += terms.simple.length * 40;
            terms.simple.forEach(term => {
                if (checkMatch(q, term, options)) {
                    matchScore += 40;
                }
            });
        }
        
        // Calculate relevance percentage
        const relevance = maxPossibleScore > 0 ? (matchScore / maxPossibleScore) * 100 : 0;
        
        if (relevance > 0) {
            results.push({
                index: index,
                question: q,
                relevance: relevance,
                matchFields: findMatchFields(q, terms, options)
            });
        }
    });
    
    // Sort by relevance
    results.sort((a, b) => b.relevance - a.relevance);
    
    return results;
}

function parseSearchQuery(query) {
    const result = {
        exact: null,
        and: [],
        or: [],
        not: [],
        wildcard: [],
        simple: []
    };
    
    // Extract exact phrases (within quotes)
    const exactMatch = query.match(/"([^"]+)"/);
    if (exactMatch) {
        result.exact = exactMatch[1];
        query = query.replace(exactMatch[0], '');
    }
    
    // Split by spaces but keep quoted phrases
    const tokens = query.match(/(?:[^\s"]+|"[^"]*")+/g) || [];
    
    tokens.forEach(token => {
        token = token.replace(/"/g, '').trim();
        if (!token) return;
        
        if (token.toUpperCase() === 'AND') {
            // AND operator
            return;
        } else if (token.toUpperCase() === 'OR') {
            // OR operator
            return;
        } else if (token.startsWith('-')) {
            // NOT operator
            result.not.push(token.substring(1));
        } else if (token.includes('*')) {
            // Wildcard
            result.wildcard.push(token);
        } else if (token.includes('+')) {
            // AND operator alternative
            result.and.push(token.replace('+', ''));
        } else if (token.includes('|')) {
            // OR operator alternative
            result.or.push(token.replace('|', ''));
        } else {
            // Simple term
            result.simple.push(token);
        }
    });
    
    return result;
}

function checkMatch(question, term, options) {
    const text = getSearchText(question, options.field);
    const searchText = options.caseSensitive ? text : text.toLowerCase();
    const searchTerm = options.caseSensitive ? term : term.toLowerCase();
    
    switch (options.matchType) {
        case 'exact':
            return searchText === searchTerm;
        case 'start':
            return searchText.startsWith(searchTerm);
        case 'end':
            return searchText.endsWith(searchTerm);
        case 'contains':
        default:
            return searchText.includes(searchTerm);
    }
}

function getSearchText(question, field) {
    switch (field) {
        case 'body':
            return question.body || '';
        case 'sub':
            return question.sub || '';
        case 'chap':
            return question.chap || '';
        case 'board':
            return question.board || '';
        case 'ans':
            return question.ans || '';
        case 'all':
        default:
            return [
                question.body || '',
                question.sub || '',
                question.chap || '',
                question.board || '',
                question.ans || '',
                question.a || '',
                question.b || '',
                question.c || '',
                question.d || ''
            ].join(' ');
    }
}

function wildcardMatch(question, wildcard, options) {
    const text = getSearchText(question, options.field);
    const searchText = options.caseSensitive ? text : text.toLowerCase();
    const pattern = wildcard.replace(/\*/g, '.*').replace(/\?/g, '.');
    
    try {
        const regex = new RegExp(`^${pattern}$`, options.caseSensitive ? '' : 'i');
        return regex.test(searchText);
    } catch (e) {
        return false;
    }
}

function findMatchFields(question, terms, options) {
    const fields = [];
    const allTerms = [...terms.simple, ...terms.and, ...terms.or].filter(t => !terms.not.includes(t));
    
    if (terms.exact) {
        allTerms.push(terms.exact);
    }
    
    const fieldNames = {
        'body': '‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®',
        'sub': '‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º',
        'chap': '‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º',
        'board': '‡¶¨‡ßã‡¶∞‡ßç‡¶°',
        'ans': '‡¶â‡¶§‡ßç‡¶§‡¶∞',
        'type': '‡¶ß‡¶∞‡¶®'
    };
    
    Object.keys(fieldNames).forEach(field => {
        const fieldText = getSearchText(question, field);
        allTerms.forEach(term => {
            if (fieldText && fieldText.toLowerCase().includes(term.toLowerCase())) {
                if (!fields.includes(fieldNames[field])) {
                    fields.push(fieldNames[field]);
                }
            }
        });
    });
    
    return fields;
}

function highlightSearchResults(results) {
    // Store search results in global variable for highlighting
    window.currentSearchResults = results.map(r => r.index);
    
    // Re-render selection list with highlights
    renderSelectionList();
    
    // Highlight search terms in rendered questions
    setTimeout(() => {
        const searchTerm = document.getElementById('smartSearchBox').value.trim();
        if (searchTerm) {
            highlightTextInElements('.q-card-body', searchTerm);
            highlightTextInElements('.q-card-options', searchTerm);
        }
    }, 100);
}

function highlightTextInElements(selector, searchTerm) {
    const elements = document.querySelectorAll(selector);
    const terms = searchTerm.split(' ').filter(t => t.length > 2);
    
    elements.forEach(element => {
        let html = element.innerHTML;
        terms.forEach(term => {
            if (term.length > 2) {
                const regex = new RegExp(`(${term})`, 'gi');
                html = html.replace(regex, '<mark style="background:#ffeb3b; padding:1px 3px; border-radius:2px;">$1</mark>');
            }
        });
        element.innerHTML = html;
    });
}

function clearSearchHighlights() {
    window.currentSearchResults = null;
    document.querySelectorAll('mark').forEach(mark => {
        const parent = mark.parentNode;
        parent.replaceChild(document.createTextNode(mark.textContent), mark);
        parent.normalize();
    });
}

function clearSmartSearch() {
    document.getElementById('smartSearchBox').value = '';
    clearSearchHighlights();
    renderSelectionList();
    document.getElementById('searchStats').style.display = 'none';
}

function updateSearchStats(found, total) {
    let statsElement = document.getElementById('searchStats');
    if (!statsElement) {
        statsElement = document.createElement('div');
        statsElement.id = 'searchStats';
        statsElement.style.cssText = 'background:#e8f5e9; padding:8px; border-radius:5px; margin-top:10px; border:1px solid #c8e6c9; font-size:12px;';
        document.getElementById('smartSearchBox').parentNode.parentNode.appendChild(statsElement);
    }
    
    if (found === 0) {
        statsElement.innerHTML = `<span style="color:#d32f2f;">‚ùå ‡¶ï‡ßã‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø (${total}‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá‡¶õ‡ßá)</span>`;
    } else {
        statsElement.innerHTML = `<span style="color:#2e7d32;">‚úÖ ${found}‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶õ‡ßá (${total}‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá‡¶õ‡ßá)</span> 
        <button onclick="navigateToFirstResult()" style="margin-left:10px; background:var(--primary); color:white; border:none; padding:3px 8px; border-radius:3px; cursor:pointer; font-size:11px;">üìå ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤‡ßá ‡¶Ø‡¶æ‡¶®</button>`;
    }
    
    statsElement.style.display = 'block';
}

function navigateToFirstResult() {
    if (window.currentSearchResults && window.currentSearchResults.length > 0) {
        // Find which page contains the first result
        const firstIndex = window.currentSearchResults[0];
        const questionsPerPage = selectionPerPage;
        const pageNumber = Math.floor(firstIndex / questionsPerPage) + 1;
        
        selectionCurrentPage = pageNumber;
        renderSelectionList();
        
        // Scroll to the question
        setTimeout(() => {
            const firstCard = document.querySelector('.q-card');
            if (firstCard) {
                firstCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstCard.style.animation = 'highlight 1.5s';
            }
        }, 200);
    }
}

function showSearchTips() {
    alert(`üîç ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ü‡¶ø‡¶™‡¶∏:

1. ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö: "‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º"
2. ‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶¨‡¶æ‡¶ï‡ßç‡¶Ø: "‡¶ï‡ßã‡¶∂ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ú‡¶® ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ"
3. AND ‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶ü‡¶∞: "‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶® AND ‡¶ó‡¶£‡¶ø‡¶§"
4. OR ‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶ü‡¶∞: "MCQ OR ‡¶∏‡ßÉ‡¶ú‡¶®‡¶∂‡ßÄ‡¶≤"
5. NOT ‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶ü‡¶∞: "-‡¶¨‡ßã‡¶∞‡ßç‡¶°"
6. Wildcard: "‡¶™‡ßç‡¶∞‡¶•‡¶Æ*" (‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ)
7. ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö: "‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º:‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®" (‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶∏‡¶õ‡ßá)

‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶∞‡ßã ‡¶Ö‡¶™‡¶∂‡¶® ‡¶™‡¶æ‡¶¨‡ßá‡¶®!`);
}

// Modify renderSelectionList to highlight search results
const originalRenderSelectionList = renderSelectionList;
renderSelectionList = function() {
    originalRenderSelectionList.call(this);
    
    // Highlight search result cards
    if (window.currentSearchResults && window.currentSearchResults.length > 0) {
        const qCards = document.querySelectorAll('.q-card');
        qCards.forEach((card, index) => {
            const qIndex = (selectionCurrentPage - 1) * selectionPerPage + index;
            if (window.currentSearchResults.includes(qIndex)) {
                card.style.border = '2px solid #4caf50';
                card.style.boxShadow = '0 2px 8px rgba(76, 175, 80, 0.3)';
                
                // Add search result badge
                const badge = document.createElement('div');
                badge.innerHTML = 'üîç';
                badge.style.cssText = 'position:absolute; top:-8px; right:-8px; background:#4caf50; color:white; width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px;';
                card.style.position = 'relative';
                card.appendChild(badge);
            }
        });
    }
};

// Initialize smart search when page loads
setTimeout(initializeSmartSearch, 1500);
</script>
</body>
</html>